<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:new URL("http://note.niubishanshan.top").hostname,root:"/",scheme:"Gemini",version:"7.7.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!1,show_result:!1,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{appID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},path:"search.json",motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta name="description" content="前言由于不可描述的原因在年初我加入了一个新团队. 程序猿的快乐莫过于入职开发新项目, 即没有前人代码的束缚的同时又提供了与项目共同进步的契机. 本文作为开发笔记行文方式较为轻松. 旨在记录探索开发中遇到的各种技术问题和解决方案, 同时感谢在此过程中给予帮助的多位同学 ~"><meta property="og:type" content="article"><meta property="og:title" content="AudioContext 使用和优化"><meta property="og:url" content="http://note.niubishanshan.top/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/html5/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/html5/AudioContext%20%E4%BD%BF%E7%94%A8%E5%92%8C%E4%BC%98%E5%8C%96/index.html"><meta property="og:site_name" content="圈圈的笔记"><meta property="og:description" content="前言由于不可描述的原因在年初我加入了一个新团队. 程序猿的快乐莫过于入职开发新项目, 即没有前人代码的束缚的同时又提供了与项目共同进步的契机. 本文作为开发笔记行文方式较为轻松. 旨在记录探索开发中遇到的各种技术问题和解决方案, 同时感谢在此过程中给予帮助的多位同学 ~"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://handle-note-img.niubishanshan.top/2021-11-10-10-16-23.png"><meta property="og:image" content="https://handle-note-img.niubishanshan.top/2021-11-11-11-59-10.png"><meta property="og:image" content="https://handle-note-img.niubishanshan.top/2021-11-10-11-42-53.png"><meta property="og:image" content="https://handle-note-img.niubishanshan.top/2021-11-10-11-48-48.png"><meta property="og:image" content="https://handle-note-img.niubishanshan.top/2021-11-13-17-30-04.png"><meta property="og:image" content="https://handle-note-img.niubishanshan.top/merge-barrage.gif"><meta property="og:image" content="https://handle-note-img.niubishanshan.top/2021-11-13-14-58-59.png"><meta property="og:image" content="https://handle-note-img.niubishanshan.top/2021-11-13-16-11-19.png"><meta property="og:image" content="https://handle-note-img.niubishanshan.top/merge-bg-barrage.gif"><meta property="og:image" content="https://handle-note-img.niubishanshan.top/2021-11-13-14-40-51.png"><meta property="og:image" content="https://handle-note-img.niubishanshan.top/2021-11-13-15-44-15.png"><meta property="og:image" content="https://handle-note-img.niubishanshan.top/2021-11-13-16-04-43.png"><meta property="og:image" content="https://handle-note-img.niubishanshan.top/2021-11-13-16-21-11.png"><meta property="article:published_time" content="2021-12-16T08:25:42.000Z"><meta property="article:modified_time" content="2024-06-27T15:04:43.290Z"><meta property="article:author" content="圈圈的圈"><meta property="article:tag" content="开发笔记"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://handle-note-img.niubishanshan.top/2021-11-10-10-16-23.png"><link rel="canonical" href="http://note.niubishanshan.top/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/html5/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/html5/AudioContext%20%E4%BD%BF%E7%94%A8%E5%92%8C%E4%BC%98%E5%8C%96/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0}</script><title>AudioContext 使用和优化 | 圈圈的笔记</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div> <a target="_blank" rel="noopener" href="https://github.com/luoquanquan" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">圈圈的笔记</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">路漫漫其修远兮, 吾将上下而求索</p></div><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i> 首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i> 归档</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i> 关于</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="site-search"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="搜索..." spellcheck="false" type="text" id="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"></div></div><div class="search-pop-overlay"></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://note.niubishanshan.top/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/html5/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/html5/AudioContext%20%E4%BD%BF%E7%94%A8%E5%92%8C%E4%BC%98%E5%8C%96/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.png"><meta itemprop="name" content="圈圈的圈"><meta itemprop="description" content="技术学习, 读书笔记, 生活感悟 ~"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="圈圈的笔记"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> AudioContext 使用和优化</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2021-12-16 16:25:42" itemprop="dateCreated datePublished" datetime="2021-12-16T16:25:42+08:00">2021-12-16</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2024-06-27 23:04:43" itemprop="dateModified" datetime="2024-06-27T23:04:43+08:00">2024-06-27</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">开发笔记</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/html5/" itemprop="url" rel="index"><span itemprop="name">html5</span></a></span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body" itemprop="articleBody"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>由于不可描述的原因在年初我加入了一个新团队. 程序猿的快乐莫过于入职开发新项目, 即没有<strong>前人代码</strong>的束缚的同时又提供了<strong>与项目共同进步</strong>的契机. 本文作为开发笔记行文方式较为轻松. 旨在记录探索开发中遇到的各种技术问题和解决方案, 同时感谢在此过程中给予帮助的多位同学 ~</p><span id="more"></span><h2 id="需求背景"><a href="#需求背景" class="headerlink" title="需求背景"></a>需求背景</h2><p>作为一款主打语音弹幕的产品我们的特色就是语音弹幕 &amp; 合唱. h5 承担的分享落地页要做的就是完美还原客户端效果的同时能够引起用户对于产品的兴趣进而达到拉新的效果. 因此, 分享页不再是一张切图点哪儿都引导下载的 little case …</p><p>总体来说就是</p><ol><li>背景为原作者唱歌(或导入)的一段视频</li><li>消费用户播放到自己喜欢的段落时可以跟唱弹幕</li><li>弹幕提交后若被原作者 <code>pick</code> 则再次播放作品能够在视频上方展示弹幕动画同时播放弹幕音频</li><li>前端仅需实现播放分享作品时<strong>实时</strong>播放弹幕音频并展示弹幕动画</li></ol><p>需求文档就是这些. 至于实现的细节技术同学研究下吧 ~</p><h2 id="技术调研"><a href="#技术调研" class="headerlink" title="技术调研"></a>技术调研</h2><p>由于消费者提交弹幕和原作者 <code>pick</code> 弹幕的动作均为动态化, 不适合服务器直接把弹幕合入原视频的方案(动态创建视频会浪费大量服务资源). 所以这个功能的主要开发工作就由前端来完成啦 ~</p><p>简单分析需求, 落地到前端其实就两个重点:</p><ol><li>播放一个背景视频 - video</li><li>播放一堆音频弹幕 - audio</li><li>弹幕划过动画 - css3</li></ol><p>万事俱备, 开始采坑 ~</p><h2 id="采坑之旅"><a href="#采坑之旅" class="headerlink" title="采坑之旅"></a>采坑之旅</h2><p>后端返回的数据中包含了每条弹幕相对于当前视频作品的开始时间. 我们只需要自动播放 <code>video</code> 并监听其 <code>timeupdate</code> 事件获取播放时间并以此控制弹幕 <code>子弹元素</code> 在屏幕区域的滑动位置. 同时创建 <code>audio</code> 标签播放弹幕音频看上去似乎非常简单.</p><p><img src="https://handle-note-img.niubishanshan.top/2021-11-10-10-16-23.png" alt="表情包"></p><h3 id="问题一-背景视频无法自动播放"><a href="#问题一-背景视频无法自动播放" class="headerlink" title="问题一: 背景视频无法自动播放"></a>问题一: 背景视频无法自动播放</h3><p>按照最初的构想, 只要获取 <code>video</code> 标签并执行 <code>video.play()</code> 启动背景视频的播放. 可是控制台红艳艳的报错出乎意料 emmmm ~</p><p><img src="https://handle-note-img.niubishanshan.top/2021-11-11-11-59-10.png" alt="报错"></p><p>为了能 hack 视频的自动播放, 经过一番搜索和测试. 我发现以下方案均不好用:</p><ol><li>通过 js 调用play()</li><li>设置 video 属性 autoplay</li><li>通过 js 来触发click事件</li><li>使用插件 videojs</li><li>通过 js 调用load()然后再调用play();</li><li>设置 video 属性 webkit-playsinline&#x3D;”true”</li><li>touchstart 监听</li><li>stalled 事件处理</li><li>canplaythrogh 事件处理</li><li>readyState 大于 2 的处理</li><li>DOMContentLoaded 监听</li></ol><p>好在搜索的过程中发现了 <a target="_blank" rel="noopener" href="https://developer.chrome.com/blog/autoplay/#webaudio">Autoplay policy in Chrome</a>. 文档中指明自从 <code>Chrome 66</code> 以来谷歌浏览器便对自动播放的音频和视频进行了限制. 没有用户的交互就想实现视频自动播放怕是实现不了, 只好找产品经理把体验降级为用户点击全局蒙层再启动视频播放. 问题搞定 ~</p> <img width="240" src="https://handle-note-img.niubishanshan.top/2021-11-10-11-42-53.png"><h3 id="问题二-视频跑到顶层挡住弹幕"><a href="#问题二-视频跑到顶层挡住弹幕" class="headerlink" title="问题二: 视频跑到顶层挡住弹幕"></a>问题二: 视频跑到顶层挡住弹幕</h3><p>搞定了播放的问题开始整弹幕布局, 参照 App 的设计图, 布局方案如下:</p> <img width="240" src="https://handle-note-img.niubishanshan.top/2021-11-10-11-48-48.png"><p>弹幕区域置于视频区域上方(z-index)布局完美, 可惜用户点击播放后视频直接起飞. 具体表现为:</p><ul><li>iOS: 调用系统播放器脱离网页播放</li><li>安卓: 视频在网页内, 但是层级上升为最高, 盖住了弹幕区域</li></ul><p><img src="https://handle-note-img.niubishanshan.top/2021-11-13-17-30-04.png" alt="表情包"></p><p>好在有前人写下了<a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000009395289">这篇文章</a>. 加上三个属性终于把视频结结实实固定在网页上了.</p><table><thead><tr><th>属性</th><th>作用</th></tr></thead><tbody><tr><td>playsinline</td><td>iOS 中支持 h5 页内播放(适用于 微信 QQ QQ浏览器 Safari浏览器)</td></tr><tr><td>webkit-playsinline</td><td>同👆🏻, 兼容 iOS 10 添加浏览器前缀</td></tr><tr><td>x5-video-player-type&#x3D;”h5”</td><td>安卓 x5 内核启动 h5 业内播放 video(适用于 微信 QQ QQ浏览器)</td></tr></tbody></table><p>如果想要强力控制还可以使用<a target="_blank" rel="noopener" href="https://github.com/fregante/iphone-inline-video">这个库</a>.</p><p>由于安卓还不支持 <code>playsinline</code>, 所以安卓系统下目前只有腾讯系 <code>x5</code> 内核 webview 可以实现 <code>video</code> 标签的页内播放. 其他浏览器目前没有找到相应的解决方案. 如果有大佬知道的话还请赐教 ~</p><h3 id="问题三-iOS-系统弹幕没有声音"><a href="#问题三-iOS-系统弹幕没有声音" class="headerlink" title="问题三: iOS 系统弹幕没有声音"></a>问题三: iOS 系统弹幕没有声音</h3><p>搞定了视频播放, 实现了弹幕展示, 终于可以开始整弹幕音频播放了. 理论上还是非常简单: 监听 <code>video</code> 标签 <code>timeupdate</code> 事件获取底版视频的播放时间. 遍历弹幕找到当前需要播放的弹幕后创建 <code>audio</code> 标签并播放. 然而事与愿违, 安卓设备自动播放弹幕没有问题, 但是到了 iOS 上直接 GG. <code>audio</code> 没有成功播放出来 😭, <code>vConsole</code> 捕捉到的报错:</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;NotAllowedError&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;The request is not allowed by the user agent or the platform in the current context, possibly because the user denied permission.&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;stack&quot;</span><span class="punctuation">:</span> <span class="string">&quot;play@[native code]\nglobal code&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><p>很明显, 动态创建的 <code>audio</code> 标签也不能自动播放. 动辄上百的弹幕引导用户疯狂的点击? 我没去找产品, 因为这个事儿他应该不会妥协 😭…</p><p>面对问题时, 还是习惯性百度了一下看看有没有前人已经遇到过. 这样往往会事半功倍: 如果有, 那就躺在巨人的肩膀上继续牛逼着. 如果没有, 那么这就是一个机会. 经过一通搜索了解到 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/AudioContext">AudioContext</a>. 这个 <code>Api</code> 可以把音频文件处理成 <code>audioBuffer</code>, 事情开始有了眉目.</p><p>如果把所有的弹幕都转成 <code>audioBuffer</code> 然后再用 <a target="_blank" rel="noopener" href="https://github.com/audiojs/audio-buffer-utils">audio-buffer-utils</a> 往一块拧巴拧巴. 一百多个弹幕就会变成一个音频文件, 播放的问题迎刃而解 🤔</p><p>具体操作步骤如下:</p><ol><li>首先创建一个和作品时长相等的 <code>audioBuffer</code> 作为容器</li><li>逐个下载所有弹幕转 <code>audioBuffer</code> 并 <code>merge</code> 到上述容器中</li><li>用户点击播放键同时播放视频和装满弹幕的容器实现一个点击事件同时播放视频和音频</li></ol><p>合并音频的原理如下图:<br><img src="https://handle-note-img.niubishanshan.top/merge-barrage.gif"></p><p>audioBuffer 播放的最简伪代码如下:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// bgBuffer 就是我们创建的盛放弹幕音频 buffer 的容器</span></span><br><span class="line"><span class="keyword">const</span> bgBuffer = <span class="number">1</span></span><br><span class="line"><span class="keyword">const</span> sourceNode = audioCtx.<span class="title function_">createBufferSource</span>();</span><br><span class="line">sourceNode.<span class="property">buffer</span> = bgBuffer;</span><br><span class="line">sourceNode.<span class="title function_">connect</span>(audioCtx.<span class="property">destination</span>);</span><br><span class="line">sourceNode.<span class="title function_">start</span>(<span class="number">0</span>);</span><br></pre></td></tr></table></figure><p>PS: 如果把一个音频链接添加到 <code>audio</code> 标签直接播放的话可以正常播放. 但是如果想要获取音频中的数据转 <code>audioBuffer</code> 时就会触发浏览器的<a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%90%8C%E6%BA%90%E7%AD%96%E7%95%A5/3927875">同源策略</a>说白了就是跨域了. 对于这个老生常谈的问题直接找cdn老铁加个<a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903733487206413">CORS 跨域</a>域名白名单即可.</p><h3 id="问题四-弹幕数量增多后-移动端报错"><a href="#问题四-弹幕数量增多后-移动端报错" class="headerlink" title="问题四: 弹幕数量增多后, 移动端报错"></a>问题四: 弹幕数量增多后, 移动端报错</h3><p>解决了跨域问题后成功将所有弹幕音频文件合并成一个 <code>audioBuffer</code> 实例. 依托于之前的全局蒙层点击事件启动播放解决了播放的弹幕播放的问题. 使用我自己那仅有 3 条弹幕的作品测试页没有任何问题. 万事俱备只差测试, 一只脚已经站在了成功的门槛上了 ✌🏻</p><p>原本以为提测就是走个过场, 没想到这测试老哥还真是有货. 提测没十分钟 <code>bug</code> 就来了:</p><p><strong>冷门作品弹幕可以正常播放, 但是热门作品弹幕没有声音</strong></p><p>WTF 还有这么抽象的问题😭, 毕竟哥还没有转正这不是吓唬哥嘛. 拿来一个<strong>热门</strong>视频感受了一把. 还真没有声音 😓.</p><p><code>vConsole</code> 打开调试一看, 又是明晃晃的报错.</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Failed to construct &#x27;AudioContext&#x27;: The number of hardware contexts provided (6) is greater than or equal to the maximum bound (6)</span><br></pre></td></tr></table></figure><p>这是明摆着, 浏览器限制了每个页面只能创建 6 个 <code>AudioContext</code> 实例, 超过以后再次创建便会直接报错. 理论依据在<a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/AudioContext/AudioContext#google_chrome">这里</a>, 但是我总不能限制作品的弹幕不能超过 6 个呀…</p><p>好在我们项目中用到了<a target="_blank" rel="noopener" href="https://github.com/audiojs/audio-buffer-utils">audio-buffer-utils</a>库, 既然是专业处理 <code>audio-buffer</code> 的库说不定有啥骚操作. 迫不及待打开<a target="_blank" rel="noopener" href="https://github.com/audiojs/audio-buffer-utils">github</a>项目主文件, 分分钟定位到 <code>AudioContext</code> 定义的部分, 原来可以创建一个实例挂在命名空间下供所有的业务功能使用, 再次感到智商被秀到…</p><p><img src="https://handle-note-img.niubishanshan.top/2021-11-13-14-58-59.png" alt="audio-buffer-utils 处理方案"></p><p><code>AudioContext</code> 实例只需要创建一次后续复用即可. 那么问题就变得简单起来, 用一个实例处理所有弹幕替换之前的每条弹幕都创建一次实例, 问题解决 ~</p><p>PS: 这里有一个隐藏的坑. 通过 <code>ajax</code> 下载音频弹幕文件会占用内存, <code>AudioContext.prototype.decodeAudioData</code> 处理音频文件也会占用内存. 因此每个弹幕的处理都会占用自身大小的两倍的内存. 如果异步下载并处理就可能会导致页面 <code>OOM</code> 只能同步线性处理. 即下载一条弹幕并处理完成在下载下一个…</p><p>PS2: 还有可能会出现同一条弹幕线下正常播放但是上线后不行了. 这个是因为跨域请求 cdn 资源时 cdn 节点会缓存 <code>origin</code> 作为 <code>Access-Control-Allow-Origin</code> 的响应头字段. 这样的话如果线下已经请求过该资源, 上线后访问相同内容时会直接返回了缓存的本地地址作为响应头. 浏览器判断为不允许跨域了具体过程如下:</p><p><img src="https://handle-note-img.niubishanshan.top/2021-11-13-16-11-19.png" alt="2021-11-13-16-11-19"></p><p>解决方案为线下环境调试时在音频链接后加一个固定参数作为标记. 实际上 cdn 会认为两次请求的不是相同的内容:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 音频 cdn</span></span><br><span class="line">http://example.com/audio.m4a</span><br><span class="line"><span class="comment"># 线上直接访问</span></span><br><span class="line">http://example.com/audio.m4a</span><br><span class="line"><span class="comment"># 线下添加一个 _=local</span></span><br><span class="line">http://example.com/audio.m4a?_=<span class="built_in">local</span></span><br></pre></td></tr></table></figure><h3 id="问题五-弹幕-x2F-底版无法对齐"><a href="#问题五-弹幕-x2F-底版无法对齐" class="headerlink" title="问题五: 弹幕 &#x2F; 底版无法对齐"></a>问题五: 弹幕 &#x2F; 底版无法对齐</h3><p>当我搞定了测试和设计, 终于长舒了一口气. 这下子哥转正应该没啥问题了吧. 当然能看到这里的老铁都知道这里肯定会有转折.</p><p>产品经理: 圈圈, 这个弹幕声音和底版似乎没有对齐呀. 你看这句至少差了 40ms…</p><p>此时我内心是想忽悠他一下的. 在我们 js 世界里 16ms 的误差都没法记录, 这个小间隔用户听不出来的(我是真的听不出来)</p><p>组里老鸟伟哥: 还是研究研究吧, 你忽悠不了他的. 他之前是专门搞音乐的, 能听出来…</p><p>我哐哧哐哧又改了一通</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 伪代码</span></span><br><span class="line"><span class="keyword">const</span> playBtn = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&#x27;btn-id&#x27;</span>);</span><br><span class="line">playBtn.<span class="property">onClick</span> = <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    videoEle.<span class="title function_">play</span>(); audioContext.<span class="title function_">play</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>哼哼哼, 甚至把两个播放写到了一行. 产品经理你等着夸我吧 😏.</p><p>后来的事情就是我开始了各种探索, 启动播放音频从延迟 10ms, 20ms, 30ms… 直到 100ms 全都不好使. 分析原因发现:</p><ul><li>启动视频播放和创建 <code>AudioContext</code> 都需要时间</li><li>不同的硬件设备(手机)所需的时间不同</li><li>结论是硬件问题无法解决</li></ul><p>正当我嘀咕着组织语言想找领导陈述一下这件事情的不可行性的时候, 隔壁工位的后端老鸟猛哥给听到了. 他说: 想当年我做爬虫的时候, 发现有些视频网站的音频部分和视频部分是两个链接. 必须把两个链接都爬下来才行…</p><p>Duang ~, 一言惊醒梦中人如果我们也把背景视频内的音频轨剥离出来合并到『iOS 系统弹幕没有声音』步骤中创建的 <code>audioBuffer</code> 中然后在把各种弹幕按照其出现的时间从<strong>物理</strong>上实现对齐. 简直完美 ~</p> <img src="https://handle-note-img.niubishanshan.top/merge-bg-barrage.gif"><h3 id="问题六-loading-时间过长-用户等待时间久"><a href="#问题六-loading-时间过长-用户等待时间久" class="headerlink" title="问题六: loading 时间过长, 用户等待时间久"></a>问题六: loading 时间过长, 用户等待时间久</h3><p>经过了旷日持久的捯饬功能终于是达标了, 弹幕动画正常展示音频也是完美对齐. 但是被我忽略的问题是所有弹幕下载的环节前置以后带来了 <code>loading</code> 时间非常长. 从首帧渲染到播放按钮可点击等待时长达到了 8 秒. 测试说忍不了, 我说我也忍不了 😭. 难道刚刚探索的完美解决方案又要被推翻嘛…</p><p>经历了百度谷歌一把梭以后, 我决定找大佬聊聊继续优化的<em>不可行性</em>以及需求些指点. 在说明了来意当前的实现方案后领导直接反问: 你这个能不能像播放视频一样流式处理呢. 就是用户边播边下载边处理?</p><p>经过这波提醒我再次恍然大悟, <code>AudioBuffer</code> 继承自 <code>Object</code> 那肯定也是引用类型的数据. 这样我可以先外漏播放的按钮允许播放. 同时异步下载弹幕 <code>merge</code> 进来. 这样优化后用户等待时间从 8 秒压缩到了 2 秒.</p><h3 id="问题七-音画无法对齐"><a href="#问题七-音画无法对齐" class="headerlink" title="问题七: 音画无法对齐"></a>问题七: 音画无法对齐</h3><p>到目前为止这个体验真是自己看了都舒服, 自信满满的分享链接到群里诚邀体验静待: 前端, 牛逼了…</p><p>然而等到的是: 你看这个声音唱了好几句了视频画面还没有开口. 音画不同步了…</p><p>经排查发现, 移动端为了节约流量不会预加载视频资源(及时设置了 preload 属性)只有用户点击了播放之后视频才会开始加载. 然而提取的音频都是内存里现成的资源触发播放就会跑起来. 好在根据『背景视频无法自动播放』步骤中得知, 静音的视频可以启动自动播放. 于是只需要页面加载后自动播放视频一帧即可:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 伪代码, 这里需要注意 video 的 play 方法是异步的.</span></span><br><span class="line"><span class="comment">// 只有当返回的 Promise 有了结果 (成功 or 失败) 才能继续</span></span><br><span class="line"><span class="keyword">const</span> videoEle = docuement.<span class="title function_">getElementById</span>(<span class="string">&#x27;video&#x27;</span>)</span><br><span class="line">videoEle.<span class="title function_">setAttribute</span>(<span class="string">&#x27;mute&#x27;</span>, <span class="string">&#x27;mute&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> playPromise = videoEle.<span class="title function_">play</span>()</span><br><span class="line"><span class="keyword">const</span> <span class="title function_">pauseVideo</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    videoEle.<span class="title function_">pase</span>()</span><br><span class="line">&#125;</span><br><span class="line">playPromise.<span class="title function_">then</span>(pauseVideo).<span class="title function_">catch</span>(pauseVideo)</span><br></pre></td></tr></table></figure><p>这样就能实现视频首播一帧待用户点击播放时已经加载可立即播放音视频自然对齐</p><h3 id="问题八-数据结构真的有用"><a href="#问题八-数据结构真的有用" class="headerlink" title="问题八: 数据结构真的有用"></a>问题八: 数据结构真的有用</h3><blockquote><p>在相当长一段时间, 我对于无脑刷 <code>LeetCode</code> 的前端是非常不屑的. 因为真的不怎么用得到, 可惜浅薄的认识让我体验了一把古今真理: 书到用时方恨少…</p></blockquote><p>事情是这样的, 由于弹幕音频和底版音频合并后同时播放. 当同一个时刻出现多条弹幕重叠的时候底版音频就会被覆盖直至被淹没. 好在客户端已经踩过这个坑, 解决方案为: 播放时候判断当前时间内有几条弹幕, 根据弹幕数设置弹幕的音量依次递减. 如下:</p><table><thead><tr><th>弹幕数</th><th>音量系数</th></tr></thead><tbody><tr><td>1</td><td>1</td></tr><tr><td>2</td><td>0.8</td></tr><tr><td>3</td><td>0.6</td></tr><tr><td>4</td><td>0.5</td></tr></tbody></table><p>具体的操作方案为:</p><ol><li>把当前作品时长对应的时间轴以 <code>50ms</code> 每份平均分成若干小份</li><li>依次判断每个小份上边同时出现的弹幕数量, 并依据以上表格设置当前区间声音系数</li></ol><p>逻辑模型如图:<br><img src="https://handle-note-img.niubishanshan.top/2021-11-13-14-40-51.png" alt="2021-11-13-14-40-51"></p><p>图中 ABCD… 小格子为时间区间. 上方的小数为当前区间的音量系数, 下方的弹幕区域为可能出现的弹幕模型. 例如格子 A 时间段内有一个弹幕, 所以混音音量系数为 1. 同理, 格子 B 音量系数为 0.8 以此类推…</p><p>按照这个逻辑可以编辑伪代码如下:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 首先, 构造一个音频字典</span></span><br><span class="line"><span class="keyword">const</span> volumeArr = [</span><br><span class="line">    [<span class="number">0</span>, <span class="number">50</span>, <span class="number">1</span>],</span><br><span class="line">    [<span class="number">51</span>, <span class="number">100</span>, <span class="number">0.8</span>],</span><br><span class="line">    <span class="comment">// 以此类推</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">// 混合音频时根据弹幕出现的时间查出其音量系数</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">findVolume</span> = (<span class="params">barrage, volumeArr</span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123;start, end&#125; = barrage;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> idx = <span class="number">0</span>, len = volumeArr.<span class="property">length</span>; idx &lt; len; idx++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="comment">/* 当前弹幕命中了时间区间 */</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> volumeArr[idx][<span class="number">2</span>]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>一个简单的顺序查找, 逻辑上没啥问题. 部署, 验收, 没啥意外可以下个早班 ~</p><p>事实是再次被打脸, 产品经理说: 加上混音之后第一遍听部分弹幕没有声音, 第二遍正常?</p><p>我: ……, 不应该呀?</p><p>出于对自己和代码的自信, 我想逻辑肯定不会出问题, 代码也绝对没有 bug. 之所以没声音可能是因为流式处理还没有到当前弹幕, 真是不看不知道一看吓一跳.</p><p><img src="https://handle-note-img.niubishanshan.top/2021-11-13-15-44-15.png" alt="狗头保命"></p><p>如图, 最后一列处理时长就是混音的处理时长. 一条弹幕就需要 <code>1s</code> 时间处理. 指定后边的弹幕没有声音呀, 根本还没有处理到它 😂.</p><p>难受的是我知道需要性能优化, 但是不知道怎么优化…</p><p>搞不定了, 现在开始刷算法抱佛脚好像有点来不及. 于是不得不扯着脸找领导(算法大佬) review 代码求指导. 大佬一句话直接让我再跪: 音量系数的查找, 直接改成 <code>start / 50</code> 在取整复杂度就变 O1 了. 你去试试…</p><p><img src="https://handle-note-img.niubishanshan.top/2021-11-13-16-04-43.png" alt="优化前耗时"></p><p>解决一个问题很容易, 知道怎么解决一个问题很难. 根据领导的方案又是哐哧哐哧又是一顿整. 再看下处理时间:</p><p><img src="https://handle-note-img.niubishanshan.top/2021-11-13-16-21-11.png" alt="优化后耗时"></p><p>所有弹幕的混音时长都限制了 200ms 以内, 产品经理体验也木有问题. 到此为止技术问题全部解决完成 ~</p><h3 id="问题九-iOS-静音模式下无法播放外音"><a href="#问题九-iOS-静音模式下无法播放外音" class="headerlink" title="问题九: iOS 静音模式下无法播放外音"></a>问题九: iOS 静音模式下无法播放外音</h3><p>用户体验的最后一个问题仍然是由产品经理来完成: 如果苹果手机打开了静音模式(左上角的小开关)只能播放视频音频没有声音…</p><p>经过旷日持久的搜索, 我并没有发现有很好的解决办法. 由于 <code>AudioContext</code> 播放的音频属于背景音乐静音模式必然没有声音. 好在经过了一番游说产品经理再次选择了妥协. 可是作为一个 iPhone 几乎无时无刻不处于静音模式.</p><p>怀着对产品经理的愧疚和对于解决问题的执念, 某次刷 github 想要搞点新东西的时候突然发现个神器<a target="_blank" rel="noopener" href="https://github.com/swevans/unmute">unmute</a>专门用于解决背景音乐静音模式下无法播放的问题. 抓紧<key>C&#x2F;V</key> 了一波还真的好使.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> context =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">poorManHuffman</span> = (<span class="params">c, a</span>) =&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> e = a;</span><br><span class="line">        <span class="keyword">for</span> (; c &gt; <span class="number">1</span>; c--) &#123;</span><br><span class="line">            e += a;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> e;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> audioTag = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;audio&#x27;</span>);</span><br><span class="line">    audioTag.<span class="title function_">setAttribute</span>(<span class="string">&#x27;x-webkit-airplay&#x27;</span>, <span class="string">&#x27;deny&#x27;</span>);</span><br><span class="line">    audioTag.<span class="property">controls</span> = <span class="literal">false</span>;</span><br><span class="line">    audioTag.<span class="property">disableRemotePlayback</span> = <span class="literal">true</span>;</span><br><span class="line">    audioTag.<span class="property">preload</span> = <span class="string">&quot;auto&quot;</span>;</span><br><span class="line">    audioTag.<span class="property">src</span> = <span class="string">&quot;data:audio/mpeg;base64,//uQx&quot;</span> + <span class="title function_">poorManHuffman</span>(<span class="number">23</span>, <span class="string">&quot;A&quot;</span>) + <span class="string">&quot;WGluZwAAAA8AAAACAAACcQCA&quot;</span> + <span class="title function_">poorManHuffman</span>(<span class="number">16</span>, <span class="string">&quot;gICA&quot;</span>) + <span class="title function_">poorManHuffman</span>(<span class="number">66</span>, <span class="string">&quot;/&quot;</span>) + <span class="string">&quot;8AAABhTEFNRTMuMTAwA8MAAAAAAAAAABQgJAUHQQAB9AAAAnGMHkkI&quot;</span> + <span class="title function_">poorManHuffman</span>(<span class="number">320</span>, <span class="string">&quot;A&quot;</span>) + <span class="string">&quot;//sQxAADgnABGiAAQBCqgCRMAAgEAH&quot;</span> + <span class="title function_">poorManHuffman</span>(<span class="number">15</span>, <span class="string">&quot;/&quot;</span>) + <span class="string">&quot;7+n/9FTuQsQH//////2NG0jWUGlio5gLQTOtIoeR2WX////X4s9Atb/JRVCbBUpeRUq&quot;</span> + <span class="title function_">poorManHuffman</span>(<span class="number">18</span>, <span class="string">&quot;/&quot;</span>) + <span class="string">&quot;9RUi0f2jn/+xDECgPCjAEQAABN4AAANIAAAAQVTEFNRTMuMTAw&quot;</span> + <span class="title function_">poorManHuffman</span>(<span class="number">97</span>, <span class="string">&quot;V&quot;</span>) + <span class="string">&quot;Q==&quot;</span>;</span><br><span class="line"></span><br><span class="line">    audioTag.<span class="property">loop</span> = <span class="literal">true</span>;</span><br><span class="line">    audioTag.<span class="title function_">load</span>();</span><br><span class="line"></span><br><span class="line">    context.<span class="property">audioTag</span> = audioTag;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>既然背景音乐 <code>AudioContext</code> 会被静音模式限制, 如果加上一个 audio 标签创建的前景音之后静音模式便失去效果. 于是可以在初始化 <code>AudioContext</code> 同时创建一个 audio 标签, 一直循环播放一段空白的 mp3 音乐来占用手机外音喇叭. 此时背景音乐就可以 “沾光” 播放出来了, 不得不含泪揉了揉自己的膝盖.</p><h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>一个看似简单的功能. 从起步困难到中间克服了资源跨域, 音视频策略限制, 对齐问题, 内存溢出问题, CSS 3 动画性能等等一系列疑难杂症. 终于实现了和 <code>App</code> 端近乎一致的效果…</p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%86%85%E5%AD%98%E6%BA%A2%E5%87%BA/1430777">OOM</a></li><li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/HTML/Element/video">video</a></li><li><a target="_blank" rel="noopener" href="https://github.com/swevans/unmute">unmute</a></li><li><a target="_blank" rel="noopener" href="https://baike.baidu.com/item/%E5%90%8C%E6%BA%90%E7%AD%96%E7%95%A5/3927875">同源策略</a></li><li><a target="_blank" rel="noopener" href="https://fex.baidu.com/blog/2015/01/chrome-stalled-problem-resolving-process/">问题的追查</a></li><li><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903733487206413">CORS 跨域</a></li><li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/BaseAudioContext/createBuffer">createBuffer</a></li><li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/AudioContext">AudioContext</a></li><li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/AudioContext/AudioContext#google_chrome">AudioContext()</a></li><li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/zh-CN/docs/Web/API/BaseAudioContext/decodeAudioData">decodeAudioData</a></li><li><a target="_blank" rel="noopener" href="https://github.com/audiojs/audio-buffer-utils">audio-buffer-utils</a></li><li><a target="_blank" rel="noopener" href="https://github.com/fregante/iphone-inline-video">iphone-inline-video</a></li><li><a target="_blank" rel="noopener" href="https://blog.csdn.net/guoke312/article/details/72901882">音频混音的算法实现</a></li><li><a target="_blank" rel="noopener" href="https://developer.chrome.com/blog/autoplay/#webaudio">Autoplay policy in Chrome</a></li><li><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000009395289">视频H5 video标签最佳实践</a></li><li><a target="_blank" rel="noopener" href="https://developers.weixin.qq.com/community/develop/doc/000e640d77cfa001132a6cb8456c01">Android微信内网页音频自动播放能力调整</a></li><li><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_37949737/article/details/105222597">html5 video 在微信浏览器视频不能自动播放！</a></li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/" rel="tag"># 开发笔记</a></div><div class="post-nav"><div class="post-nav-item"><a href="/%E9%9D%A2%E8%AF%95/Vue/%E9%9D%A2%E8%AF%95/Vue/vue%20%E5%8F%8C%E5%90%91%E6%95%B0%E6%8D%AE%E7%BB%91%E5%AE%9A%E5%AE%9E%E7%8E%B0%E7%9A%84%E5%8E%9F%E7%90%86/" rel="prev" title="vue 双向数据绑定实现的原理"><i class="fa fa-chevron-left"></i> vue 双向数据绑定实现的原理</a></div><div class="post-nav-item"> <a href="/%E9%9D%A2%E8%AF%95/css/%E9%9D%A2%E8%AF%95/css/css%E5%B1%9E%E6%80%A7position%E9%83%BD%E6%9C%89%E5%93%AA%E4%BA%9B%E5%80%BC/" rel="next" title="css属性position都有哪些值">css属性position都有哪些值<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div><script>
  window.addEventListener('tabs:register', function() {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%9C%80%E6%B1%82%E8%83%8C%E6%99%AF"><span class="nav-text">需求背景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8A%80%E6%9C%AF%E8%B0%83%E7%A0%94"><span class="nav-text">技术调研</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%87%87%E5%9D%91%E4%B9%8B%E6%97%85"><span class="nav-text">采坑之旅</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E4%B8%80-%E8%83%8C%E6%99%AF%E8%A7%86%E9%A2%91%E6%97%A0%E6%B3%95%E8%87%AA%E5%8A%A8%E6%92%AD%E6%94%BE"><span class="nav-text">问题一: 背景视频无法自动播放</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E4%BA%8C-%E8%A7%86%E9%A2%91%E8%B7%91%E5%88%B0%E9%A1%B6%E5%B1%82%E6%8C%A1%E4%BD%8F%E5%BC%B9%E5%B9%95"><span class="nav-text">问题二: 视频跑到顶层挡住弹幕</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E4%B8%89-iOS-%E7%B3%BB%E7%BB%9F%E5%BC%B9%E5%B9%95%E6%B2%A1%E6%9C%89%E5%A3%B0%E9%9F%B3"><span class="nav-text">问题三: iOS 系统弹幕没有声音</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E5%9B%9B-%E5%BC%B9%E5%B9%95%E6%95%B0%E9%87%8F%E5%A2%9E%E5%A4%9A%E5%90%8E-%E7%A7%BB%E5%8A%A8%E7%AB%AF%E6%8A%A5%E9%94%99"><span class="nav-text">问题四: 弹幕数量增多后, 移动端报错</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E4%BA%94-%E5%BC%B9%E5%B9%95-x2F-%E5%BA%95%E7%89%88%E6%97%A0%E6%B3%95%E5%AF%B9%E9%BD%90"><span class="nav-text">问题五: 弹幕 &#x2F; 底版无法对齐</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E5%85%AD-loading-%E6%97%B6%E9%97%B4%E8%BF%87%E9%95%BF-%E7%94%A8%E6%88%B7%E7%AD%89%E5%BE%85%E6%97%B6%E9%97%B4%E4%B9%85"><span class="nav-text">问题六: loading 时间过长, 用户等待时间久</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E4%B8%83-%E9%9F%B3%E7%94%BB%E6%97%A0%E6%B3%95%E5%AF%B9%E9%BD%90"><span class="nav-text">问题七: 音画无法对齐</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E5%85%AB-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%9C%9F%E7%9A%84%E6%9C%89%E7%94%A8"><span class="nav-text">问题八: 数据结构真的有用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%97%AE%E9%A2%98%E4%B9%9D-iOS-%E9%9D%99%E9%9F%B3%E6%A8%A1%E5%BC%8F%E4%B8%8B%E6%97%A0%E6%B3%95%E6%92%AD%E6%94%BE%E5%A4%96%E9%9F%B3"><span class="nav-text">问题九: iOS 静音模式下无法播放外音</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BB%93%E8%AF%AD"><span class="nav-text">结语</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-text">参考资料</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="圈圈的圈" src="/images/avatar.png"><p class="site-author-name" itemprop="name">圈圈的圈</p><div class="site-description" itemprop="description">技术学习, 读书笔记, 生活感悟 ~</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">142</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">35</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">8</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://juejin.im/user/5837c2bd61ff4b006ca8d1b2" title="掘金 → https:&#x2F;&#x2F;juejin.im&#x2F;user&#x2F;5837c2bd61ff4b006ca8d1b2" rel="noopener" target="_blank"><i class="fa fa-fw fa-stack-overflow"></i> 掘金</a></span><span class="links-of-author-item"><a href="https://github.com/luoquanquan" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;luoquanquan" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:luo_quanquan@163.com" title="E-Mail → mailto:luo_quanquan@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="beian"><a href="http://www.beian.miit.gov.cn/" rel="noopener" target="_blank">京ICP备17034706号-1</a></div><div class="copyright"> &copy; <span itemprop="copyrightYear">2024</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">圈圈的圈</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer></div><script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/js/theme-next-canvas-nest/canvas-nest.min.js"></script><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script></body></html>
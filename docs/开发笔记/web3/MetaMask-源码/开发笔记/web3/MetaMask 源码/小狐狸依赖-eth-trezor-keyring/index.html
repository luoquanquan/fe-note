<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:new URL("http://note.niubishanshan.top").hostname,root:"/",scheme:"Gemini",version:"7.7.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!1,show_result:!1,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{appID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},path:"search.json",motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta name="description" content="与 Ledger 类似. 对于 trezor 硬件钱包, MetaMask 团队也做了封装, 保证了其 Api 和Simple Keyring 的一致性.  由于对于 trezor 的封装逻辑和 Ledger 相似, 也是分为了 address 的派生以及合约的签署. 且将硬件钱包桥接程序和硬件钱包驱动程序的划分也大体一直, 所以相关逻辑本文中不再赘述. 主要对其代码进行一波分析"><meta property="og:type" content="article"><meta property="og:title" content="小狐狸依赖-eth-trezor-keyring"><meta property="og:url" content="http://note.niubishanshan.top/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/MetaMask-%E6%BA%90%E7%A0%81/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/MetaMask%20%E6%BA%90%E7%A0%81/%E5%B0%8F%E7%8B%90%E7%8B%B8%E4%BE%9D%E8%B5%96-eth-trezor-keyring/index.html"><meta property="og:site_name" content="圈圈的笔记"><meta property="og:description" content="与 Ledger 类似. 对于 trezor 硬件钱包, MetaMask 团队也做了封装, 保证了其 Api 和Simple Keyring 的一致性.  由于对于 trezor 的封装逻辑和 Ledger 相似, 也是分为了 address 的派生以及合约的签署. 且将硬件钱包桥接程序和硬件钱包驱动程序的划分也大体一直, 所以相关逻辑本文中不再赘述. 主要对其代码进行一波分析"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2022-12-29T17:36:13.000Z"><meta property="article:modified_time" content="2024-06-27T15:04:43.291Z"><meta property="article:author" content="圈圈的圈"><meta property="article:tag" content="开发笔记"><meta name="twitter:card" content="summary"><link rel="canonical" href="http://note.niubishanshan.top/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/MetaMask-%E6%BA%90%E7%A0%81/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/MetaMask%20%E6%BA%90%E7%A0%81/%E5%B0%8F%E7%8B%90%E7%8B%B8%E4%BE%9D%E8%B5%96-eth-trezor-keyring/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0}</script><title>小狐狸依赖-eth-trezor-keyring | 圈圈的笔记</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div> <a target="_blank" rel="noopener" href="https://github.com/luoquanquan" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">圈圈的笔记</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">路漫漫其修远兮, 吾将上下而求索</p></div><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i> 首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i> 归档</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i> 关于</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="site-search"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="搜索..." spellcheck="false" type="text" id="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"></div></div><div class="search-pop-overlay"></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://note.niubishanshan.top/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/MetaMask-%E6%BA%90%E7%A0%81/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/MetaMask%20%E6%BA%90%E7%A0%81/%E5%B0%8F%E7%8B%90%E7%8B%B8%E4%BE%9D%E8%B5%96-eth-trezor-keyring/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.png"><meta itemprop="name" content="圈圈的圈"><meta itemprop="description" content="技术学习, 读书笔记, 生活感悟 ~"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="圈圈的笔记"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> 小狐狸依赖-eth-trezor-keyring</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-12-30 01:36:13" itemprop="dateCreated datePublished" datetime="2022-12-30T01:36:13+08:00">2022-12-30</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2024-06-27 23:04:43" itemprop="dateModified" datetime="2024-06-27T23:04:43+08:00">2024-06-27</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">开发笔记</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/" itemprop="url" rel="index"><span itemprop="name">web3</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/MetaMask-%E6%BA%90%E7%A0%81/" itemprop="url" rel="index"><span itemprop="name">MetaMask 源码</span></a></span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>与 Ledger 类似. 对于 trezor 硬件钱包, MetaMask 团队也做了封装, 保证了其 Api 和<a target="_blank" rel="noopener" href="https://github.com/MetaMask/eth-simple-keyring#the-keyring-class-protocol">Simple Keyring</a> 的一致性.</p></blockquote><p>由于对于 trezor 的封装逻辑和 Ledger 相似, 也是分为了 address 的派生以及合约的签署. 且将硬件钱包桥接程序和硬件钱包驱动程序的划分也大体一直, 所以相关逻辑本文中不再赘述. 主要对其代码进行一波分析</p><span id="more"></span><h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">EventEmitter</span> &#125; = <span class="built_in">require</span>(<span class="string">&#x27;events&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> ethUtil = <span class="built_in">require</span>(<span class="string">&#x27;ethereumjs-util&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">Transaction</span> = <span class="built_in">require</span>(<span class="string">&#x27;ethereumjs-tx&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">HDKey</span> = <span class="built_in">require</span>(<span class="string">&#x27;hdkey&#x27;</span>)</span><br><span class="line"><span class="comment">// 硬件钱包驱动程序</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">TrezorConnect</span> = <span class="built_in">require</span>(<span class="string">&#x27;trezor-connect&#x27;</span>).<span class="property">default</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> hdPathString = <span class="string">`m/44&#x27;/60&#x27;/0&#x27;/0`</span></span><br><span class="line"><span class="keyword">const</span> keyringType = <span class="string">&#x27;Trezor Hardware&#x27;</span></span><br><span class="line"><span class="keyword">const</span> pathBase = <span class="string">&#x27;m&#x27;</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">MAX_INDEX</span> = <span class="number">1000</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">DELAY_BETWEEN_POPUPS</span> = <span class="number">1000</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">TREZOR_CONNECT_MANIFEST</span> = &#123;</span><br><span class="line">  <span class="attr">email</span>: <span class="string">&#x27;support@metamask.io&#x27;</span>,</span><br><span class="line">  <span class="attr">appUrl</span>: <span class="string">&#x27;https://metamask.io&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TrezorKeyring</span> <span class="keyword">extends</span> <span class="title class_ inherited__">EventEmitter</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span> (opts = &#123;&#125;) &#123;</span><br><span class="line">    <span class="variable language_">super</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">type</span> = keyringType</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">accounts</span> = []</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">hdk</span> = <span class="keyword">new</span> <span class="title class_">HDKey</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">page</span> = <span class="number">0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">perPage</span> = <span class="number">5</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">unlockedAccount</span> = <span class="number">0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">paths</span> = &#123;&#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">deserialize</span>(opts)</span><br><span class="line">    <span class="comment">// 初始化钱包的时候需要传入 Developer 的信息</span></span><br><span class="line">    <span class="title class_">TrezorConnect</span>.<span class="title function_">manifest</span>(<span class="variable constant_">TREZOR_CONNECT_MANIFEST</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  serialize () &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(&#123;</span><br><span class="line">      <span class="attr">hdPath</span>: <span class="variable language_">this</span>.<span class="property">hdPath</span>,</span><br><span class="line">      <span class="attr">accounts</span>: <span class="variable language_">this</span>.<span class="property">accounts</span>,</span><br><span class="line">      <span class="attr">page</span>: <span class="variable language_">this</span>.<span class="property">page</span>,</span><br><span class="line">      <span class="attr">paths</span>: <span class="variable language_">this</span>.<span class="property">paths</span>,</span><br><span class="line">      <span class="attr">perPage</span>: <span class="variable language_">this</span>.<span class="property">perPage</span>,</span><br><span class="line">      <span class="attr">unlockedAccount</span>: <span class="variable language_">this</span>.<span class="property">unlockedAccount</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  deserialize (opts = &#123;&#125;) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">hdPath</span> = opts.<span class="property">hdPath</span> || hdPathString</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">accounts</span> = opts.<span class="property">accounts</span> || []</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">page</span> = opts.<span class="property">page</span> || <span class="number">0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">perPage</span> = opts.<span class="property">perPage</span> || <span class="number">5</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">paths</span> = opts.<span class="property">paths</span> || &#123;&#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 判断当前硬件钱包是否为解锁状态, 用户进入硬件钱包连接页面且选中的硬件钱包处于解锁状态的话</span></span><br><span class="line">  <span class="comment">// 会直接触发派生当前硬件钱包第一页地址的逻辑</span></span><br><span class="line">  isUnlocked () &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Boolean</span>(<span class="variable language_">this</span>.<span class="property">hdk</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">hdk</span>.<span class="property">publicKey</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 解锁方法, 利用此方法可以获取到硬件钱包对应 path 的 publicKey, 利用此 publicKey 可以派生</span></span><br><span class="line"><span class="comment">   * 出更多的 address 供用户选择并导入</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  unlock () &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="title function_">isUnlocked</span>()) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="string">&#x27;already unlocked&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="title class_">TrezorConnect</span>.<span class="title function_">getPublicKey</span>(&#123;</span><br><span class="line">        <span class="attr">path</span>: <span class="variable language_">this</span>.<span class="property">hdPath</span>,</span><br><span class="line">        <span class="attr">coin</span>: <span class="string">&#x27;ETH&#x27;</span>,</span><br><span class="line">      &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (response.<span class="property">success</span>) &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">hdk</span>.<span class="property">publicKey</span> = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(response.<span class="property">payload</span>.<span class="property">publicKey</span>, <span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">hdk</span>.<span class="property">chainCode</span> = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(response.<span class="property">payload</span>.<span class="property">chainCode</span>, <span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line">          <span class="title function_">resolve</span>(<span class="string">&#x27;just unlocked&#x27;</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>((response.<span class="property">payload</span> &amp;&amp; response.<span class="property">payload</span>.<span class="property">error</span>) || <span class="string">&#x27;Unknown error&#x27;</span>))</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>((e &amp;&amp; e.<span class="title function_">toString</span>()) || <span class="string">&#x27;Unknown error&#x27;</span>))</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 用户在导入账户页面选择了对应的账户地址并确认导入之后执行的逻辑</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  addAccounts (n = <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">unlock</span>()</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function">(<span class="params">_</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> <span class="keyword">from</span> = <span class="variable language_">this</span>.<span class="property">unlockedAccount</span></span><br><span class="line">          <span class="keyword">const</span> to = <span class="keyword">from</span> + n</span><br><span class="line"></span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="keyword">from</span>; i &lt; to; i++) &#123;</span><br><span class="line">            <span class="keyword">const</span> address = <span class="variable language_">this</span>.<span class="title function_">_addressFromIndex</span>(pathBase, i)</span><br><span class="line">            <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">accounts</span>.<span class="title function_">includes</span>(address)) &#123;</span><br><span class="line">              <span class="variable language_">this</span>.<span class="property">accounts</span>.<span class="title function_">push</span>(address)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">page</span> = <span class="number">0</span></span><br><span class="line">          &#125;</span><br><span class="line">          <span class="title function_">resolve</span>(<span class="variable language_">this</span>.<span class="property">accounts</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_">catch</span>(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="title function_">reject</span>(e)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  getFirstPage () &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">page</span> = <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">__getPage</span>(<span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  getNextPage () &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">__getPage</span>(<span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  getPreviousPage () &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">__getPage</span>(-<span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 派生账户的方法</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  __getPage (increment) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">page</span> += increment</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">page</span> &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">page</span> = <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">unlock</span>()</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function">(<span class="params">_</span>) =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">const</span> <span class="keyword">from</span> = (<span class="variable language_">this</span>.<span class="property">page</span> - <span class="number">1</span>) * <span class="variable language_">this</span>.<span class="property">perPage</span></span><br><span class="line">          <span class="keyword">const</span> to = <span class="keyword">from</span> + <span class="variable language_">this</span>.<span class="property">perPage</span></span><br><span class="line"></span><br><span class="line">          <span class="keyword">const</span> accounts = []</span><br><span class="line"></span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="keyword">from</span>; i &lt; to; i++) &#123;</span><br><span class="line">            <span class="comment">// 由于老版本 trezor 只支持 BIP44 Standard (Trezor) 这种 path 作为基础 path</span></span><br><span class="line">            <span class="comment">// 所以派生地址的逻辑中只有这一种算法</span></span><br><span class="line">            <span class="keyword">const</span> address = <span class="variable language_">this</span>.<span class="title function_">_addressFromIndex</span>(pathBase, i)</span><br><span class="line">            accounts.<span class="title function_">push</span>(&#123;</span><br><span class="line">              address,</span><br><span class="line">              <span class="attr">balance</span>: <span class="literal">null</span>,</span><br><span class="line">              <span class="attr">index</span>: i,</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">paths</span>[ethUtil.<span class="title function_">toChecksumAddress</span>(address)] = i</span><br><span class="line"></span><br><span class="line">          &#125;</span><br><span class="line">          <span class="title function_">resolve</span>(accounts)</span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_">catch</span>(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="title function_">reject</span>(e)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取当前已经解锁的所有账户</span></span><br><span class="line">  getAccounts () &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="variable language_">this</span>.<span class="property">accounts</span>.<span class="title function_">slice</span>())</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 移除当前已经解锁的账户</span></span><br><span class="line">  removeAccount (address) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">accounts</span>.<span class="title function_">map</span>(<span class="function">(<span class="params">a</span>) =&gt;</span> a.<span class="title function_">toLowerCase</span>()).<span class="title function_">includes</span>(address.<span class="title function_">toLowerCase</span>())) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`Address <span class="subst">$&#123;address&#125;</span> not found in this keyring`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">accounts</span> = <span class="variable language_">this</span>.<span class="property">accounts</span>.<span class="title function_">filter</span>(<span class="function">(<span class="params">a</span>) =&gt;</span> a.<span class="title function_">toLowerCase</span>() !== address.<span class="title function_">toLowerCase</span>())</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// tx is an instance of the ethereumjs-transaction class.</span></span><br><span class="line">  <span class="comment">// 合约签署 API, 目前我们用的版本的 eth-trezor-keyring 尚未兼容 eip 1559, 下周我得兼容下了</span></span><br><span class="line">  signTransaction (address, tx) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">unlock</span>()</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function">(<span class="params">status</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="built_in">setTimeout</span>(<span class="function">(<span class="params">_</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="title class_">TrezorConnect</span>.<span class="title function_">ethereumSignTransaction</span>(&#123;</span><br><span class="line">              <span class="attr">path</span>: <span class="variable language_">this</span>.<span class="title function_">_pathFromAddress</span>(address),</span><br><span class="line">              <span class="attr">transaction</span>: &#123;</span><br><span class="line">                <span class="attr">to</span>: <span class="variable language_">this</span>.<span class="title function_">_normalize</span>(tx.<span class="property">to</span>),</span><br><span class="line">                <span class="attr">value</span>: <span class="variable language_">this</span>.<span class="title function_">_normalize</span>(tx.<span class="property">value</span>),</span><br><span class="line">                <span class="attr">data</span>: <span class="variable language_">this</span>.<span class="title function_">_normalize</span>(tx.<span class="property">data</span>),</span><br><span class="line">                <span class="attr">chainId</span>: tx.<span class="property">_chainId</span>,</span><br><span class="line">                <span class="attr">nonce</span>: <span class="variable language_">this</span>.<span class="title function_">_normalize</span>(tx.<span class="property">nonce</span>),</span><br><span class="line">                <span class="attr">gasLimit</span>: <span class="variable language_">this</span>.<span class="title function_">_normalize</span>(tx.<span class="property">gasLimit</span>),</span><br><span class="line">                <span class="attr">gasPrice</span>: <span class="variable language_">this</span>.<span class="title function_">_normalize</span>(tx.<span class="property">gasPrice</span>),</span><br><span class="line">              &#125;,</span><br><span class="line">            &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">              <span class="keyword">if</span> (response.<span class="property">success</span>) &#123;</span><br><span class="line">                tx.<span class="property">v</span> = response.<span class="property">payload</span>.<span class="property">v</span></span><br><span class="line">                tx.<span class="property">r</span> = response.<span class="property">payload</span>.<span class="property">r</span></span><br><span class="line">                tx.<span class="property">s</span> = response.<span class="property">payload</span>.<span class="property">s</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">const</span> signedTx = <span class="keyword">new</span> <span class="title class_">Transaction</span>(tx)</span><br><span class="line"></span><br><span class="line">                <span class="keyword">const</span> addressSignedWith = ethUtil.<span class="title function_">toChecksumAddress</span>(<span class="string">`0x<span class="subst">$&#123;signedTx.<span class="keyword">from</span>.toString(<span class="string">&#x27;hex&#x27;</span>)&#125;</span>`</span>)</span><br><span class="line">                <span class="keyword">const</span> correctAddress = ethUtil.<span class="title function_">toChecksumAddress</span>(address)</span><br><span class="line">                <span class="keyword">if</span> (addressSignedWith !== correctAddress) &#123;</span><br><span class="line">                  <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;signature doesnt match the right address&#x27;</span>))</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="title function_">resolve</span>(signedTx)</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>((response.<span class="property">payload</span> &amp;&amp; response.<span class="property">payload</span>.<span class="property">error</span>) || <span class="string">&#x27;Unknown error&#x27;</span>))</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">            &#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">              <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>((e &amp;&amp; e.<span class="title function_">toString</span>()) || <span class="string">&#x27;Unknown error&#x27;</span>))</span><br><span class="line">            &#125;)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// This is necessary to avoid popup collision</span></span><br><span class="line">            <span class="comment">// between the unlock &amp; sign trezor popups</span></span><br><span class="line">          &#125;, status === <span class="string">&#x27;just unlocked&#x27;</span> ? <span class="variable constant_">DELAY_BETWEEN_POPUPS</span> : <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        &#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>((e &amp;&amp; e.<span class="title function_">toString</span>()) || <span class="string">&#x27;Unknown error&#x27;</span>))</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// wrapper of signPersonalMessage</span></span><br><span class="line">  signMessage (withAccount, data) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">signPersonalMessage</span>(withAccount, data)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// For personal_sign, we need to prefix the message:</span></span><br><span class="line">  signPersonalMessage (withAccount, message) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">unlock</span>()</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function">(<span class="params">status</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="built_in">setTimeout</span>(<span class="function">(<span class="params">_</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="title class_">TrezorConnect</span>.<span class="title function_">ethereumSignMessage</span>(&#123;</span><br><span class="line">              <span class="attr">path</span>: <span class="variable language_">this</span>.<span class="title function_">_pathFromAddress</span>(withAccount),</span><br><span class="line">              <span class="attr">message</span>: ethUtil.<span class="title function_">stripHexPrefix</span>(message),</span><br><span class="line">              <span class="attr">hex</span>: <span class="literal">true</span>,</span><br><span class="line">            &#125;).<span class="title function_">then</span>(<span class="function">(<span class="params">response</span>) =&gt;</span> &#123;</span><br><span class="line">              <span class="keyword">if</span> (response.<span class="property">success</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (response.<span class="property">payload</span>.<span class="property">address</span> !== ethUtil.<span class="title function_">toChecksumAddress</span>(withAccount)) &#123;</span><br><span class="line">                  <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;signature doesnt match the right address&#x27;</span>))</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">const</span> signature = <span class="string">`0x<span class="subst">$&#123;response.payload.signature&#125;</span>`</span></span><br><span class="line">                <span class="title function_">resolve</span>(signature)</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>((response.<span class="property">payload</span> &amp;&amp; response.<span class="property">payload</span>.<span class="property">error</span>) || <span class="string">&#x27;Unknown error&#x27;</span>))</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">              <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error while trying to sign a message &#x27;</span>, e)</span><br><span class="line">              <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>((e &amp;&amp; e.<span class="title function_">toString</span>()) || <span class="string">&#x27;Unknown error&#x27;</span>))</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="comment">// This is necessary to avoid popup collision</span></span><br><span class="line">            <span class="comment">// between the unlock &amp; sign trezor popups</span></span><br><span class="line">          &#125;, status === <span class="string">&#x27;just unlocked&#x27;</span> ? <span class="variable constant_">DELAY_BETWEEN_POPUPS</span> : <span class="number">0</span>)</span><br><span class="line">        &#125;).<span class="title function_">catch</span>(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Error while trying to sign a message &#x27;</span>, e)</span><br><span class="line">          <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>((e &amp;&amp; e.<span class="title function_">toString</span>()) || <span class="string">&#x27;Unknown error&#x27;</span>))</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// EIP-712 Sign Typed Data, 老版本尚未支持</span></span><br><span class="line">  signTypedData () &#123;</span><br><span class="line">    <span class="comment">// Waiting on trezor to enable this</span></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Not supported on this device&#x27;</span>))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  exportAccount () &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Not supported on this device&#x27;</span>))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 清空硬件钱包数据</span></span><br><span class="line">  forgetDevice () &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">accounts</span> = []</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">hdk</span> = <span class="keyword">new</span> <span class="title class_">HDKey</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">page</span> = <span class="number">0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">unlockedAccount</span> = <span class="number">0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">paths</span> = &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* PRIVATE METHODS */</span></span><br><span class="line"></span><br><span class="line">  _normalize (buf) &#123;</span><br><span class="line">    <span class="keyword">return</span> ethUtil.<span class="title function_">bufferToHex</span>(buf).<span class="title function_">toString</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 根据 publicKey 派生 address 的算法</span></span><br><span class="line">  <span class="comment">// eslint-disable-next-line no-shadow</span></span><br><span class="line">  _addressFromIndex (pathBase, i) &#123;</span><br><span class="line">    <span class="keyword">const</span> dkey = <span class="variable language_">this</span>.<span class="property">hdk</span>.<span class="title function_">derive</span>(<span class="string">`<span class="subst">$&#123;pathBase&#125;</span>/<span class="subst">$&#123;i&#125;</span>`</span>)</span><br><span class="line">    <span class="keyword">const</span> address = ethUtil</span><br><span class="line">      .<span class="title function_">publicToAddress</span>(dkey.<span class="property">publicKey</span>, <span class="literal">true</span>)</span><br><span class="line">      .<span class="title function_">toString</span>(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> ethUtil.<span class="title function_">toChecksumAddress</span>(<span class="string">`0x<span class="subst">$&#123;address&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 根据 address 反向推算 path 的方法, 这里的 address 已存在, 那肯定是之前派生过的</span></span><br><span class="line">  _pathFromAddress (address) &#123;</span><br><span class="line">    <span class="keyword">const</span> checksummedAddress = ethUtil.<span class="title function_">toChecksumAddress</span>(address)</span><br><span class="line">    <span class="keyword">let</span> index = <span class="variable language_">this</span>.<span class="property">paths</span>[checksummedAddress]</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> index === <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="variable constant_">MAX_INDEX</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (checksummedAddress === <span class="variable language_">this</span>.<span class="title function_">_addressFromIndex</span>(pathBase, i)) &#123;</span><br><span class="line">          index = i</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> index === <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Unknown address&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.hdPath&#125;</span>/<span class="subst">$&#123;index&#125;</span>`</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">TrezorKeyring</span>.<span class="property">type</span> = keyringType</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">TrezorKeyring</span></span><br></pre></td></tr></table></figure><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a target="_blank" rel="noopener" href="https://github.com/MetaMask/eth-trezor-keyring">eth-trezor-keyring</a></li></ul><h2 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h2><blockquote><p>在尽心源码学习的过程中, 我发现我们现在使用的版本和最新的 eth-trezor-keyring 存在一些差距:</p></blockquote><ul><li>EIP-1559 兼容</li><li>EIP-712 兼容</li></ul><p>为了保证用户使用体验, 后续需要升级我们使用的 eth-trezor-keyring 到最新版本 ~</p></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/" rel="tag"># 开发笔记</a></div><div class="post-nav"><div class="post-nav-item"><a href="/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/MetaMask-%E6%BA%90%E7%A0%81/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/MetaMask%20%E6%BA%90%E7%A0%81/%E5%B0%8F%E7%8B%90%E7%8B%B8%E4%BE%9D%E8%B5%96-eth-ledger-bridge-keyring/" rel="prev" title="小狐狸依赖-eth-ledger-bridge-keyring"><i class="fa fa-chevron-left"></i> 小狐狸依赖-eth-ledger-bridge-keyring</a></div><div class="post-nav-item"> <a href="/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/JavaScript/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/JavaScript/%E5%B8%B8%E8%A7%81%E7%9A%84%20js%20%E5%9D%91/" rel="next" title="常见的 html 坑">常见的 html 坑<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div><script>
  window.addEventListener('tabs:register', function() {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-text">源码分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-text">参考资料</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#TODO"><span class="nav-text">TODO</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="圈圈的圈" src="/images/avatar.png"><p class="site-author-name" itemprop="name">圈圈的圈</p><div class="site-description" itemprop="description">技术学习, 读书笔记, 生活感悟 ~</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">142</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">35</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">8</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://juejin.im/user/5837c2bd61ff4b006ca8d1b2" title="掘金 → https:&#x2F;&#x2F;juejin.im&#x2F;user&#x2F;5837c2bd61ff4b006ca8d1b2" rel="noopener" target="_blank"><i class="fa fa-fw fa-stack-overflow"></i> 掘金</a></span><span class="links-of-author-item"><a href="https://github.com/luoquanquan" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;luoquanquan" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:luo_quanquan@163.com" title="E-Mail → mailto:luo_quanquan@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="beian"><a href="http://www.beian.miit.gov.cn/" rel="noopener" target="_blank">京ICP备17034706号-1</a></div><div class="copyright"> &copy; <span itemprop="copyrightYear">2024</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">圈圈的圈</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer></div><script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/js/theme-next-canvas-nest/canvas-nest.min.js"></script><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script></body></html>
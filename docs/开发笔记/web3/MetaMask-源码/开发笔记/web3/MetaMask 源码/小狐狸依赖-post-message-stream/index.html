<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:new URL("http://note.niubishanshan.top").hostname,root:"/",scheme:"Gemini",version:"7.7.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!1,show_result:!1,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{appID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},path:"search.json",motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta name="description" content="é˜…è¯» metamask çš„ package.json çš„è¿‡ç¨‹ä¸­, ç¬¬ä¸€ä¸ªå¸å¼•æˆ‘æ³¨æ„çš„ npm åŒ…å°±æ˜¯ post-message-stream. æ— å®ƒ, å”¯çœ¼ç†Ÿå°”.  é¦–å…ˆæƒ³åˆ° postMessage ä¸€ä¸ªçª—å£å¯ä»¥è·å¾—å¯¹å¦ä¸€ä¸ªçª—å£çš„å¼•ç”¨ (æ¯”å¦‚ targetWindow &#x3D; window.opener), ç„¶ååœ¨çª—å£ä¸Šè°ƒç”¨ targetWindow.postMessage() æ–¹æ³•åˆ†å‘ä¸€"><meta property="og:type" content="article"><meta property="og:title" content="å°ç‹ç‹¸ä¾èµ–-post-message-stream"><meta property="og:url" content="http://note.niubishanshan.top/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/MetaMask-%E6%BA%90%E7%A0%81/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/MetaMask%20%E6%BA%90%E7%A0%81/%E5%B0%8F%E7%8B%90%E7%8B%B8%E4%BE%9D%E8%B5%96-post-message-stream/index.html"><meta property="og:site_name" content="åœˆåœˆçš„ç¬”è®°"><meta property="og:description" content="é˜…è¯» metamask çš„ package.json çš„è¿‡ç¨‹ä¸­, ç¬¬ä¸€ä¸ªå¸å¼•æˆ‘æ³¨æ„çš„ npm åŒ…å°±æ˜¯ post-message-stream. æ— å®ƒ, å”¯çœ¼ç†Ÿå°”.  é¦–å…ˆæƒ³åˆ° postMessage ä¸€ä¸ªçª—å£å¯ä»¥è·å¾—å¯¹å¦ä¸€ä¸ªçª—å£çš„å¼•ç”¨ (æ¯”å¦‚ targetWindow &#x3D; window.opener), ç„¶ååœ¨çª—å£ä¸Šè°ƒç”¨ targetWindow.postMessage() æ–¹æ³•åˆ†å‘ä¸€"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://handle-note-img.niubishanshan.top/post-message.gif"><meta property="og:image" content="https://handle-note-img.niubishanshan.top/post-message-stream.gif"><meta property="og:image" content="https://handle-note-img.niubishanshan.top/20220927114850.png"><meta property="article:published_time" content="2022-09-26T03:23:10.000Z"><meta property="article:modified_time" content="2024-06-27T15:04:43.291Z"><meta property="article:author" content="åœˆåœˆçš„åœˆ"><meta property="article:tag" content="å¼€å‘ç¬”è®°"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://handle-note-img.niubishanshan.top/post-message.gif"><link rel="canonical" href="http://note.niubishanshan.top/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/MetaMask-%E6%BA%90%E7%A0%81/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/MetaMask%20%E6%BA%90%E7%A0%81/%E5%B0%8F%E7%8B%90%E7%8B%B8%E4%BE%9D%E8%B5%96-post-message-stream/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0}</script><title>å°ç‹ç‹¸ä¾èµ–-post-message-stream | åœˆåœˆçš„ç¬”è®°</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div> <a target="_blank" rel="noopener" href="https://github.com/luoquanquan" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">åœˆåœˆçš„ç¬”è®°</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">è·¯æ¼«æ¼«å…¶ä¿®è¿œå…®, å¾å°†ä¸Šä¸‹è€Œæ±‚ç´¢</p></div><div class="site-nav-toggle"><div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ "><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i> é¦–é¡µ</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i> æ ‡ç­¾</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i> åˆ†ç±»</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i> å½’æ¡£</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i> å…³äº</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> æœç´¢</a></li></ul></nav><div class="site-search"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="æœç´¢..." spellcheck="false" type="text" id="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"></div></div><div class="search-pop-overlay"></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://note.niubishanshan.top/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/MetaMask-%E6%BA%90%E7%A0%81/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/MetaMask%20%E6%BA%90%E7%A0%81/%E5%B0%8F%E7%8B%90%E7%8B%B8%E4%BE%9D%E8%B5%96-post-message-stream/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.png"><meta itemprop="name" content="åœˆåœˆçš„åœˆ"><meta itemprop="description" content="æŠ€æœ¯å­¦ä¹ , è¯»ä¹¦ç¬”è®°, ç”Ÿæ´»æ„Ÿæ‚Ÿ ~"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="åœˆåœˆçš„ç¬”è®°"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> å°ç‹ç‹¸ä¾èµ–-post-message-stream</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">å‘è¡¨äº</span> <time title="åˆ›å»ºæ—¶é—´ï¼š2022-09-26 11:23:10" itemprop="dateCreated datePublished" datetime="2022-09-26T11:23:10+08:00">2022-09-26</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i></span> <span class="post-meta-item-text">æ›´æ–°äº</span> <time title="ä¿®æ”¹æ—¶é—´ï¼š2024-06-27 23:04:43" itemprop="dateModified" datetime="2024-06-27T23:04:43+08:00">2024-06-27</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">åˆ†ç±»äº</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">å¼€å‘ç¬”è®°</span></a></span> ï¼Œ <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/" itemprop="url" rel="index"><span itemprop="name">web3</span></a></span> ï¼Œ <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/MetaMask-%E6%BA%90%E7%A0%81/" itemprop="url" rel="index"><span itemprop="name">MetaMask æºç </span></a></span></span><span class="post-meta-item" title="é˜…è¯»æ¬¡æ•°" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">é˜…è¯»æ¬¡æ•°ï¼š</span><span id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>é˜…è¯» metamask çš„ package.json çš„è¿‡ç¨‹ä¸­, ç¬¬ä¸€ä¸ªå¸å¼•æˆ‘æ³¨æ„çš„ npm åŒ…å°±æ˜¯ post-message-stream. æ— å®ƒ, å”¯çœ¼ç†Ÿå°”.</p></blockquote><h2 id="é¦–å…ˆæƒ³åˆ°-postMessage"><a href="#é¦–å…ˆæƒ³åˆ°-postMessage" class="headerlink" title="é¦–å…ˆæƒ³åˆ° postMessage"></a>é¦–å…ˆæƒ³åˆ° <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage">postMessage</a></h2><blockquote><p>ä¸€ä¸ªçª—å£å¯ä»¥è·å¾—å¯¹å¦ä¸€ä¸ªçª—å£çš„å¼•ç”¨ (æ¯”å¦‚ targetWindow &#x3D; window.opener), ç„¶ååœ¨çª—å£ä¸Šè°ƒç”¨ targetWindow.postMessage() æ–¹æ³•åˆ†å‘ä¸€ä¸ª MessageEvent æ¶ˆæ¯. æ¥æ”¶æ¶ˆæ¯çš„çª—å£å¯ä»¥æ ¹æ®éœ€è¦è‡ªç”±å¤„ç†æ­¤äº‹ä»¶ (en-US). ä¼ é€’ç»™ window.postMessage() çš„å‚æ•°(æ¯”å¦‚ message)å°†é€šè¿‡æ¶ˆæ¯äº‹ä»¶å¯¹è±¡æš´éœ²ç»™æ¥æ”¶æ¶ˆæ¯çš„çª—å£</p></blockquote><p>ç®€å•çš„è¯´, ä½ é¦–å…ˆæ‰“å¼€ä¸€ä¸ªé¡µé¢ <code>index</code>, ç„¶ååœ¨è¿™ä¸ªé¡µé¢é€šè¿‡ <code>window.open()</code> æ‰“å¼€ä¸€ä¸ªå­é¡µé¢, æ­¤æ—¶å°±èƒ½é€šè¿‡ <code>postMessage</code> å®ç°ä¸¤ä¸ªçˆ¶å­é¡µé¢ä¹‹é—´çš„é€šä¿¡. <code>æ­¤å¤–postMessage</code> è¿˜å¸¸ç”¨äº <code>webWorker</code> å’Œä¸»è¿›ç¨‹ä¹‹é—´çš„é€šä¿¡.</p><span id="more"></span><h3 id="ä¸¾ä¸ª-ğŸŒ°"><a href="#ä¸¾ä¸ª-ğŸŒ°" class="headerlink" title="ä¸¾ä¸ª ğŸŒ°"></a>ä¸¾ä¸ª ğŸŒ°</h3><p>ä¸ºäº†ä¾¿äºç†è§£, æˆ‘æäº†ä¸ªæµ‹è¯•é¡¹ç›®ç”¨äº, ç¬”è®°å¥½è®°æ€§ä¸å¦‚çƒ‚ç¬”å¤´å­.</p><p>é¦–å…ˆ, ä½ æœ‰ä¸€ä¸ª <code>index.html</code> ä½œä¸ºçˆ¶çº§é¡µé¢</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- index.html --&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Index<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Home Page<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;btn-open-foo&quot;</span>&gt;</span>open Foo<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;btn-hi-via-post-message&quot;</span>&gt;</span>hi this is Home via post message<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;./index.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>çˆ¶çº§é¡µé¢ä¸­å¼•å…¥çš„ js æ–‡ä»¶ä¸º</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> $ <span class="keyword">from</span> <span class="string">&#x27;jquery&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> fooPage</span><br><span class="line"></span><br><span class="line">$(<span class="string">&#x27;#btn-open-foo&#x27;</span>).<span class="title function_">on</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    fooPage = <span class="variable language_">window</span>.<span class="title function_">open</span>(<span class="string">&#x27;/sub-html/foo.html&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">$(<span class="string">&#x27;#btn-hi-via-post-message&#x27;</span>).<span class="title function_">on</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (fooPage) &#123;</span><br><span class="line">        fooPage.<span class="title function_">postMessage</span>(<span class="string">&#x27;hi this is Home Page&#x27;</span>, <span class="string">&#x27;*&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;message&#x27;</span>, <span class="function">(<span class="params">&#123;data&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Current timestamp <span class="subst">$&#123;<span class="built_in">Date</span>.now()&#125;</span> data: `</span>, data)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>é€šè¿‡ js ä¸­æˆ‘ä»¬ä¸éš¾å‘ç°, é¡¹ç›®ä¸­è¿˜éœ€è¦ä¸€ä¸ª <code>sub-html/foo.html</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- sub-html/foo.html --&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Foo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Foo Page<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;btn-send&quot;</span>&gt;</span>hi this is Foo Page<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;./foo.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åœ¨å®ƒçš„åŒçº§, è¿˜éœ€è¦ä¸€ä¸ª <code>foo.js</code> æ–‡ä»¶</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> $ <span class="keyword">from</span> <span class="string">&#x27;jquery&#x27;</span></span><br><span class="line"></span><br><span class="line">$(<span class="string">&#x27;#btn-send&#x27;</span>).<span class="title function_">on</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">opener</span>.<span class="title function_">postMessage</span>(<span class="string">&#x27;hi this is Foo Page&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;message&#x27;</span>, <span class="function">(<span class="params">&#123;data&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Current timestamp <span class="subst">$&#123;<span class="built_in">Date</span>.now()&#125;</span> data: `</span>, data)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>ä»¥ä¸Šä¸º postMessage ç®€å•åº”ç”¨çš„å®ä¾‹, ä»£ç è¿‡äºç®€å•, ä¸åšé€è¡Œæ³¨é‡Š. å…¶ä¸­éœ€è¦ç‰¹æ®Šè¯´æ˜çš„æ˜¯åœ¨å­é¡µé¢ä¸­ <code>window.opener</code> å…¶å®å°±æ˜¯å¯¹æ‰“å¼€è¿™ä¸ªå­é¡µé¢çš„çˆ¶çº§é¡µé¢çš„ <code>window</code> å¼•ç”¨, eg:</p><p>å¤§å¤´å„¿å­.opener &#x3D;&#x3D;&#x3D; å°å¤´çˆ¸çˆ¸ &#x3D;&gt; true</p><p><small>PS: ä»…ä½œä¸ºæŠ€æœ¯å®ä¾‹, ä¸åšçœŸå®æ€§åˆ¤æ–­</small></p><h3 id="è¿è¡Œç¤ºä¾‹ä»£ç "><a href="#è¿è¡Œç¤ºä¾‹ä»£ç " class="headerlink" title="è¿è¡Œç¤ºä¾‹ä»£ç "></a>è¿è¡Œç¤ºä¾‹ä»£ç </h3><p>ä¸Šè¿°ç¤ºä¾‹ä»£ç å‡å·²ä¸Šä¼  <a target="_blank" rel="noopener" href="https://github.com/luoquanquan/learn-fe/tree/post-message-stream-learn-v1/metamask-learn/post-message-stream-learn">github</a>, çº¸ä¸Šå¾—æ¥ç»ˆè§‰æµ…, å»ºè®®æ‰‹æ•²ä¸€ä¸‹. 20 æ¥åˆ†é’Ÿå°±èƒ½æå®š. ç”±äºé¡¹ç›®ä¸­ç”¨åˆ°äº† npm çš„ jQuery åŒ…. æ‰€ä»¥ç”¨ <a target="_blank" rel="noopener" href="https://zh.parceljs.org/">parcel</a> æ„å»ºäº†ä¸€ä¸‹, ç›´æ¥ <code>npm start</code> å³å¯.</p><p>ä»£ç è¿è¡Œå®Œæˆåæµè§ˆå™¨è®¿é—® <a target="_blank" rel="noopener" href="http://localhost:1234/index.html">http://localhost:1234/index.html</a> å³å¯æ‰“å¼€ <code>Index Page</code>. postMessage çš„å·¥ä½œè¿‡ç¨‹å¦‚ä¸‹å›¾:</p><p><img src="https://handle-note-img.niubishanshan.top/post-message.gif"></p><h2 id="å°ç‹ç‹¸ä¾èµ–-post-message-stream-4-0-0"><a href="#å°ç‹ç‹¸ä¾èµ–-post-message-stream-4-0-0" class="headerlink" title="å°ç‹ç‹¸ä¾èµ– post-message-stream@^4.0.0"></a>å°ç‹ç‹¸ä¾èµ– post-message-stream@^4.0.0</h2><blockquote><p>Sets up a duplex object stream over window.postMessage, between pages or a dedicated Web Worker and its parent window.</p></blockquote><p>åœ¨ <code>post-message-stream@^4.0.0</code> çš„å®˜æ–¹æè¿°ä¸­. è¿™ä¸ªåº“çš„ä½œç”¨æ˜¯åˆ›å»ºä¸€ä¸ªç”¨äºè·¨é¡µé¢æˆ–è€…çˆ¶çº§é¡µé¢å’Œ Web Worker é€šä¿¡çš„åŒå·¥å¯¹è±¡æµ. åœ¨æœ€æ–°çš„ç‰ˆæœ¬ä¸­å…¶å®å®ƒè¿˜æ”¯æŒ <code>nodejs</code> ä½†æ˜¯åœ¨ <code>metamask</code> ä¸­å…¶å®åªç”¨åˆ°äº† <code>^4.0.0</code> è¿™ä¸ªç‰ˆæœ¬. å› æ­¤è¿™é‡ŒæŒ‰ä¸‹ä¸è¡¨.</p><h3 id="ä¸¾ä¸ª-ğŸŒ°-1"><a href="#ä¸¾ä¸ª-ğŸŒ°-1" class="headerlink" title="ä¸¾ä¸ª ğŸŒ°"></a>ä¸¾ä¸ª ğŸŒ°</h3><p>åŸºäºåˆšåˆšçš„ <code>postMessage</code> ç¤ºä¾‹è¿›è¡Œæ”¹é€ , é¦–å…ˆå®‰è£…ä¾èµ–</p><ul><li>npm i @metamask&#x2F;post-message-stream@^4.0.0</li></ul><p>æ·»åŠ  <code>bar.html</code> å­é¡µé¢</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- sub-html/bar.html --&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Bar<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Bar Page<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;btn-send&quot;</span>&gt;</span>hi this is Bar Page<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;./bar.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åˆ›å»º <code>bar.js</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> $ <span class="keyword">from</span> <span class="string">&#x27;jquery&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">WindowPostMessageStream</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@metamask/post-message-stream&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ³¨æ„è¿™é‡Œçš„ name å’Œ target å’Œ index.js ä¸­çš„ä¸¤ä¸ªåŒåå­—æ®µæ˜¯åè¿‡æ¥çš„. ä»¥æ­¤æ¥å®ç°ä¸¤è€…çš„åŒå‘ç»‘å®š</span></span><br><span class="line"><span class="keyword">const</span> barStream = <span class="keyword">new</span> <span class="title class_">WindowPostMessageStream</span>(&#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;barStream&#x27;</span>,</span><br><span class="line">    <span class="attr">target</span>: <span class="string">&#x27;indexStream&#x27;</span>,</span><br><span class="line">    <span class="attr">targetWindow</span>: <span class="variable language_">window</span>.<span class="property">opener</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">barStream.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;<span class="built_in">Date</span>.now()&#125;</span> receive data via stream: `</span>, data)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">$(<span class="string">&#x27;#btn-send&#x27;</span>).<span class="title function_">on</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    barStream.<span class="title function_">write</span>(<span class="string">&#x27;hi this is Bar Page&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>ä¼˜åŒ– indexPage</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- index.html --&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Index<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Home Page<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;btn-open-foo&quot;</span>&gt;</span>open Foo<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;btn-open-bar&quot;</span>&gt;</span>open Bar<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;btn-hi-via-post-message&quot;</span>&gt;</span>hi this is Home via post message<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;btn-hi-via-stream&quot;</span>&gt;</span>hi this is Home via stream<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;./index.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> $ <span class="keyword">from</span> <span class="string">&#x27;jquery&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">WindowPostMessageStream</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@metamask/post-message-stream&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> fooPage</span><br><span class="line"><span class="keyword">let</span> barPage</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">registerBarStream</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> indexStream = <span class="keyword">new</span> <span class="title class_">WindowPostMessageStream</span>(&#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;indexStream&#x27;</span>,</span><br><span class="line">        <span class="attr">target</span>: <span class="string">&#x27;barStream&#x27;</span>,</span><br><span class="line">        <span class="attr">targetWindow</span>: barPage</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    indexStream.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;<span class="built_in">Date</span>.now()&#125;</span> receive data via stream: `</span>, data)</span><br><span class="line">    &#125;)</span><br><span class="line">    indexStream.<span class="title function_">write</span>(<span class="string">&#x27;before -----&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    $(<span class="string">&#x27;#btn-hi-via-stream&#x27;</span>).<span class="title function_">on</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        indexStream.<span class="title function_">write</span>(<span class="string">&#x27;hi this is Home via stream&#x27;</span>)</span><br><span class="line">        indexStream.<span class="title function_">write</span>(<span class="string">&#x27;hi this is Home via stream 2&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$(<span class="string">&#x27;#btn-open-foo&#x27;</span>).<span class="title function_">on</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    fooPage = <span class="variable language_">window</span>.<span class="title function_">open</span>(<span class="string">&#x27;/sub-html/foo.html&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">$(<span class="string">&#x27;#btn-open-bar&#x27;</span>).<span class="title function_">on</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    barPage = <span class="variable language_">window</span>.<span class="title function_">open</span>(<span class="string">&#x27;/sub-html/bar.html&#x27;</span>)</span><br><span class="line">    <span class="title function_">registerBarStream</span>()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">$(<span class="string">&#x27;#btn-hi-via-post-message&#x27;</span>).<span class="title function_">on</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (fooPage) &#123;</span><br><span class="line">        fooPage.<span class="title function_">postMessage</span>(<span class="string">&#x27;hi this is Home Page&#x27;</span>, <span class="string">&#x27;*&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// window.addEventListener(&#x27;message&#x27;, (&#123;data&#125;) =&gt; &#123;</span></span><br><span class="line"><span class="comment">//     console.log(`Current timestamp $&#123;Date.now()&#125; data: `, data)</span></span><br><span class="line"><span class="comment">// &#125;)</span></span><br></pre></td></tr></table></figure><p>PS: ç”±äº <code>post-message-stream</code> åº•å±‚ä¹Ÿä¼šç”¨åˆ° postMessage, ä¸ºäº†ä¸å½±å“æµ‹è¯•æ•ˆæœ. è¿™é‡ŒæŠŠ <code>index.js</code> ä¸­çš„ç›‘å¬ç§»é™¤äº†.</p><p>æœ€åä¿®æ”¹ <code>package.json</code>, åœ¨ script å‘½ä»¤ä¸­æ·»åŠ  bar.html å…¥å£â€¦</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;start&quot;: &quot;parcel index.html sub-html/foo.html sub-html/bar.html&quot;</span><br></pre></td></tr></table></figure><h3 id="è¿è¡Œç¤ºä¾‹ä»£ç -1"><a href="#è¿è¡Œç¤ºä¾‹ä»£ç -1" class="headerlink" title="è¿è¡Œç¤ºä¾‹ä»£ç "></a>è¿è¡Œç¤ºä¾‹ä»£ç </h3><p>ä¸Šè¿°ç¤ºä¾‹ä»£ç å‡å·²ä¸Šä¼  <a target="_blank" rel="noopener" href="https://github.com/luoquanquan/learn-fe/tree/post-message-stream-learn-v2/metamask-learn/post-message-stream-learn">github</a> ä»£ç è¿è¡Œçš„å·¥ä½œè¿‡ç¨‹å¦‚ä¸‹å›¾:</p><p><img src="https://handle-note-img.niubishanshan.top/post-message-stream.gif"></p><h2 id="æºç åˆ†æ"><a href="#æºç åˆ†æ" class="headerlink" title="æºç åˆ†æ"></a>æºç åˆ†æ</h2><p><a href="mailto:&#112;&#111;&#x73;&#x74;&#x2d;&#x6d;&#x65;&#x73;&#115;&#x61;&#103;&#x65;&#x2d;&#115;&#x74;&#114;&#x65;&#97;&#109;&#64;&#52;&#46;&#x30;&#x2e;&#48;">&#112;&#111;&#x73;&#x74;&#x2d;&#x6d;&#x65;&#x73;&#115;&#x61;&#103;&#x65;&#x2d;&#115;&#x74;&#114;&#x65;&#97;&#109;&#64;&#52;&#46;&#x30;&#x2e;&#48;</a> ç‰ˆæœ¬å¼•å…¥çš„ ts, å¯¹äºåŸºç¡€é€»è¾‘è¿›è¡Œäº†æ‹†åˆ†åœ¨ä¸€å®šç¨‹åº¦ä¸Šå°±é€ æˆäº†é˜…è¯»çš„å›°éš¾. é‰´äºæ­¤, ä¸‹æ–‡ä¸­æˆ‘ä»¬å…ˆå¯¹ v3 ç‰ˆæœ¬è§£æ, å†å¯¹ v4 ç‰ˆæœ¬è§£æ.</p><h3 id="post-message-stream-3"><a href="#post-message-stream-3" class="headerlink" title="post-message-stream@3"></a>post-message-stream@3</h3><p>ä»¥ä¸‹ä¸º post-message-stream@3 ç‰ˆæœ¬æ ¸å¿ƒæºç , åŒºåŒº 74 è¡Œä»£ç å°±å®ç°äº†ä¸€ä¸ªç¨³å®šçš„è·¨ç»ˆç«¯çš„åŒå·¥æµ.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿™ä¸ªåŒ…æ˜¯å¯¹ node stream æ¨¡å—çš„å°è£…</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">DuplexStream</span> = <span class="built_in">require</span>(<span class="string">&#x27;readable-stream&#x27;</span>).<span class="property">Duplex</span></span><br><span class="line"><span class="comment">// è¿™ä¸ªæ˜¯ node ç»§æ‰¿ç”¨çš„, è¿œå¤æ—¶æœŸæœ‰ä¸ªæ‰‹å†™åŸå‹ç»§æ‰¿çš„é¢è¯•é¢˜. å®ç°çš„å°±æ˜¯è¿™ä¸ª</span></span><br><span class="line"><span class="keyword">const</span> inherits = <span class="built_in">require</span>(<span class="string">&#x27;util&#x27;</span>).<span class="property">inherits</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">// ç®€å•çš„å®ç°å¤§æ¦‚å°±æ˜¯è¿™ä¸ªæ ·å­</span></span><br><span class="line"><span class="comment">function inherits(subCls, supCls) &#123;</span></span><br><span class="line"><span class="comment">    // å­ç±»åŸå‹ä¸ºçˆ¶ç±»å®ä¾‹, ç”¨äºç»§æ‰¿çˆ¶ç±»åŸå‹ä¸Šçš„æ–¹æ³•</span></span><br><span class="line"><span class="comment">    subCls.prototype = new supCls</span></span><br><span class="line"><span class="comment">    // æ„é€ å‡½æ•°ä¿®æ­£</span></span><br><span class="line"><span class="comment">    subCls.prototype.constructor = subCls</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">PostMessageStream</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">inherits</span>(<span class="title class_">PostMessageStream</span>, <span class="title class_">DuplexStream</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">PostMessageStream</span> (opts) &#123;</span><br><span class="line">  <span class="comment">// è¿™ä¸ªç»§æ‰¿, å¤ªç»å…¸äº†. å…·ä½“çš„çŸ¥è¯†ç‚¹å¿˜äº†å¯ä»¥çœ‹çœ‹è¿™é‡Œ</span></span><br><span class="line">  <span class="comment">// https://weread.qq.com/web/reader/751326d0720befab7514782k0723244023c072b030ba601</span></span><br><span class="line">  <span class="title class_">DuplexStream</span>.<span class="title function_">call</span>(<span class="variable language_">this</span>, &#123;</span><br><span class="line">    <span class="comment">// é»˜è®¤æƒ…å†µä¸‹ objectMode ä¸º false, æˆ‘ä»¬åªå¯ä»¥ç»™æµé‡Œè¾¹å†™å…¥å­—ç¬¦ä¸², Buffer æˆ– Uint8Array.</span></span><br><span class="line">    <span class="comment">// å¦‚æœç›´æ¥æ€¼ä¸€ä¸ª object è¿›å», å˜, æŠ¥é”™äº†...</span></span><br><span class="line">    <span class="comment">// Uncaught TypeError: Invalid non-string/buffer chunk</span></span><br><span class="line">    <span class="comment">// æ‰€ä»¥éœ€è¦æŒ‡å®š objectMode ä¸º true æ¥å…è®¸æˆ‘ä»¬åœ¨ä¸åŒç»ˆç«¯é—´ä¼ é€’ object</span></span><br><span class="line">    <span class="attr">objectMode</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// åˆå§‹åŒ–å‚æ•°</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_name</span> = opts.<span class="property">name</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_target</span> = opts.<span class="property">target</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_targetWindow</span> = opts.<span class="property">targetWindow</span> || <span class="variable language_">window</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_origin</span> = (opts.<span class="property">targetWindow</span> ? <span class="string">&#x27;*&#x27;</span> : location.<span class="property">origin</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// initialization flags</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_init</span> = <span class="literal">false</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_haveSyn</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;message&#x27;</span>, <span class="variable language_">this</span>.<span class="property">_onMessage</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>), <span class="literal">false</span>)</span><br><span class="line">  <span class="comment">// send syncorization message</span></span><br><span class="line">  <span class="comment">// å‘é€æ¡æ‰‹åŒ…</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">_write</span>(<span class="string">&#x27;SYN&#x27;</span>, <span class="literal">null</span>, noop)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç»§æ‰¿è‡ª Duplex, è°ƒç”¨æ­¤æ–¹æ³•ååˆ°è°ƒç”¨ this.uncork()</span></span><br><span class="line">  <span class="comment">// ä¹‹å‰å†™å…¥æµä¸­çš„æ•°æ®å°†ä¼šä¿å­˜è‡³ç¼“å†²åŒºè€Œä¸ä¼šç›´æ¥æä¾›ç»™ä¸‹æ¸¸æ¶ˆè´¹.</span></span><br><span class="line">  <span class="comment">// ç›´åˆ°è°ƒç”¨ this.uncork(); æ‰ä¼šä»ç¼“å†²åŒºæ‹¿å‡ºä¹‹å‰å†™å…¥çš„æ‰€æœ‰æ•°æ®ç»™åˆ°ä¸‹æ¸¸</span></span><br><span class="line">  <span class="comment">// åœ¨å‰æ–‡ç¤ºä¾‹ä¸­, å¦‚æœ indexPage æ¯”è¾ƒçŒ´æ€¥, æ‰“å¼€ bar é¡µé¢åæ²¡ç­‰æ¡æ‰‹å®Œæˆç›´æ¥å‘æ•°æ®è¿‡æ¥</span></span><br><span class="line">  <span class="comment">// å°±ä¼šå†™å…¥åˆ°ç¼“å†²åŒºå¾…ç”¨äº†</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">cork</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// private</span></span><br><span class="line"><span class="title class_">PostMessageStream</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_onMessage</span> = <span class="keyword">function</span> (<span class="params">event</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> msg = event.<span class="property">data</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// validate message</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">_origin</span> !== <span class="string">&#x27;*&#x27;</span> &amp;&amp; event.<span class="property">origin</span> !== <span class="variable language_">this</span>.<span class="property">_origin</span>) <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">if</span> (event.<span class="property">source</span> !== <span class="variable language_">this</span>.<span class="property">_targetWindow</span>) <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> msg !== <span class="string">&#x27;object&#x27;</span>) <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">if</span> (msg.<span class="property">target</span> !== <span class="variable language_">this</span>.<span class="property">_name</span>) <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">if</span> (!msg.<span class="property">data</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// å¦‚æœå½“å‰ç»ˆç«¯è¿˜æ²¡æœ‰åˆå§‹åŒ–, å…ˆè¿›è¡Œåˆå§‹åŒ–</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">_init</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿™ä¸ªä¸‰æ¬¡æ¡æ‰‹çš„è¿‡ç¨‹æœ‰ç‚¹ç±»ä¼¼ tcp ä¸‰æ¬¡æ¡æ‰‹çš„è¿‡ç¨‹, å…·ä½“çš„æ—¶åºå›¾åœ¨ä¸‹æ–‡</span></span><br><span class="line">    <span class="keyword">if</span> (msg.<span class="property">data</span> === <span class="string">&#x27;SYN&#x27;</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_haveSyn</span> = <span class="literal">true</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">_write</span>(<span class="string">&#x27;ACK&#x27;</span>, <span class="literal">null</span>, noop)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (msg.<span class="property">data</span> === <span class="string">&#x27;ACK&#x27;</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_init</span> = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">_haveSyn</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">_write</span>(<span class="string">&#x27;ACK&#x27;</span>, <span class="literal">null</span>, noop)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">uncork</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">//  å¦‚æœå½“å‰ç»ˆç«¯å·²ç»å®Œæˆåˆå§‹åŒ–, æ¥å—æ•°æ®å¹¶å¤„ç†</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// forward message</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">push</span>(msg.<span class="property">data</span>)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// stream plumbing</span></span><br><span class="line"><span class="comment">// Readable æµå®ç°éƒ½å¿…é¡»æä¾›</span></span><br><span class="line"><span class="comment">// Duplex ä¸ºåŒå·¥æµå¯è¯»å¯å†™, æ‰€ä»¥ä¹Ÿå¿…é¡»å®ç°</span></span><br><span class="line"><span class="comment">// ä¸»è¦ç”¨äºå¤„ç†å¯è¯»æµçš„è¯»å–æ“ä½œçš„åº•å±‚é€»è¾‘</span></span><br><span class="line"><span class="title class_">PostMessageStream</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_read</span> = noop</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‘æµä¸­å†™å…¥å†…å®¹çš„åº•å±‚å¤„ç†, å®è´¨ä¸Šå°±æ˜¯è°ƒç”¨äº† window.postMessage å‘Šè¯‰å¯¹æ–¹</span></span><br><span class="line"><span class="title class_">PostMessageStream</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_write</span> = <span class="keyword">function</span> (<span class="params">data, encoding, cb</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> message = &#123;</span><br><span class="line">    <span class="attr">target</span>: <span class="variable language_">this</span>.<span class="property">_target</span>,</span><br><span class="line">    <span class="attr">data</span>: data,</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_targetWindow</span>.<span class="title function_">postMessage</span>(message, <span class="variable language_">this</span>.<span class="property">_origin</span>)</span><br><span class="line">  <span class="title function_">cb</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// util</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">noop</span> () &#123;&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­, æ¡æ‰‹çš„è¿‡ç¨‹æ—¶åºå›¾å¦‚ä¸‹:<br><img src="https://handle-note-img.niubishanshan.top/20220927114850.png" alt="20220927114850"></p><h3 id="post-message-stream-4"><a href="#post-message-stream-4" class="headerlink" title="post-message-stream@4"></a>post-message-stream@4</h3><p>ä»¥ä¸‹ä¸º post-message-stream@4 ä»£ç , ç›¸å¯¹äº v3 çš„ä¸»è¦åŒºåˆ«æ˜¯ä¸ºäº†é€‚é…æ›´å¤šçš„ç¯å¢ƒ (node, webWorker) å¯¹äºæ¡æ‰‹å’Œæ•°æ®å¤„ç†æ¨¡å—åšäº†æ›´æ·±ç¨‹åº¦çš„æŠ½è±¡.</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BasePostMessageStream.ts</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Nodejs åŒå·¥æµç±»</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Duplex</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;readable-stream&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç©ºå‡½æ•°ä½œä¸ºå›è°ƒé»˜è®¤å€¼</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">noop</span>(<span class="params"></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">undefined</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¡æ‰‹åŒ…åç§°</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">SYN</span> = <span class="string">&#x27;SYN&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">ACK</span> = <span class="string">&#x27;ACK&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">StreamData</span> = <span class="built_in">string</span> | <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">unknown</span>&gt;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">PostMessageEvent</span> &#123;</span><br><span class="line">  data?: <span class="title class_">StreamData</span>;</span><br><span class="line">  <span class="attr">origin</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">source</span>: <span class="keyword">typeof</span> <span class="variable language_">window</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Abstract base class for postMessage streams.</span></span><br><span class="line"><span class="comment"> * ä»–è¯´è¿™æ˜¯ä¸ªæŠ½è±¡ç±». æ„æ€æ˜¯ä½ ä¸èƒ½å®ä¾‹åŒ–å®ƒ, è¦å®ä¾‹åŒ–å®ƒçš„å­ç±»</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">BasePostMessageStream</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Duplex</span> &#123;</span><br><span class="line">  <span class="comment">// æ˜¯å¦åˆå§‹åŒ–</span></span><br><span class="line">  <span class="keyword">private</span> <span class="attr">_init</span>: <span class="built_in">boolean</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ˜¯å¦å·²ç»æ¥å—/å‘å‡ºè¿‡æ¡æ‰‹åŒ…</span></span><br><span class="line">  <span class="keyword">private</span> <span class="attr">_haveSyn</span>: <span class="built_in">boolean</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(&#123;</span><br><span class="line">      <span class="attr">objectMode</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialization flags</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_init</span> = <span class="literal">false</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_haveSyn</span> = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Must be called at end of child constructor to initiate</span></span><br><span class="line"><span class="comment">   * communication with other end.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * å­ç±»åˆå§‹åŒ–æ—¶å€™è°ƒç”¨çš„, å¼€å§‹æ¡æ‰‹çš„æ–¹æ³•</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="title function_">_handshake</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="comment">// Send synchronization message</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">_write</span>(<span class="variable constant_">SYN</span>, <span class="literal">null</span>, noop);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">cork</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ”¶åˆ°å…¶ä»–ç»ˆç«¯å‘æ¥çš„æ•°æ®å¤„ç†</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="title function_">_onData</span>(<span class="attr">data</span>: <span class="title class_">StreamData</span>): <span class="built_in">void</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">_init</span>) &#123;</span><br><span class="line">      <span class="comment">// Forward message</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">push</span>(data);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, err);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (data === <span class="variable constant_">SYN</span>) &#123;</span><br><span class="line">      <span class="comment">// Listen for handshake</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_haveSyn</span> = <span class="literal">true</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">_write</span>(<span class="variable constant_">ACK</span>, <span class="literal">null</span>, noop);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (data === <span class="variable constant_">ACK</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_init</span> = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">_haveSyn</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">_write</span>(<span class="variable constant_">ACK</span>, <span class="literal">null</span>, noop);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">uncork</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Child classes must implement this function.</span></span><br><span class="line"><span class="comment">   * æŠ½è±¡æ–¹æ³•, ä¸åŒçš„ runtime å®ç°çš„æ–¹å¼ä¸åŒ</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="title function_">_postMessage</span>(_data?: <span class="built_in">unknown</span>): <span class="built_in">void</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">_read</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">undefined</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Duplex</span></span><br><span class="line">  <span class="comment">// å‘é€æ•°æ® or æ¡æ‰‹åŒ… Duplex æµä¸­è°ƒç”¨ write æ—¶è§¦å‘çš„åº•å±‚é€»è¾‘</span></span><br><span class="line">  <span class="title function_">_write</span>(<span class="attr">data</span>: <span class="title class_">StreamData</span>, <span class="attr">_encoding</span>: <span class="built_in">string</span> | <span class="literal">null</span>, <span class="attr">cb</span>: <span class="function">() =&gt;</span> <span class="built_in">void</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">_postMessage</span>(data);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨å›è°ƒè¡¨ç¤ºå†™å…¥é€»è¾‘å¤„ç†å®Œæˆ</span></span><br><span class="line">    <span class="title function_">cb</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WindowPostMessageStream.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  <span class="title class_">BasePostMessageStream</span>,</span><br><span class="line">  <span class="title class_">PostMessageEvent</span>,</span><br><span class="line">  <span class="title class_">StreamData</span>,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;./BasePostMessageStream&#x27;</span>;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">WindowPostMessageStreamArgs</span> &#123;</span><br><span class="line">  <span class="attr">name</span>: string;</span><br><span class="line">  <span class="attr">target</span>: string;</span><br><span class="line">  targetWindow?: <span class="title class_">Window</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Window.postMessage stream.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">WindowPostMessageStream</span> <span class="keyword">extends</span> <span class="title class_ inherited__">BasePostMessageStream</span> &#123;</span><br><span class="line">  <span class="comment">// å½“å‰æµåç§°</span></span><br><span class="line">  private <span class="attr">_name</span>: string;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç›®æ ‡æµåç§°</span></span><br><span class="line">  private <span class="attr">_target</span>: string;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç›®æ ‡é¡µé¢æ‰€åœ¨çš„åŸŸå</span></span><br><span class="line">  private <span class="attr">_targetOrigin</span>: string;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç›®æ ‡é¡µé¢ window å¯¹è±¡ (åŸºäº _targetWindow.postMessage)</span></span><br><span class="line">  private <span class="attr">_targetWindow</span>: <span class="title class_">Window</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Creates a stream for communicating with other streams across the same or</span></span><br><span class="line"><span class="comment">   * different window objects.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> args.name - The name of the stream. Used to differentiate between</span></span><br><span class="line"><span class="comment">   * multiple streams sharing the same window object.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> args.target - The name of the stream to exchange messages with.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> args.targetWindow - The window object of the target stream. Defaults</span></span><br><span class="line"><span class="comment">   * to `window`.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">&#123; name, target, targetWindow &#125;: WindowPostMessageStreamArgs</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!name || !target) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Invalid input.&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">super</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‚æ•°åˆå§‹åŒ–</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_name</span> = name;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_target</span> = target;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_targetOrigin</span> = targetWindow ? <span class="string">&#x27;*&#x27;</span> : location.<span class="property">origin</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_targetWindow</span> = targetWindow || <span class="variable language_">window</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_onMessage</span> = <span class="variable language_">this</span>.<span class="property">_onMessage</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;message&#x27;</span>, <span class="variable language_">this</span>.<span class="property">_onMessage</span> <span class="keyword">as</span> any, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‘èµ·æ¡æ‰‹è¯·æ±‚</span></span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªç»ˆç«¯, æ¡æ‰‹è¯·æ±‚ä¼šè¢«åºŸå¼ƒ</span></span><br><span class="line">    <span class="comment">// å¦‚æœæ˜¯ç¬¬äºŒä¸ªç»ˆç«¯, æ¡æ‰‹è¯·æ±‚ä¼šè¢«ç¬¬ä¸€ä¸ªç»ˆç«¯æ¥æ”¶åˆ°</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">_handshake</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å‘é€æ•°æ®, å®é™…å°±æ˜¯è°ƒç”¨ window.postMessage</span></span><br><span class="line">  protected <span class="title function_">_postMessage</span>(<span class="attr">data</span>: unknown): <span class="keyword">void</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_targetWindow</span>.<span class="title function_">postMessage</span>(</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">target</span>: <span class="variable language_">this</span>.<span class="property">_target</span>,</span><br><span class="line">        data,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_targetOrigin</span>,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ¥æ”¶ä¿¡æ¯</span></span><br><span class="line">  private <span class="title function_">_onMessage</span>(<span class="attr">event</span>: <span class="title class_">PostMessageEvent</span>): <span class="keyword">void</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> message = event.<span class="property">data</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// validate message</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      (<span class="variable language_">this</span>.<span class="property">_targetOrigin</span> !== <span class="string">&#x27;*&#x27;</span> &amp;&amp; event.<span class="property">origin</span> !== <span class="variable language_">this</span>.<span class="property">_targetOrigin</span>) ||</span><br><span class="line">      event.<span class="property">source</span> !== <span class="variable language_">this</span>.<span class="property">_targetWindow</span> ||</span><br><span class="line">      <span class="keyword">typeof</span> message !== <span class="string">&#x27;object&#x27;</span> ||</span><br><span class="line">      message.<span class="property">target</span> !== <span class="variable language_">this</span>.<span class="property">_name</span> ||</span><br><span class="line">      !message.<span class="property">data</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨çˆ¶ç±»å®šä¹‰çš„ _onData å¤„ç†æ•°æ®</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">_onData</span>(message.<span class="property">data</span> <span class="keyword">as</span> <span class="title class_">StreamData</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// destroy æ–¹æ³•çš„åº•å±‚å®ç°</span></span><br><span class="line">  <span class="title function_">_destroy</span>(): <span class="keyword">void</span> &#123;</span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">removeEventListener</span>(<span class="string">&#x27;message&#x27;</span>, <span class="variable language_">this</span>.<span class="property">_onMessage</span> <span class="keyword">as</span> any, <span class="literal">false</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="cork-amp-uncork"><a href="#cork-amp-uncork" class="headerlink" title="cork &amp; uncork"></a>cork &amp; uncork</h3><blockquote><p>åœ¨å‘æµä¸­å†™å…¥å¤§é‡å°å—æ•°æ®ï¼ˆsmall chunks of dataï¼‰æ—¶ï¼Œå†…éƒ¨ç¼“å†²åŒºï¼ˆinternal bufferï¼‰å¯èƒ½å¤±æ•ˆï¼Œä»è€Œå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚writable.cork() æ–¹æ³•ä¸»è¦å°±æ˜¯ç”¨æ¥é¿å…è¿™ç§æƒ…å†µã€‚</p></blockquote><p>å¯¹äºè¿™æ®µæˆ‘çš„ç†è§£æ˜¯, æ¯ä¸ªå¯å†™æµä¼šæœ‰ä¸€ä¸ªå†…éƒ¨ç¼“å†²åŒº. å½“æˆ‘ä»¬å“å“§å“å“§ç»™å†…éƒ¨ç¼“å†²åŒºå†™å°å—å„¿çš„ä¸œè¥¿ç»™å®ƒæ€¼æ»¡äº†, å°±ä¼šå¯¼è‡´å…¶å¤±æ•ˆ. æ‰€ä»¥å½“æˆ‘ä»¬éœ€è¦é¢‘ç¹å†™å…¥å°å—å†…å®¹æ—¶. å¯ä»¥å…ˆè°ƒç”¨ writable.cork å¼ºåˆ¶å°† writable.write çš„å†…å®¹å†™å…¥åˆ°å†…å­˜ä¸­. ç­‰æ‰¹é‡å°å—å„¿å†…å®¹å†™å…¥å®Œæˆå†è°ƒç”¨ writable.uncork ç»Ÿä¸€é‡Šæ”¾å‡ºæ¥.</p><p>ç¤ºä¾‹ä»£ç :</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">Writable</span> &#125; = <span class="built_in">require</span>(<span class="string">&#x27;stream&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyWritableStream</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Writable</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">_write</span>(<span class="params">data, _encoding, next</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(data.<span class="title function_">toString</span>())</span><br><span class="line">        <span class="title function_">next</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> myWritableStream = <span class="keyword">new</span> <span class="title class_">MyWritableStream</span>()</span><br><span class="line"></span><br><span class="line">myWritableStream.<span class="title function_">write</span>(<span class="string">&#x27;hello world ~&#x27;</span>)</span><br><span class="line">myWritableStream.<span class="title function_">write</span>(<span class="string">&#x27;hello world 2 ~&#x27;</span>)</span><br><span class="line">myWritableStream.<span class="title function_">write</span>(<span class="string">&#x27;hello world 3 ~&#x27;</span>)</span><br><span class="line">myWritableStream.<span class="title function_">write</span>(<span class="string">&#x27;hello world 4 ~&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ§åˆ¶å°è¾“å‡º:</span></span><br><span class="line"><span class="comment">// hello world ~</span></span><br><span class="line"><span class="comment">// hello world 2 ~</span></span><br><span class="line"><span class="comment">// hello world 3 ~</span></span><br><span class="line"><span class="comment">// hello world 4 ~</span></span><br></pre></td></tr></table></figure><p>æ‰§è¡Œä¸Šè¿°ä»£ç , æ‰€æœ‰çš„ <code>hello world</code> éƒ½ä¼šæ‰“å°å‡ºæ¥, ä½†æ˜¯å¦‚æœç¨ä½œä¿®æ”¹æ”¹ä¸ºä»¥ä¸‹ä»£ç .</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">Writable</span> &#125; = <span class="built_in">require</span>(<span class="string">&#x27;stream&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyWritableStream</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Writable</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">_write</span>(<span class="params">data, _encoding, next</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(data.<span class="title function_">toString</span>())</span><br><span class="line">        <span class="title function_">next</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> myWritableStream = <span class="keyword">new</span> <span class="title class_">MyWritableStream</span>()</span><br><span class="line"></span><br><span class="line">myWritableStream.<span class="title function_">write</span>(<span class="string">&#x27;hello world ~&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ++++++++++++++++++</span></span><br><span class="line">myWritableStream.<span class="title function_">cork</span>()</span><br><span class="line"><span class="comment">// ++++++++++++++++++</span></span><br><span class="line"></span><br><span class="line">myWritableStream.<span class="title function_">write</span>(<span class="string">&#x27;hello world 2 ~&#x27;</span>)</span><br><span class="line">myWritableStream.<span class="title function_">write</span>(<span class="string">&#x27;hello world 3 ~&#x27;</span>)</span><br><span class="line">myWritableStream.<span class="title function_">write</span>(<span class="string">&#x27;hello world 4 ~&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ§åˆ¶å°è¾“å‡º:</span></span><br><span class="line"><span class="comment">// hello world ~</span></span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ä¾¿åªä¼šæ‰“å°å‡º <code>hello world ~</code> åè¾¹ä¸‰ä¸ªä¸ä¼šæ‰“å°, å› ä¸º <code>myWritableStream.cork()</code> ä¹‹åå†™å…¥æµçš„å†…å®¹è¢«å¼ºåˆ¶å†™å…¥åˆ°äº†å†…å­˜ä¸­æ²¡æœ‰é‡Šæ”¾. å†æ¬¡ä¿®æ”¹ä»£ç , å†æœ€ååŠ ä¸Š <code>myWritableStream.uncork()</code> å³å¯é‡Šæ”¾ <code>myWritableStream.cork()</code> ä¹‹åå†™å…¥çš„æ•°æ®å—.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">Writable</span> &#125; = <span class="built_in">require</span>(<span class="string">&#x27;stream&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyWritableStream</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Writable</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">_write</span>(<span class="params">data, _encoding, next</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(data.<span class="title function_">toString</span>())</span><br><span class="line">        <span class="title function_">next</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> myWritableStream = <span class="keyword">new</span> <span class="title class_">MyWritableStream</span>()</span><br><span class="line"></span><br><span class="line">myWritableStream.<span class="title function_">write</span>(<span class="string">&#x27;hello world ~&#x27;</span>)</span><br><span class="line"></span><br><span class="line">myWritableStream.<span class="title function_">cork</span>()</span><br><span class="line"></span><br><span class="line">myWritableStream.<span class="title function_">write</span>(<span class="string">&#x27;hello world 2 ~&#x27;</span>)</span><br><span class="line">myWritableStream.<span class="title function_">write</span>(<span class="string">&#x27;hello world 3 ~&#x27;</span>)</span><br><span class="line">myWritableStream.<span class="title function_">write</span>(<span class="string">&#x27;hello world 4 ~&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ++++++++++++++++++</span></span><br><span class="line">myWritableStream.<span class="title function_">uncork</span>()</span><br><span class="line"><span class="comment">// ++++++++++++++++++</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ§åˆ¶å°è¾“å‡º:</span></span><br><span class="line"><span class="comment">// hello world ~</span></span><br><span class="line"><span class="comment">// hello world 2 ~</span></span><br><span class="line"><span class="comment">// hello world 3 ~</span></span><br><span class="line"><span class="comment">// hello world 4 ~</span></span><br></pre></td></tr></table></figure><h2 id="æ€è€ƒ"><a href="#æ€è€ƒ" class="headerlink" title="æ€è€ƒ"></a>æ€è€ƒ</h2><p>ä¹Ÿç®—æ˜¯ç†Ÿè¯»äº†è¿™å—çš„æºç è¿˜æ˜¯æœ‰äº›ç–‘æƒ‘, å•çº¯ç”¨ postMessage åº”è¯¥æ˜¯å¯ä»¥æ»¡è¶³å°ç‹ç‹¸é’±åŒ…ç›¸å…³çš„æ•°æ®é€šä¿¡çš„. ä½¿ç”¨åŒå·¥æµçš„ä¼˜åŠ¿:</p><ol><li>å¤„ç†å¤§è§„æ¨¡æ•°æ®æ—¶ä¸ä¼šå‡ºç°å†…å­˜ç“¶é¢ˆ</li><li>cork &#x2F; uncork ä¿è¯äº†ä¸»è¿›ç¨‹åœ¨å­è¿›ç¨‹åˆå§‹åŒ–å®Œæˆå‰å°±å‘é€æ•°æ®çš„å®Œæ•´æ€§</li></ol><p>ä½†æ˜¯è¿™ä¸¤ä¸ªä¼˜ç‚¹ postMessage + éƒ¨åˆ†é€»è¾‘ä¹Ÿå¯ä»¥æå®š, æƒ³ä¸é€šä½œè€…ä¸ºå•¥è¿™ä¹ˆç”¨. è€Œä¸”æ ¹æ®è€ƒå¤ 7 å¹´å‰(ä¹Ÿå°±æ˜¯å°ç‹ç‹¸é¡¹ç›®åˆæœŸ)çš„ <a target="_blank" rel="noopener" href="https://github.com/MetaMask/metamask-extension/commit/72a747165dda417aa7968e44b404eb90707202a2">è¿™æ¬¡æäº¤</a> ä½œè€…å‡çº§äº† web3(0.9.2 -&gt; 0.15.1) åŒæ—¶é€šä¿¡æœºåˆ¶ä» <code>postMessage</code> åˆ‡æ¢åˆ°äº† <code>post-message-stream</code> ä½†æ˜¯ä¸çŸ¥ä¸¤è€…æ˜¯å¦æœ‰å…³è” ğŸ¤”</p><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li><a target="_blank" rel="noopener" href="https://zh.parceljs.org/">parcel å®˜æ–¹æ–‡æ¡£</a></li><li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage">postMessage</a></li><li><a target="_blank" rel="noopener" href="https://github.com/MetaMask/post-message-stream">post-message-stream</a></li><li><a target="_blank" rel="noopener" href="http://nodejs.cn/api-v12/stream.html#stream_class_stream_duplex">Duplex ç±»</a></li><li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/49317685/read-is-not-implemented-on-readable-stream">_read() is not implemented on Readable stream</a></li><li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/36728655">Node.js æµï¼ˆstreamï¼‰ï¼šä½ éœ€è¦çŸ¥é“çš„ä¸€åˆ‡</a></li><li><a target="_blank" rel="noopener" href="https://tech.meituan.com/2016/07/08/stream-basics.html">Node.js Stream - åŸºç¡€ç¯‡</a></li><li><a target="_blank" rel="noopener" href="https://www.tutorialspoint.com/stream-writable-cork-and-uncork-method-in-node-js">Stream writable.cork() and uncork() Method in Node.js</a></li><li><a target="_blank" rel="noopener" href="https://xiaohuochai.site/BE/node/file/stream.html">æ•°æ®æµstream</a></li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/" rel="tag"># å¼€å‘ç¬”è®°</a></div><div class="post-nav"><div class="post-nav-item"><a href="/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/MetaMask-%E6%BA%90%E7%A0%81/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/MetaMask%20%E6%BA%90%E7%A0%81/%E5%89%8D%E8%A8%80/" rel="prev" title="å‰è¨€"><i class="fa fa-chevron-left"></i> å‰è¨€</a></div><div class="post-nav-item"> <a href="/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/%E5%B7%A5%E5%85%B7/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/%E5%B7%A5%E5%85%B7/github%20hosts%20%E5%8F%98%E5%BF%AB/" rel="next" title="github hosts å˜å¿«">github hosts å˜å¿«<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div><script>
  window.addEventListener('tabs:register', function() {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> æ–‡ç« ç›®å½•</li><li class="sidebar-nav-overview"> ç«™ç‚¹æ¦‚è§ˆ</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A6%96%E5%85%88%E6%83%B3%E5%88%B0-postMessage"><span class="nav-text">é¦–å…ˆæƒ³åˆ° postMessage</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BE%E4%B8%AA-%F0%9F%8C%B0"><span class="nav-text">ä¸¾ä¸ª ğŸŒ°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E7%A4%BA%E4%BE%8B%E4%BB%A3%E7%A0%81"><span class="nav-text">è¿è¡Œç¤ºä¾‹ä»£ç </span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B0%8F%E7%8B%90%E7%8B%B8%E4%BE%9D%E8%B5%96-post-message-stream-4-0-0"><span class="nav-text">å°ç‹ç‹¸ä¾èµ– post-message-stream@^4.0.0</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BE%E4%B8%AA-%F0%9F%8C%B0-1"><span class="nav-text">ä¸¾ä¸ª ğŸŒ°</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E7%A4%BA%E4%BE%8B%E4%BB%A3%E7%A0%81-1"><span class="nav-text">è¿è¡Œç¤ºä¾‹ä»£ç </span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-text">æºç åˆ†æ</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#post-message-stream-3"><span class="nav-text">post-message-stream@3</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#post-message-stream-4"><span class="nav-text">post-message-stream@4</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#cork-amp-uncork"><span class="nav-text">cork &amp; uncork</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%9D%E8%80%83"><span class="nav-text">æ€è€ƒ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-text">å‚è€ƒèµ„æ–™</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="åœˆåœˆçš„åœˆ" src="/images/avatar.png"><p class="site-author-name" itemprop="name">åœˆåœˆçš„åœˆ</p><div class="site-description" itemprop="description">æŠ€æœ¯å­¦ä¹ , è¯»ä¹¦ç¬”è®°, ç”Ÿæ´»æ„Ÿæ‚Ÿ ~</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">142</span> <span class="site-state-item-name">æ—¥å¿—</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">35</span> <span class="site-state-item-name">åˆ†ç±»</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">8</span> <span class="site-state-item-name">æ ‡ç­¾</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://juejin.im/user/5837c2bd61ff4b006ca8d1b2" title="æ˜é‡‘ â†’ https:&#x2F;&#x2F;juejin.im&#x2F;user&#x2F;5837c2bd61ff4b006ca8d1b2" rel="noopener" target="_blank"><i class="fa fa-fw fa-stack-overflow"></i> æ˜é‡‘</a></span><span class="links-of-author-item"><a href="https://github.com/luoquanquan" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;luoquanquan" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:luo_quanquan@163.com" title="E-Mail â†’ mailto:luo_quanquan@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="beian"><a href="http://www.beian.miit.gov.cn/" rel="noopener" target="_blank">äº¬ICPå¤‡17034706å·-1</a></div><div class="copyright"> &copy; <span itemprop="copyrightYear">2024</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">åœˆåœˆçš„åœˆ</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="æ€»è®¿å®¢é‡"><span id="busuanzi_value_site_uv"></span></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="æ€»è®¿é—®é‡"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer></div><script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/js/theme-next-canvas-nest/canvas-nest.min.js"></script><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script></body></html>
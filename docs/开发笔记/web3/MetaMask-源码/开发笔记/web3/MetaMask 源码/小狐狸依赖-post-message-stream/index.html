<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:new URL("http://note.niubishanshan.top").hostname,root:"/",scheme:"Gemini",version:"7.7.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!1,show_result:!1,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{appID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},path:"search.json",motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta name="description" content="阅读 metamask 的 package.json 的过程中, 第一个吸引我注意的 npm 包就是 post-message-stream. 无它, 唯眼熟尔.  首先想到 postMessage 一个窗口可以获得对另一个窗口的引用 (比如 targetWindow &#x3D; window.opener), 然后在窗口上调用 targetWindow.postMessage() 方法分发一"><meta property="og:type" content="article"><meta property="og:title" content="小狐狸依赖-post-message-stream"><meta property="og:url" content="http://note.niubishanshan.top/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/MetaMask-%E6%BA%90%E7%A0%81/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/MetaMask%20%E6%BA%90%E7%A0%81/%E5%B0%8F%E7%8B%90%E7%8B%B8%E4%BE%9D%E8%B5%96-post-message-stream/index.html"><meta property="og:site_name" content="圈圈的笔记"><meta property="og:description" content="阅读 metamask 的 package.json 的过程中, 第一个吸引我注意的 npm 包就是 post-message-stream. 无它, 唯眼熟尔.  首先想到 postMessage 一个窗口可以获得对另一个窗口的引用 (比如 targetWindow &#x3D; window.opener), 然后在窗口上调用 targetWindow.postMessage() 方法分发一"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://handle-note-img.niubishanshan.top/post-message.gif"><meta property="og:image" content="https://handle-note-img.niubishanshan.top/post-message-stream.gif"><meta property="og:image" content="https://handle-note-img.niubishanshan.top/20220927114850.png"><meta property="article:published_time" content="2022-09-26T03:23:10.000Z"><meta property="article:modified_time" content="2024-06-27T15:04:43.291Z"><meta property="article:author" content="圈圈的圈"><meta property="article:tag" content="开发笔记"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://handle-note-img.niubishanshan.top/post-message.gif"><link rel="canonical" href="http://note.niubishanshan.top/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/MetaMask-%E6%BA%90%E7%A0%81/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/MetaMask%20%E6%BA%90%E7%A0%81/%E5%B0%8F%E7%8B%90%E7%8B%B8%E4%BE%9D%E8%B5%96-post-message-stream/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0}</script><title>小狐狸依赖-post-message-stream | 圈圈的笔记</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div> <a target="_blank" rel="noopener" href="https://github.com/luoquanquan" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">圈圈的笔记</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">路漫漫其修远兮, 吾将上下而求索</p></div><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i> 首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i> 归档</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i> 关于</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="site-search"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="搜索..." spellcheck="false" type="text" id="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"></div></div><div class="search-pop-overlay"></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://note.niubishanshan.top/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/MetaMask-%E6%BA%90%E7%A0%81/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/MetaMask%20%E6%BA%90%E7%A0%81/%E5%B0%8F%E7%8B%90%E7%8B%B8%E4%BE%9D%E8%B5%96-post-message-stream/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.png"><meta itemprop="name" content="圈圈的圈"><meta itemprop="description" content="技术学习, 读书笔记, 生活感悟 ~"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="圈圈的笔记"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> 小狐狸依赖-post-message-stream</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-09-26 11:23:10" itemprop="dateCreated datePublished" datetime="2022-09-26T11:23:10+08:00">2022-09-26</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2024-06-27 23:04:43" itemprop="dateModified" datetime="2024-06-27T23:04:43+08:00">2024-06-27</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">开发笔记</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/" itemprop="url" rel="index"><span itemprop="name">web3</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/MetaMask-%E6%BA%90%E7%A0%81/" itemprop="url" rel="index"><span itemprop="name">MetaMask 源码</span></a></span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>阅读 metamask 的 package.json 的过程中, 第一个吸引我注意的 npm 包就是 post-message-stream. 无它, 唯眼熟尔.</p></blockquote><h2 id="首先想到-postMessage"><a href="#首先想到-postMessage" class="headerlink" title="首先想到 postMessage"></a>首先想到 <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage">postMessage</a></h2><blockquote><p>一个窗口可以获得对另一个窗口的引用 (比如 targetWindow &#x3D; window.opener), 然后在窗口上调用 targetWindow.postMessage() 方法分发一个 MessageEvent 消息. 接收消息的窗口可以根据需要自由处理此事件 (en-US). 传递给 window.postMessage() 的参数(比如 message)将通过消息事件对象暴露给接收消息的窗口</p></blockquote><p>简单的说, 你首先打开一个页面 <code>index</code>, 然后在这个页面通过 <code>window.open()</code> 打开一个子页面, 此时就能通过 <code>postMessage</code> 实现两个父子页面之间的通信. <code>此外postMessage</code> 还常用于 <code>webWorker</code> 和主进程之间的通信.</p><span id="more"></span><h3 id="举个-🌰"><a href="#举个-🌰" class="headerlink" title="举个 🌰"></a>举个 🌰</h3><p>为了便于理解, 我搞了个测试项目用于, 笔记好记性不如烂笔头子.</p><p>首先, 你有一个 <code>index.html</code> 作为父级页面</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- index.html --&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Index<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Home Page<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;btn-open-foo&quot;</span>&gt;</span>open Foo<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;btn-hi-via-post-message&quot;</span>&gt;</span>hi this is Home via post message<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;./index.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>父级页面中引入的 js 文件为</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> $ <span class="keyword">from</span> <span class="string">&#x27;jquery&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> fooPage</span><br><span class="line"></span><br><span class="line">$(<span class="string">&#x27;#btn-open-foo&#x27;</span>).<span class="title function_">on</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    fooPage = <span class="variable language_">window</span>.<span class="title function_">open</span>(<span class="string">&#x27;/sub-html/foo.html&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">$(<span class="string">&#x27;#btn-hi-via-post-message&#x27;</span>).<span class="title function_">on</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (fooPage) &#123;</span><br><span class="line">        fooPage.<span class="title function_">postMessage</span>(<span class="string">&#x27;hi this is Home Page&#x27;</span>, <span class="string">&#x27;*&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;message&#x27;</span>, <span class="function">(<span class="params">&#123;data&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Current timestamp <span class="subst">$&#123;<span class="built_in">Date</span>.now()&#125;</span> data: `</span>, data)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>通过 js 中我们不难发现, 项目中还需要一个 <code>sub-html/foo.html</code></p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- sub-html/foo.html --&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Foo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Foo Page<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;btn-send&quot;</span>&gt;</span>hi this is Foo Page<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;./foo.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>在它的同级, 还需要一个 <code>foo.js</code> 文件</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> $ <span class="keyword">from</span> <span class="string">&#x27;jquery&#x27;</span></span><br><span class="line"></span><br><span class="line">$(<span class="string">&#x27;#btn-send&#x27;</span>).<span class="title function_">on</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">window</span>.<span class="property">opener</span>.<span class="title function_">postMessage</span>(<span class="string">&#x27;hi this is Foo Page&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;message&#x27;</span>, <span class="function">(<span class="params">&#123;data&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`Current timestamp <span class="subst">$&#123;<span class="built_in">Date</span>.now()&#125;</span> data: `</span>, data)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>以上为 postMessage 简单应用的实例, 代码过于简单, 不做逐行注释. 其中需要特殊说明的是在子页面中 <code>window.opener</code> 其实就是对打开这个子页面的父级页面的 <code>window</code> 引用, eg:</p><p>大头儿子.opener &#x3D;&#x3D;&#x3D; 小头爸爸 &#x3D;&gt; true</p><p><small>PS: 仅作为技术实例, 不做真实性判断</small></p><h3 id="运行示例代码"><a href="#运行示例代码" class="headerlink" title="运行示例代码"></a>运行示例代码</h3><p>上述示例代码均已上传 <a target="_blank" rel="noopener" href="https://github.com/luoquanquan/learn-fe/tree/post-message-stream-learn-v1/metamask-learn/post-message-stream-learn">github</a>, 纸上得来终觉浅, 建议手敲一下. 20 来分钟就能搞定. 由于项目中用到了 npm 的 jQuery 包. 所以用 <a target="_blank" rel="noopener" href="https://zh.parceljs.org/">parcel</a> 构建了一下, 直接 <code>npm start</code> 即可.</p><p>代码运行完成后浏览器访问 <a target="_blank" rel="noopener" href="http://localhost:1234/index.html">http://localhost:1234/index.html</a> 即可打开 <code>Index Page</code>. postMessage 的工作过程如下图:</p><p><img src="https://handle-note-img.niubishanshan.top/post-message.gif"></p><h2 id="小狐狸依赖-post-message-stream-4-0-0"><a href="#小狐狸依赖-post-message-stream-4-0-0" class="headerlink" title="小狐狸依赖 post-message-stream@^4.0.0"></a>小狐狸依赖 post-message-stream@^4.0.0</h2><blockquote><p>Sets up a duplex object stream over window.postMessage, between pages or a dedicated Web Worker and its parent window.</p></blockquote><p>在 <code>post-message-stream@^4.0.0</code> 的官方描述中. 这个库的作用是创建一个用于跨页面或者父级页面和 Web Worker 通信的双工对象流. 在最新的版本中其实它还支持 <code>nodejs</code> 但是在 <code>metamask</code> 中其实只用到了 <code>^4.0.0</code> 这个版本. 因此这里按下不表.</p><h3 id="举个-🌰-1"><a href="#举个-🌰-1" class="headerlink" title="举个 🌰"></a>举个 🌰</h3><p>基于刚刚的 <code>postMessage</code> 示例进行改造, 首先安装依赖</p><ul><li>npm i @metamask&#x2F;post-message-stream@^4.0.0</li></ul><p>添加 <code>bar.html</code> 子页面</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- sub-html/bar.html --&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Bar<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Bar Page<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;btn-send&quot;</span>&gt;</span>hi this is Bar Page<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;./bar.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>创建 <code>bar.js</code></p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> $ <span class="keyword">from</span> <span class="string">&#x27;jquery&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">WindowPostMessageStream</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@metamask/post-message-stream&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 注意这里的 name 和 target 和 index.js 中的两个同名字段是反过来的. 以此来实现两者的双向绑定</span></span><br><span class="line"><span class="keyword">const</span> barStream = <span class="keyword">new</span> <span class="title class_">WindowPostMessageStream</span>(&#123;</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&#x27;barStream&#x27;</span>,</span><br><span class="line">    <span class="attr">target</span>: <span class="string">&#x27;indexStream&#x27;</span>,</span><br><span class="line">    <span class="attr">targetWindow</span>: <span class="variable language_">window</span>.<span class="property">opener</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">barStream.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;<span class="built_in">Date</span>.now()&#125;</span> receive data via stream: `</span>, data)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">$(<span class="string">&#x27;#btn-send&#x27;</span>).<span class="title function_">on</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    barStream.<span class="title function_">write</span>(<span class="string">&#x27;hi this is Bar Page&#x27;</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>优化 indexPage</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- index.html --&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Index<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>Home Page<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;btn-open-foo&quot;</span>&gt;</span>open Foo<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;btn-open-bar&quot;</span>&gt;</span>open Bar<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;btn-hi-via-post-message&quot;</span>&gt;</span>hi this is Home via post message<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;btn-hi-via-stream&quot;</span>&gt;</span>hi this is Home via stream<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;./index.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> $ <span class="keyword">from</span> <span class="string">&#x27;jquery&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">WindowPostMessageStream</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@metamask/post-message-stream&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> fooPage</span><br><span class="line"><span class="keyword">let</span> barPage</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">registerBarStream</span> = (<span class="params"></span>) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> indexStream = <span class="keyword">new</span> <span class="title class_">WindowPostMessageStream</span>(&#123;</span><br><span class="line">        <span class="attr">name</span>: <span class="string">&#x27;indexStream&#x27;</span>,</span><br><span class="line">        <span class="attr">target</span>: <span class="string">&#x27;barStream&#x27;</span>,</span><br><span class="line">        <span class="attr">targetWindow</span>: barPage</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    indexStream.<span class="title function_">on</span>(<span class="string">&#x27;data&#x27;</span>, <span class="function"><span class="params">data</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`<span class="subst">$&#123;<span class="built_in">Date</span>.now()&#125;</span> receive data via stream: `</span>, data)</span><br><span class="line">    &#125;)</span><br><span class="line">    indexStream.<span class="title function_">write</span>(<span class="string">&#x27;before -----&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    $(<span class="string">&#x27;#btn-hi-via-stream&#x27;</span>).<span class="title function_">on</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">        indexStream.<span class="title function_">write</span>(<span class="string">&#x27;hi this is Home via stream&#x27;</span>)</span><br><span class="line">        indexStream.<span class="title function_">write</span>(<span class="string">&#x27;hi this is Home via stream 2&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$(<span class="string">&#x27;#btn-open-foo&#x27;</span>).<span class="title function_">on</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    fooPage = <span class="variable language_">window</span>.<span class="title function_">open</span>(<span class="string">&#x27;/sub-html/foo.html&#x27;</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">$(<span class="string">&#x27;#btn-open-bar&#x27;</span>).<span class="title function_">on</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    barPage = <span class="variable language_">window</span>.<span class="title function_">open</span>(<span class="string">&#x27;/sub-html/bar.html&#x27;</span>)</span><br><span class="line">    <span class="title function_">registerBarStream</span>()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">$(<span class="string">&#x27;#btn-hi-via-post-message&#x27;</span>).<span class="title function_">on</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (fooPage) &#123;</span><br><span class="line">        fooPage.<span class="title function_">postMessage</span>(<span class="string">&#x27;hi this is Home Page&#x27;</span>, <span class="string">&#x27;*&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// window.addEventListener(&#x27;message&#x27;, (&#123;data&#125;) =&gt; &#123;</span></span><br><span class="line"><span class="comment">//     console.log(`Current timestamp $&#123;Date.now()&#125; data: `, data)</span></span><br><span class="line"><span class="comment">// &#125;)</span></span><br></pre></td></tr></table></figure><p>PS: 由于 <code>post-message-stream</code> 底层也会用到 postMessage, 为了不影响测试效果. 这里把 <code>index.js</code> 中的监听移除了.</p><p>最后修改 <code>package.json</code>, 在 script 命令中添加 bar.html 入口…</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;start&quot;: &quot;parcel index.html sub-html/foo.html sub-html/bar.html&quot;</span><br></pre></td></tr></table></figure><h3 id="运行示例代码-1"><a href="#运行示例代码-1" class="headerlink" title="运行示例代码"></a>运行示例代码</h3><p>上述示例代码均已上传 <a target="_blank" rel="noopener" href="https://github.com/luoquanquan/learn-fe/tree/post-message-stream-learn-v2/metamask-learn/post-message-stream-learn">github</a> 代码运行的工作过程如下图:</p><p><img src="https://handle-note-img.niubishanshan.top/post-message-stream.gif"></p><h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><p><a href="mailto:&#112;&#111;&#x73;&#x74;&#x2d;&#x6d;&#x65;&#x73;&#115;&#x61;&#103;&#x65;&#x2d;&#115;&#x74;&#114;&#x65;&#97;&#109;&#64;&#52;&#46;&#x30;&#x2e;&#48;">&#112;&#111;&#x73;&#x74;&#x2d;&#x6d;&#x65;&#x73;&#115;&#x61;&#103;&#x65;&#x2d;&#115;&#x74;&#114;&#x65;&#97;&#109;&#64;&#52;&#46;&#x30;&#x2e;&#48;</a> 版本引入的 ts, 对于基础逻辑进行了拆分在一定程度上就造成了阅读的困难. 鉴于此, 下文中我们先对 v3 版本解析, 再对 v4 版本解析.</p><h3 id="post-message-stream-3"><a href="#post-message-stream-3" class="headerlink" title="post-message-stream@3"></a>post-message-stream@3</h3><p>以下为 post-message-stream@3 版本核心源码, 区区 74 行代码就实现了一个稳定的跨终端的双工流.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这个包是对 node stream 模块的封装</span></span><br><span class="line"><span class="keyword">const</span> <span class="title class_">DuplexStream</span> = <span class="built_in">require</span>(<span class="string">&#x27;readable-stream&#x27;</span>).<span class="property">Duplex</span></span><br><span class="line"><span class="comment">// 这个是 node 继承用的, 远古时期有个手写原型继承的面试题. 实现的就是这个</span></span><br><span class="line"><span class="keyword">const</span> inherits = <span class="built_in">require</span>(<span class="string">&#x27;util&#x27;</span>).<span class="property">inherits</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">// 简单的实现大概就是这个样子</span></span><br><span class="line"><span class="comment">function inherits(subCls, supCls) &#123;</span></span><br><span class="line"><span class="comment">    // 子类原型为父类实例, 用于继承父类原型上的方法</span></span><br><span class="line"><span class="comment">    subCls.prototype = new supCls</span></span><br><span class="line"><span class="comment">    // 构造函数修正</span></span><br><span class="line"><span class="comment">    subCls.prototype.constructor = subCls</span></span><br><span class="line"><span class="comment">&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">PostMessageStream</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">inherits</span>(<span class="title class_">PostMessageStream</span>, <span class="title class_">DuplexStream</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">PostMessageStream</span> (opts) &#123;</span><br><span class="line">  <span class="comment">// 这个继承, 太经典了. 具体的知识点忘了可以看看这里</span></span><br><span class="line">  <span class="comment">// https://weread.qq.com/web/reader/751326d0720befab7514782k0723244023c072b030ba601</span></span><br><span class="line">  <span class="title class_">DuplexStream</span>.<span class="title function_">call</span>(<span class="variable language_">this</span>, &#123;</span><br><span class="line">    <span class="comment">// 默认情况下 objectMode 为 false, 我们只可以给流里边写入字符串, Buffer 或 Uint8Array.</span></span><br><span class="line">    <span class="comment">// 如果直接怼一个 object 进去, 嘎, 报错了...</span></span><br><span class="line">    <span class="comment">// Uncaught TypeError: Invalid non-string/buffer chunk</span></span><br><span class="line">    <span class="comment">// 所以需要指定 objectMode 为 true 来允许我们在不同终端间传递 object</span></span><br><span class="line">    <span class="attr">objectMode</span>: <span class="literal">true</span>,</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化参数</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_name</span> = opts.<span class="property">name</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_target</span> = opts.<span class="property">target</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_targetWindow</span> = opts.<span class="property">targetWindow</span> || <span class="variable language_">window</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_origin</span> = (opts.<span class="property">targetWindow</span> ? <span class="string">&#x27;*&#x27;</span> : location.<span class="property">origin</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// initialization flags</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_init</span> = <span class="literal">false</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_haveSyn</span> = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;message&#x27;</span>, <span class="variable language_">this</span>.<span class="property">_onMessage</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>), <span class="literal">false</span>)</span><br><span class="line">  <span class="comment">// send syncorization message</span></span><br><span class="line">  <span class="comment">// 发送握手包</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">_write</span>(<span class="string">&#x27;SYN&#x27;</span>, <span class="literal">null</span>, noop)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 继承自 Duplex, 调用此方法后到调用 this.uncork()</span></span><br><span class="line">  <span class="comment">// 之前写入流中的数据将会保存至缓冲区而不会直接提供给下游消费.</span></span><br><span class="line">  <span class="comment">// 直到调用 this.uncork(); 才会从缓冲区拿出之前写入的所有数据给到下游</span></span><br><span class="line">  <span class="comment">// 在前文示例中, 如果 indexPage 比较猴急, 打开 bar 页面后没等握手完成直接发数据过来</span></span><br><span class="line">  <span class="comment">// 就会写入到缓冲区待用了</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">cork</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// private</span></span><br><span class="line"><span class="title class_">PostMessageStream</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_onMessage</span> = <span class="keyword">function</span> (<span class="params">event</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> msg = event.<span class="property">data</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// validate message</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">_origin</span> !== <span class="string">&#x27;*&#x27;</span> &amp;&amp; event.<span class="property">origin</span> !== <span class="variable language_">this</span>.<span class="property">_origin</span>) <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">if</span> (event.<span class="property">source</span> !== <span class="variable language_">this</span>.<span class="property">_targetWindow</span>) <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> msg !== <span class="string">&#x27;object&#x27;</span>) <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">if</span> (msg.<span class="property">target</span> !== <span class="variable language_">this</span>.<span class="property">_name</span>) <span class="keyword">return</span></span><br><span class="line">  <span class="keyword">if</span> (!msg.<span class="property">data</span>) <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果当前终端还没有初始化, 先进行初始化</span></span><br><span class="line">  <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">_init</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这个三次握手的过程有点类似 tcp 三次握手的过程, 具体的时序图在下文</span></span><br><span class="line">    <span class="keyword">if</span> (msg.<span class="property">data</span> === <span class="string">&#x27;SYN&#x27;</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_haveSyn</span> = <span class="literal">true</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">_write</span>(<span class="string">&#x27;ACK&#x27;</span>, <span class="literal">null</span>, noop)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (msg.<span class="property">data</span> === <span class="string">&#x27;ACK&#x27;</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_init</span> = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">_haveSyn</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">_write</span>(<span class="string">&#x27;ACK&#x27;</span>, <span class="literal">null</span>, noop)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">uncork</span>()</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">//  如果当前终端已经完成初始化, 接受数据并处理</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// forward message</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">push</span>(msg.<span class="property">data</span>)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, err)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// stream plumbing</span></span><br><span class="line"><span class="comment">// Readable 流实现都必须提供</span></span><br><span class="line"><span class="comment">// Duplex 为双工流可读可写, 所以也必须实现</span></span><br><span class="line"><span class="comment">// 主要用于处理可读流的读取操作的底层逻辑</span></span><br><span class="line"><span class="title class_">PostMessageStream</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_read</span> = noop</span><br><span class="line"></span><br><span class="line"><span class="comment">// 向流中写入内容的底层处理, 实质上就是调用了 window.postMessage 告诉对方</span></span><br><span class="line"><span class="title class_">PostMessageStream</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_write</span> = <span class="keyword">function</span> (<span class="params">data, encoding, cb</span>) &#123;</span><br><span class="line">  <span class="keyword">var</span> message = &#123;</span><br><span class="line">    <span class="attr">target</span>: <span class="variable language_">this</span>.<span class="property">_target</span>,</span><br><span class="line">    <span class="attr">data</span>: data,</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="variable language_">this</span>.<span class="property">_targetWindow</span>.<span class="title function_">postMessage</span>(message, <span class="variable language_">this</span>.<span class="property">_origin</span>)</span><br><span class="line">  <span class="title function_">cb</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// util</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">noop</span> () &#123;&#125;</span><br></pre></td></tr></table></figure><p>其中, 握手的过程时序图如下:<br><img src="https://handle-note-img.niubishanshan.top/20220927114850.png" alt="20220927114850"></p><h3 id="post-message-stream-4"><a href="#post-message-stream-4" class="headerlink" title="post-message-stream@4"></a>post-message-stream@4</h3><p>以下为 post-message-stream@4 代码, 相对于 v3 的主要区别是为了适配更多的环境 (node, webWorker) 对于握手和数据处理模块做了更深程度的抽象.</p><figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BasePostMessageStream.ts</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Nodejs 双工流类</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">Duplex</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;readable-stream&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 空函数作为回调默认值</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">noop</span>(<span class="params"></span>): <span class="built_in">void</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">undefined</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 握手包名称</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">SYN</span> = <span class="string">&#x27;SYN&#x27;</span>;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">ACK</span> = <span class="string">&#x27;ACK&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">type</span> <span class="title class_">StreamData</span> = <span class="built_in">string</span> | <span class="title class_">Record</span>&lt;<span class="built_in">string</span>, <span class="built_in">unknown</span>&gt;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">interface</span> <span class="title class_">PostMessageEvent</span> &#123;</span><br><span class="line">  data?: <span class="title class_">StreamData</span>;</span><br><span class="line">  <span class="attr">origin</span>: <span class="built_in">string</span>;</span><br><span class="line">  <span class="attr">source</span>: <span class="keyword">typeof</span> <span class="variable language_">window</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Abstract base class for postMessage streams.</span></span><br><span class="line"><span class="comment"> * 他说这是个抽象类. 意思是你不能实例化它, 要实例化它的子类</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">BasePostMessageStream</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Duplex</span> &#123;</span><br><span class="line">  <span class="comment">// 是否初始化</span></span><br><span class="line">  <span class="keyword">private</span> <span class="attr">_init</span>: <span class="built_in">boolean</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 是否已经接受/发出过握手包</span></span><br><span class="line">  <span class="keyword">private</span> <span class="attr">_haveSyn</span>: <span class="built_in">boolean</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="variable language_">super</span>(&#123;</span><br><span class="line">      <span class="attr">objectMode</span>: <span class="literal">true</span>,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Initialization flags</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_init</span> = <span class="literal">false</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_haveSyn</span> = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Must be called at end of child constructor to initiate</span></span><br><span class="line"><span class="comment">   * communication with other end.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * 子类初始化时候调用的, 开始握手的方法</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="title function_">_handshake</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="comment">// Send synchronization message</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">_write</span>(<span class="variable constant_">SYN</span>, <span class="literal">null</span>, noop);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">cork</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 收到其他终端发来的数据处理</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="title function_">_onData</span>(<span class="attr">data</span>: <span class="title class_">StreamData</span>): <span class="built_in">void</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">_init</span>) &#123;</span><br><span class="line">      <span class="comment">// Forward message</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">push</span>(data);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (err) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">emit</span>(<span class="string">&#x27;error&#x27;</span>, err);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (data === <span class="variable constant_">SYN</span>) &#123;</span><br><span class="line">      <span class="comment">// Listen for handshake</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_haveSyn</span> = <span class="literal">true</span>;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">_write</span>(<span class="variable constant_">ACK</span>, <span class="literal">null</span>, noop);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (data === <span class="variable constant_">ACK</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_init</span> = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">_haveSyn</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">_write</span>(<span class="variable constant_">ACK</span>, <span class="literal">null</span>, noop);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">uncork</span>();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Child classes must implement this function.</span></span><br><span class="line"><span class="comment">   * 抽象方法, 不同的 runtime 实现的方式不同</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">abstract</span> <span class="title function_">_postMessage</span>(_data?: <span class="built_in">unknown</span>): <span class="built_in">void</span>;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">_read</span>(): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">undefined</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Duplex</span></span><br><span class="line">  <span class="comment">// 发送数据 or 握手包 Duplex 流中调用 write 时触发的底层逻辑</span></span><br><span class="line">  <span class="title function_">_write</span>(<span class="attr">data</span>: <span class="title class_">StreamData</span>, <span class="attr">_encoding</span>: <span class="built_in">string</span> | <span class="literal">null</span>, <span class="attr">cb</span>: <span class="function">() =&gt;</span> <span class="built_in">void</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">_postMessage</span>(data);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用回调表示写入逻辑处理完成</span></span><br><span class="line">    <span class="title function_">cb</span>();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WindowPostMessageStream.ts</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;</span><br><span class="line">  <span class="title class_">BasePostMessageStream</span>,</span><br><span class="line">  <span class="title class_">PostMessageEvent</span>,</span><br><span class="line">  <span class="title class_">StreamData</span>,</span><br><span class="line">&#125; <span class="keyword">from</span> <span class="string">&#x27;./BasePostMessageStream&#x27;</span>;</span><br><span class="line"></span><br><span class="line">interface <span class="title class_">WindowPostMessageStreamArgs</span> &#123;</span><br><span class="line">  <span class="attr">name</span>: string;</span><br><span class="line">  <span class="attr">target</span>: string;</span><br><span class="line">  targetWindow?: <span class="title class_">Window</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Window.postMessage stream.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">WindowPostMessageStream</span> <span class="keyword">extends</span> <span class="title class_ inherited__">BasePostMessageStream</span> &#123;</span><br><span class="line">  <span class="comment">// 当前流名称</span></span><br><span class="line">  private <span class="attr">_name</span>: string;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 目标流名称</span></span><br><span class="line">  private <span class="attr">_target</span>: string;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 目标页面所在的域名</span></span><br><span class="line">  private <span class="attr">_targetOrigin</span>: string;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 目标页面 window 对象 (基于 _targetWindow.postMessage)</span></span><br><span class="line">  private <span class="attr">_targetWindow</span>: <span class="title class_">Window</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Creates a stream for communicating with other streams across the same or</span></span><br><span class="line"><span class="comment">   * different window objects.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> args.name - The name of the stream. Used to differentiate between</span></span><br><span class="line"><span class="comment">   * multiple streams sharing the same window object.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> args.target - The name of the stream to exchange messages with.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> args.targetWindow - The window object of the target stream. Defaults</span></span><br><span class="line"><span class="comment">   * to `window`.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">&#123; name, target, targetWindow &#125;: WindowPostMessageStreamArgs</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!name || !target) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Invalid input.&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">super</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 参数初始化</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_name</span> = name;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_target</span> = target;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_targetOrigin</span> = targetWindow ? <span class="string">&#x27;*&#x27;</span> : location.<span class="property">origin</span>;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_targetWindow</span> = targetWindow || <span class="variable language_">window</span>;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_onMessage</span> = <span class="variable language_">this</span>.<span class="property">_onMessage</span>.<span class="title function_">bind</span>(<span class="variable language_">this</span>);</span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;message&#x27;</span>, <span class="variable language_">this</span>.<span class="property">_onMessage</span> <span class="keyword">as</span> any, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发起握手请求</span></span><br><span class="line">    <span class="comment">// 如果是第一个终端, 握手请求会被废弃</span></span><br><span class="line">    <span class="comment">// 如果是第二个终端, 握手请求会被第一个终端接收到</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">_handshake</span>();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 发送数据, 实际就是调用 window.postMessage</span></span><br><span class="line">  protected <span class="title function_">_postMessage</span>(<span class="attr">data</span>: unknown): <span class="keyword">void</span> &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_targetWindow</span>.<span class="title function_">postMessage</span>(</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">target</span>: <span class="variable language_">this</span>.<span class="property">_target</span>,</span><br><span class="line">        data,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">_targetOrigin</span>,</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 接收信息</span></span><br><span class="line">  private <span class="title function_">_onMessage</span>(<span class="attr">event</span>: <span class="title class_">PostMessageEvent</span>): <span class="keyword">void</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> message = event.<span class="property">data</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// validate message</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      (<span class="variable language_">this</span>.<span class="property">_targetOrigin</span> !== <span class="string">&#x27;*&#x27;</span> &amp;&amp; event.<span class="property">origin</span> !== <span class="variable language_">this</span>.<span class="property">_targetOrigin</span>) ||</span><br><span class="line">      event.<span class="property">source</span> !== <span class="variable language_">this</span>.<span class="property">_targetWindow</span> ||</span><br><span class="line">      <span class="keyword">typeof</span> message !== <span class="string">&#x27;object&#x27;</span> ||</span><br><span class="line">      message.<span class="property">target</span> !== <span class="variable language_">this</span>.<span class="property">_name</span> ||</span><br><span class="line">      !message.<span class="property">data</span></span><br><span class="line">    ) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用父类定义的 _onData 处理数据</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">_onData</span>(message.<span class="property">data</span> <span class="keyword">as</span> <span class="title class_">StreamData</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// destroy 方法的底层实现</span></span><br><span class="line">  <span class="title function_">_destroy</span>(): <span class="keyword">void</span> &#123;</span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">removeEventListener</span>(<span class="string">&#x27;message&#x27;</span>, <span class="variable language_">this</span>.<span class="property">_onMessage</span> <span class="keyword">as</span> any, <span class="literal">false</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="cork-amp-uncork"><a href="#cork-amp-uncork" class="headerlink" title="cork &amp; uncork"></a>cork &amp; uncork</h3><blockquote><p>在向流中写入大量小块数据（small chunks of data）时，内部缓冲区（internal buffer）可能失效，从而导致性能下降。writable.cork() 方法主要就是用来避免这种情况。</p></blockquote><p>对于这段我的理解是, 每个可写流会有一个内部缓冲区. 当我们哐哧哐哧给内部缓冲区写小块儿的东西给它怼满了, 就会导致其失效. 所以当我们需要频繁写入小块内容时. 可以先调用 writable.cork 强制将 writable.write 的内容写入到内存中. 等批量小块儿内容写入完成再调用 writable.uncork 统一释放出来.</p><p>示例代码:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">Writable</span> &#125; = <span class="built_in">require</span>(<span class="string">&#x27;stream&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyWritableStream</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Writable</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">_write</span>(<span class="params">data, _encoding, next</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(data.<span class="title function_">toString</span>())</span><br><span class="line">        <span class="title function_">next</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> myWritableStream = <span class="keyword">new</span> <span class="title class_">MyWritableStream</span>()</span><br><span class="line"></span><br><span class="line">myWritableStream.<span class="title function_">write</span>(<span class="string">&#x27;hello world ~&#x27;</span>)</span><br><span class="line">myWritableStream.<span class="title function_">write</span>(<span class="string">&#x27;hello world 2 ~&#x27;</span>)</span><br><span class="line">myWritableStream.<span class="title function_">write</span>(<span class="string">&#x27;hello world 3 ~&#x27;</span>)</span><br><span class="line">myWritableStream.<span class="title function_">write</span>(<span class="string">&#x27;hello world 4 ~&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 控制台输出:</span></span><br><span class="line"><span class="comment">// hello world ~</span></span><br><span class="line"><span class="comment">// hello world 2 ~</span></span><br><span class="line"><span class="comment">// hello world 3 ~</span></span><br><span class="line"><span class="comment">// hello world 4 ~</span></span><br></pre></td></tr></table></figure><p>执行上述代码, 所有的 <code>hello world</code> 都会打印出来, 但是如果稍作修改改为以下代码.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">Writable</span> &#125; = <span class="built_in">require</span>(<span class="string">&#x27;stream&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyWritableStream</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Writable</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">_write</span>(<span class="params">data, _encoding, next</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(data.<span class="title function_">toString</span>())</span><br><span class="line">        <span class="title function_">next</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> myWritableStream = <span class="keyword">new</span> <span class="title class_">MyWritableStream</span>()</span><br><span class="line"></span><br><span class="line">myWritableStream.<span class="title function_">write</span>(<span class="string">&#x27;hello world ~&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ++++++++++++++++++</span></span><br><span class="line">myWritableStream.<span class="title function_">cork</span>()</span><br><span class="line"><span class="comment">// ++++++++++++++++++</span></span><br><span class="line"></span><br><span class="line">myWritableStream.<span class="title function_">write</span>(<span class="string">&#x27;hello world 2 ~&#x27;</span>)</span><br><span class="line">myWritableStream.<span class="title function_">write</span>(<span class="string">&#x27;hello world 3 ~&#x27;</span>)</span><br><span class="line">myWritableStream.<span class="title function_">write</span>(<span class="string">&#x27;hello world 4 ~&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 控制台输出:</span></span><br><span class="line"><span class="comment">// hello world ~</span></span><br></pre></td></tr></table></figure><p>此时便只会打印出 <code>hello world ~</code> 后边三个不会打印, 因为 <code>myWritableStream.cork()</code> 之后写入流的内容被强制写入到了内存中没有释放. 再次修改代码, 再最后加上 <code>myWritableStream.uncork()</code> 即可释放 <code>myWritableStream.cork()</code> 之后写入的数据块.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">Writable</span> &#125; = <span class="built_in">require</span>(<span class="string">&#x27;stream&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyWritableStream</span> <span class="keyword">extends</span> <span class="title class_ inherited__">Writable</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="variable language_">super</span>()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">_write</span>(<span class="params">data, _encoding, next</span>) &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(data.<span class="title function_">toString</span>())</span><br><span class="line">        <span class="title function_">next</span>()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> myWritableStream = <span class="keyword">new</span> <span class="title class_">MyWritableStream</span>()</span><br><span class="line"></span><br><span class="line">myWritableStream.<span class="title function_">write</span>(<span class="string">&#x27;hello world ~&#x27;</span>)</span><br><span class="line"></span><br><span class="line">myWritableStream.<span class="title function_">cork</span>()</span><br><span class="line"></span><br><span class="line">myWritableStream.<span class="title function_">write</span>(<span class="string">&#x27;hello world 2 ~&#x27;</span>)</span><br><span class="line">myWritableStream.<span class="title function_">write</span>(<span class="string">&#x27;hello world 3 ~&#x27;</span>)</span><br><span class="line">myWritableStream.<span class="title function_">write</span>(<span class="string">&#x27;hello world 4 ~&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ++++++++++++++++++</span></span><br><span class="line">myWritableStream.<span class="title function_">uncork</span>()</span><br><span class="line"><span class="comment">// ++++++++++++++++++</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 控制台输出:</span></span><br><span class="line"><span class="comment">// hello world ~</span></span><br><span class="line"><span class="comment">// hello world 2 ~</span></span><br><span class="line"><span class="comment">// hello world 3 ~</span></span><br><span class="line"><span class="comment">// hello world 4 ~</span></span><br></pre></td></tr></table></figure><h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h2><p>也算是熟读了这块的源码还是有些疑惑, 单纯用 postMessage 应该是可以满足小狐狸钱包相关的数据通信的. 使用双工流的优势:</p><ol><li>处理大规模数据时不会出现内存瓶颈</li><li>cork &#x2F; uncork 保证了主进程在子进程初始化完成前就发送数据的完整性</li></ol><p>但是这两个优点 postMessage + 部分逻辑也可以搞定, 想不通作者为啥这么用. 而且根据考古 7 年前(也就是小狐狸项目初期)的 <a target="_blank" rel="noopener" href="https://github.com/MetaMask/metamask-extension/commit/72a747165dda417aa7968e44b404eb90707202a2">这次提交</a> 作者升级了 web3(0.9.2 -&gt; 0.15.1) 同时通信机制从 <code>postMessage</code> 切换到了 <code>post-message-stream</code> 但是不知两者是否有关联 🤔</p><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a target="_blank" rel="noopener" href="https://zh.parceljs.org/">parcel 官方文档</a></li><li><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage">postMessage</a></li><li><a target="_blank" rel="noopener" href="https://github.com/MetaMask/post-message-stream">post-message-stream</a></li><li><a target="_blank" rel="noopener" href="http://nodejs.cn/api-v12/stream.html#stream_class_stream_duplex">Duplex 类</a></li><li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/49317685/read-is-not-implemented-on-readable-stream">_read() is not implemented on Readable stream</a></li><li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/36728655">Node.js 流（stream）：你需要知道的一切</a></li><li><a target="_blank" rel="noopener" href="https://tech.meituan.com/2016/07/08/stream-basics.html">Node.js Stream - 基础篇</a></li><li><a target="_blank" rel="noopener" href="https://www.tutorialspoint.com/stream-writable-cork-and-uncork-method-in-node-js">Stream writable.cork() and uncork() Method in Node.js</a></li><li><a target="_blank" rel="noopener" href="https://xiaohuochai.site/BE/node/file/stream.html">数据流stream</a></li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/" rel="tag"># 开发笔记</a></div><div class="post-nav"><div class="post-nav-item"><a href="/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/MetaMask-%E6%BA%90%E7%A0%81/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/MetaMask%20%E6%BA%90%E7%A0%81/%E5%89%8D%E8%A8%80/" rel="prev" title="前言"><i class="fa fa-chevron-left"></i> 前言</a></div><div class="post-nav-item"> <a href="/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/%E5%B7%A5%E5%85%B7/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/%E5%B7%A5%E5%85%B7/github%20hosts%20%E5%8F%98%E5%BF%AB/" rel="next" title="github hosts 变快">github hosts 变快<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div><script>
  window.addEventListener('tabs:register', function() {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A6%96%E5%85%88%E6%83%B3%E5%88%B0-postMessage"><span class="nav-text">首先想到 postMessage</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BE%E4%B8%AA-%F0%9F%8C%B0"><span class="nav-text">举个 🌰</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E7%A4%BA%E4%BE%8B%E4%BB%A3%E7%A0%81"><span class="nav-text">运行示例代码</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B0%8F%E7%8B%90%E7%8B%B8%E4%BE%9D%E8%B5%96-post-message-stream-4-0-0"><span class="nav-text">小狐狸依赖 post-message-stream@^4.0.0</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BE%E4%B8%AA-%F0%9F%8C%B0-1"><span class="nav-text">举个 🌰</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E7%A4%BA%E4%BE%8B%E4%BB%A3%E7%A0%81-1"><span class="nav-text">运行示例代码</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-text">源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#post-message-stream-3"><span class="nav-text">post-message-stream@3</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#post-message-stream-4"><span class="nav-text">post-message-stream@4</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#cork-amp-uncork"><span class="nav-text">cork &amp; uncork</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%9D%E8%80%83"><span class="nav-text">思考</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-text">参考资料</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="圈圈的圈" src="/images/avatar.png"><p class="site-author-name" itemprop="name">圈圈的圈</p><div class="site-description" itemprop="description">技术学习, 读书笔记, 生活感悟 ~</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">142</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">35</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">8</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://juejin.im/user/5837c2bd61ff4b006ca8d1b2" title="掘金 → https:&#x2F;&#x2F;juejin.im&#x2F;user&#x2F;5837c2bd61ff4b006ca8d1b2" rel="noopener" target="_blank"><i class="fa fa-fw fa-stack-overflow"></i> 掘金</a></span><span class="links-of-author-item"><a href="https://github.com/luoquanquan" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;luoquanquan" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:luo_quanquan@163.com" title="E-Mail → mailto:luo_quanquan@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="beian"><a href="http://www.beian.miit.gov.cn/" rel="noopener" target="_blank">京ICP备17034706号-1</a></div><div class="copyright"> &copy; <span itemprop="copyrightYear">2024</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">圈圈的圈</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer></div><script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/js/theme-next-canvas-nest/canvas-nest.min.js"></script><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script></body></html>
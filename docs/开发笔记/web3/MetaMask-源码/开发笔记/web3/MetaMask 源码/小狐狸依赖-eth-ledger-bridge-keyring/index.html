<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:new URL("http://note.niubishanshan.top").hostname,root:"/",scheme:"Gemini",version:"7.7.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!1,show_result:!1,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{appID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},path:"search.json",motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta name="description" content="eth-ledger-bridge-keyring 是 MetaMask 团队基于 Simple Keyring 协议开发的 Ledger 硬件钱包链接方案. 涉及到的逻辑主要是硬件钱包账户导入和合约签署(签名)  基础逻辑为了代码逻辑的抽离, Metamask 使用了 iframe 嵌套实际硬件钱包连接的方案. 在 background.html 中通过 iframe 嵌套了连接中间页, 在业"><meta property="og:type" content="article"><meta property="og:title" content="小狐狸依赖-eth-ledger-bridge-keyring"><meta property="og:url" content="http://note.niubishanshan.top/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/MetaMask-%E6%BA%90%E7%A0%81/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/MetaMask%20%E6%BA%90%E7%A0%81/%E5%B0%8F%E7%8B%90%E7%8B%B8%E4%BE%9D%E8%B5%96-eth-ledger-bridge-keyring/index.html"><meta property="og:site_name" content="圈圈的笔记"><meta property="og:description" content="eth-ledger-bridge-keyring 是 MetaMask 团队基于 Simple Keyring 协议开发的 Ledger 硬件钱包链接方案. 涉及到的逻辑主要是硬件钱包账户导入和合约签署(签名)  基础逻辑为了代码逻辑的抽离, Metamask 使用了 iframe 嵌套实际硬件钱包连接的方案. 在 background.html 中通过 iframe 嵌套了连接中间页, 在业"><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://handle-note-img.niubishanshan.top/20221230002710.png"><meta property="og:image" content="https://handle-note-img.niubishanshan.top/20221230002924.png"><meta property="article:published_time" content="2022-12-29T15:56:27.000Z"><meta property="article:modified_time" content="2024-06-27T15:04:43.291Z"><meta property="article:author" content="圈圈的圈"><meta property="article:tag" content="开发笔记"><meta name="twitter:card" content="summary"><meta name="twitter:image" content="https://handle-note-img.niubishanshan.top/20221230002710.png"><link rel="canonical" href="http://note.niubishanshan.top/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/MetaMask-%E6%BA%90%E7%A0%81/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/MetaMask%20%E6%BA%90%E7%A0%81/%E5%B0%8F%E7%8B%90%E7%8B%B8%E4%BE%9D%E8%B5%96-eth-ledger-bridge-keyring/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0}</script><title>小狐狸依赖-eth-ledger-bridge-keyring | 圈圈的笔记</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div> <a target="_blank" rel="noopener" href="https://github.com/luoquanquan" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">圈圈的笔记</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">路漫漫其修远兮, 吾将上下而求索</p></div><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i> 首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i> 归档</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i> 关于</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="site-search"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="搜索..." spellcheck="false" type="text" id="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"></div></div><div class="search-pop-overlay"></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://note.niubishanshan.top/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/MetaMask-%E6%BA%90%E7%A0%81/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/MetaMask%20%E6%BA%90%E7%A0%81/%E5%B0%8F%E7%8B%90%E7%8B%B8%E4%BE%9D%E8%B5%96-eth-ledger-bridge-keyring/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.png"><meta itemprop="name" content="圈圈的圈"><meta itemprop="description" content="技术学习, 读书笔记, 生活感悟 ~"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="圈圈的笔记"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> 小狐狸依赖-eth-ledger-bridge-keyring</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-12-29 23:56:27" itemprop="dateCreated datePublished" datetime="2022-12-29T23:56:27+08:00">2022-12-29</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2024-06-27 23:04:43" itemprop="dateModified" datetime="2024-06-27T23:04:43+08:00">2024-06-27</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">开发笔记</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/" itemprop="url" rel="index"><span itemprop="name">web3</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/MetaMask-%E6%BA%90%E7%A0%81/" itemprop="url" rel="index"><span itemprop="name">MetaMask 源码</span></a></span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>eth-ledger-bridge-keyring 是 MetaMask 团队基于 <a target="_blank" rel="noopener" href="https://github.com/MetaMask/eth-simple-keyring#the-keyring-class-protocol">Simple Keyring</a> 协议开发的 Ledger 硬件钱包链接方案. 涉及到的逻辑主要是硬件钱包账户导入和合约签署(签名)</p></blockquote><h2 id="基础逻辑"><a href="#基础逻辑" class="headerlink" title="基础逻辑"></a>基础逻辑</h2><p>为了代码逻辑的抽离, Metamask 使用了 iframe 嵌套实际硬件钱包连接的方案. 在 background.html 中通过 iframe 嵌套了连接中间页, 在业务代码中则利用 eth-ledger-bridge-keyring 通过 postMessage 和中间页进行通信从而实现硬件钱包的链接.</p><h3 id="名词解释"><a href="#名词解释" class="headerlink" title="名词解释"></a>名词解释</h3><ul><li>硬件钱包驱动程序: 硬件钱包厂商提供的 js 代码, 主要功能是实现浏览器和插件硬件的通信</li><li>硬件钱包桥接程序: metamask 团队实现的为了抹平硬件钱包驱动程序之间的 api 区别的胶水代码, 同时承担了基于 publicKey 派生 address 的功能</li></ul><p>本文主要描述的 eth-ledger-bridge-keyring 就是上述名词中的<strong>硬件钱包桥接程序</strong></p><span id="more"></span><h2 id="硬件钱包账号导入"><a href="#硬件钱包账号导入" class="headerlink" title="硬件钱包账号导入"></a>硬件钱包账号导入</h2><p>目前硬件钱包仅支持 EVM 系的地址, 硬件钱包账户导入的过程就是硬件钱包桥接程序通过 postMessage 驱动硬件钱包驱动程序获取到硬件钱包的 publicKey, 并基于 publicKey 派生出 address 的过程. 具体的执行过程时序图如下:</p><p><img src="https://handle-note-img.niubishanshan.top/20221230002710.png" alt="20221230002710"></p><h2 id="签署合约"><a href="#签署合约" class="headerlink" title="签署合约"></a>签署合约</h2><p>Ledger 钱包签署合约的 api 有 signMessage, signPersonalMessage, signTypedData, signTransaction. 其中 signTypedData 仅支持 V4 的版本. 其中 Dapp 发起的合约交易的签署过程如下:</p><p><img src="https://handle-note-img.niubishanshan.top/20221230002924.png" alt="20221230002924"></p><h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">EventEmitter</span> &#125; = <span class="built_in">require</span>(<span class="string">&#x27;events&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> <span class="title class_">HDKey</span> = <span class="built_in">require</span>(<span class="string">&#x27;hdkey&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> ethUtil = <span class="built_in">require</span>(<span class="string">&#x27;ethereumjs-util&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> sigUtil = <span class="built_in">require</span>(<span class="string">&#x27;eth-sig-util&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; <span class="title class_">TransactionFactory</span> &#125; = <span class="built_in">require</span>(<span class="string">&#x27;@ethereumjs/tx&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> pathBase = <span class="string">&#x27;m&#x27;</span></span><br><span class="line"><span class="keyword">const</span> hdPathString = <span class="string">`<span class="subst">$&#123;pathBase&#125;</span>/44&#x27;/60&#x27;/0&#x27;`</span></span><br><span class="line"><span class="keyword">const</span> type = <span class="string">&#x27;Ledger Hardware&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 嵌套的中间页地址</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">BRIDGE_URL</span> = <span class="string">&#x27;https://metamask.github.io/eth-ledger-bridge-keyring&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 最多可以派生的地址数</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">MAX_INDEX</span> = <span class="number">1000</span></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">NETWORK_API_URLS</span> = &#123;</span><br><span class="line">  <span class="attr">ropsten</span>: <span class="string">&#x27;http://api-ropsten.etherscan.io&#x27;</span>,</span><br><span class="line">  <span class="attr">kovan</span>: <span class="string">&#x27;http://api-kovan.etherscan.io&#x27;</span>,</span><br><span class="line">  <span class="attr">rinkeby</span>: <span class="string">&#x27;https://api-rinkeby.etherscan.io&#x27;</span>,</span><br><span class="line">  <span class="attr">mainnet</span>: <span class="string">&#x27;https://api.etherscan.io&#x27;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">CONNECTION_EVENT</span> = <span class="string">&#x27;ledger-connection-change&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LedgerBridgeKeyring</span> <span class="keyword">extends</span> <span class="title class_ inherited__">EventEmitter</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span> (opts = &#123;&#125;) &#123;</span><br><span class="line">    <span class="variable language_">super</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">accountDetails</span> = &#123;&#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">bridgeUrl</span> = <span class="literal">null</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">type</span> = type</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">page</span> = <span class="number">0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">perPage</span> = <span class="number">5</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">unlockedAccount</span> = <span class="number">0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">hdk</span> = <span class="keyword">new</span> <span class="title class_">HDKey</span>()</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">paths</span> = &#123;&#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">iframe</span> = <span class="literal">null</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">network</span> = <span class="string">&#x27;mainnet&#x27;</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">implementFullBIP44</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">deserialize</span>(opts)</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">iframeLoaded</span> = <span class="literal">false</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">_setupIframe</span>()</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">currentMessageId</span> = <span class="number">0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">messageCallbacks</span> = &#123;&#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">_setupListener</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  serialize () &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(&#123;</span><br><span class="line">      <span class="attr">hdPath</span>: <span class="variable language_">this</span>.<span class="property">hdPath</span>,</span><br><span class="line">      <span class="attr">accounts</span>: <span class="variable language_">this</span>.<span class="property">accounts</span>,</span><br><span class="line">      <span class="attr">accountDetails</span>: <span class="variable language_">this</span>.<span class="property">accountDetails</span>,</span><br><span class="line">      <span class="attr">bridgeUrl</span>: <span class="variable language_">this</span>.<span class="property">bridgeUrl</span>,</span><br><span class="line">      <span class="attr">implementFullBIP44</span>: <span class="literal">false</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  deserialize (opts = &#123;&#125;) &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">hdPath</span> = opts.<span class="property">hdPath</span> || hdPathString</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">bridgeUrl</span> = opts.<span class="property">bridgeUrl</span> || <span class="variable constant_">BRIDGE_URL</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">accounts</span> = opts.<span class="property">accounts</span> || []</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">accountDetails</span> = opts.<span class="property">accountDetails</span> || &#123;&#125;</span><br><span class="line">    <span class="keyword">if</span> (!opts.<span class="property">accountDetails</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">_migrateAccountDetails</span>(opts)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">implementFullBIP44</span> = opts.<span class="property">implementFullBIP44</span> || <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Remove accounts that don&#x27;t have corresponding account details</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">accounts</span> = <span class="variable language_">this</span>.<span class="property">accounts</span></span><br><span class="line">      .<span class="title function_">filter</span>(<span class="function">(<span class="params">account</span>) =&gt;</span> <span class="title class_">Object</span>.<span class="title function_">keys</span>(<span class="variable language_">this</span>.<span class="property">accountDetails</span>).<span class="title function_">includes</span>(ethUtil.<span class="title function_">toChecksumAddress</span>(account)))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  _migrateAccountDetails (opts) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="title function_">_isLedgerLiveHdPath</span>() &amp;&amp; opts.<span class="property">accountIndexes</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">const</span> account <span class="keyword">of</span> <span class="title class_">Object</span>.<span class="title function_">keys</span>(opts.<span class="property">accountIndexes</span>)) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">accountDetails</span>[account] = &#123;</span><br><span class="line">          <span class="attr">bip44</span>: <span class="literal">true</span>,</span><br><span class="line">          <span class="attr">hdPath</span>: <span class="variable language_">this</span>.<span class="title function_">_getPathForIndex</span>(opts.<span class="property">accountIndexes</span>[account]),</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// try to migrate non-LedgerLive accounts too</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="title function_">_isLedgerLiveHdPath</span>()) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">accounts</span></span><br><span class="line">        .<span class="title function_">filter</span>(<span class="function">(<span class="params">account</span>) =&gt;</span> !<span class="title class_">Object</span>.<span class="title function_">keys</span>(<span class="variable language_">this</span>.<span class="property">accountDetails</span>).<span class="title function_">includes</span>(ethUtil.<span class="title function_">toChecksumAddress</span>(account)))</span><br><span class="line">        .<span class="title function_">forEach</span>(<span class="function">(<span class="params">account</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">accountDetails</span>[ethUtil.<span class="title function_">toChecksumAddress</span>(account)] = &#123;</span><br><span class="line">              <span class="attr">bip44</span>: <span class="literal">false</span>,</span><br><span class="line">              <span class="attr">hdPath</span>: <span class="variable language_">this</span>.<span class="title function_">_pathFromAddress</span>(account),</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">`failed to migrate account <span class="subst">$&#123;account&#125;</span>`</span>)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 判断当前硬件钱包是否为解锁状态, 用户进入硬件钱包连接页面且选中的硬件钱包处于解锁状态的话</span></span><br><span class="line">  <span class="comment">// 会直接触发派生当前硬件钱包第一页地址的逻辑</span></span><br><span class="line">  isUnlocked () &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Boolean</span>(<span class="variable language_">this</span>.<span class="property">hdk</span> &amp;&amp; <span class="variable language_">this</span>.<span class="property">hdk</span>.<span class="property">publicKey</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 硬件钱包的连接状态</span></span><br><span class="line">  isConnected () &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">isDeviceConnected</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置基础 hdPath</span></span><br><span class="line">  <span class="comment">// 目前 Ledger 硬件钱包派生 address 有三种协议, 可以在连接硬件钱包的页面进行选择</span></span><br><span class="line">  <span class="comment">// 不同的协议派生出来的钱包 address 不同, 变相增加了硬件钱包可使用的范围</span></span><br><span class="line">  setHdPath (hdPath) &#123;</span><br><span class="line">    <span class="comment">// Reset HDKey if the path changes</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">hdPath</span> !== hdPath) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">hdk</span> = <span class="keyword">new</span> <span class="title class_">HDKey</span>()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">hdPath</span> = hdPath</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 解锁方法, 利用此方法可以获取到硬件钱包对应 path 的 publicKey, 利用此 publicKey 可以派生</span></span><br><span class="line"><span class="comment">   * 出更多的 address 供用户选择并导入</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  unlock (hdPath, updateHdk = <span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="title function_">isUnlocked</span>() &amp;&amp; !hdPath) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="string">&#x27;already unlocked&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> path = hdPath ? <span class="variable language_">this</span>.<span class="title function_">_toLedgerPath</span>(hdPath) : <span class="variable language_">this</span>.<span class="property">hdPath</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">_sendMessage</span>(&#123;</span><br><span class="line">        <span class="attr">action</span>: <span class="string">&#x27;ledger-unlock&#x27;</span>,</span><br><span class="line">        <span class="attr">params</span>: &#123;</span><br><span class="line">          <span class="attr">hdPath</span>: path,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="function">(<span class="params">&#123; success, payload &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (success) &#123;</span><br><span class="line">          <span class="keyword">if</span> (updateHdk) &#123;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">hdk</span>.<span class="property">publicKey</span> = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(payload.<span class="property">publicKey</span>, <span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">hdk</span>.<span class="property">chainCode</span> = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(payload.<span class="property">chainCode</span>, <span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="title function_">resolve</span>(payload.<span class="property">address</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="title function_">reject</span>(payload.<span class="property">error</span> || <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Unknown error&#x27;</span>))</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 用户在导入账户页面选择了对应的账户地址并确认导入之后执行的逻辑</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  addAccounts (n = <span class="number">1</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">unlock</span>()</span><br><span class="line">        .<span class="title function_">then</span>(<span class="keyword">async</span> (_) =&gt; &#123;</span><br><span class="line">          <span class="keyword">const</span> <span class="keyword">from</span> = <span class="variable language_">this</span>.<span class="property">unlockedAccount</span></span><br><span class="line">          <span class="keyword">const</span> to = <span class="keyword">from</span> + n</span><br><span class="line">          <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="keyword">from</span>; i &lt; to; i++) &#123;</span><br><span class="line">            <span class="keyword">const</span> path = <span class="variable language_">this</span>.<span class="title function_">_getPathForIndex</span>(i)</span><br><span class="line">            <span class="keyword">let</span> address</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="title function_">_isLedgerLiveHdPath</span>()) &#123;</span><br><span class="line">              address = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">unlock</span>(path)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              address = <span class="variable language_">this</span>.<span class="title function_">_addressFromIndex</span>(pathBase, i)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">accountDetails</span>[ethUtil.<span class="title function_">toChecksumAddress</span>(address)] = &#123;</span><br><span class="line">              <span class="comment">// <span class="doctag">TODO:</span> consider renaming this property, as the current name is misleading</span></span><br><span class="line">              <span class="comment">// It&#x27;s currently used to represent whether an account uses the Ledger Live path.</span></span><br><span class="line">              <span class="attr">bip44</span>: <span class="variable language_">this</span>.<span class="title function_">_isLedgerLiveHdPath</span>(),</span><br><span class="line">              <span class="attr">hdPath</span>: path,</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">accounts</span>.<span class="title function_">includes</span>(address)) &#123;</span><br><span class="line">              <span class="variable language_">this</span>.<span class="property">accounts</span>.<span class="title function_">push</span>(address)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">page</span> = <span class="number">0</span></span><br><span class="line">          &#125;</span><br><span class="line">          <span class="title function_">resolve</span>(<span class="variable language_">this</span>.<span class="property">accounts</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_">catch</span>(reject)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  getFirstPage () &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">page</span> = <span class="number">0</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">__getPage</span>(<span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  getNextPage () &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">__getPage</span>(<span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  getPreviousPage () &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">__getPage</span>(-<span class="number">1</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  getAccounts () &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="variable language_">this</span>.<span class="property">accounts</span>.<span class="title function_">slice</span>())</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  removeAccount (address) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">accounts</span>.<span class="title function_">map</span>(<span class="function">(<span class="params">a</span>) =&gt;</span> a.<span class="title function_">toLowerCase</span>()).<span class="title function_">includes</span>(address.<span class="title function_">toLowerCase</span>())) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`Address <span class="subst">$&#123;address&#125;</span> not found in this keyring`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">accounts</span> = <span class="variable language_">this</span>.<span class="property">accounts</span>.<span class="title function_">filter</span>(<span class="function">(<span class="params">a</span>) =&gt;</span> a.<span class="title function_">toLowerCase</span>() !== address.<span class="title function_">toLowerCase</span>())</span><br><span class="line">    <span class="keyword">delete</span> <span class="variable language_">this</span>.<span class="property">accountDetails</span>[ethUtil.<span class="title function_">toChecksumAddress</span>(address)]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 更新链接 Ledger 的方法, 目前 Ledger 连接的方案有三种:</span></span><br><span class="line"><span class="comment">   * webHid</span></span><br><span class="line"><span class="comment">   * webU2F</span></span><br><span class="line"><span class="comment">   * Ledger Live 桥接</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * 用户可以在 MetaMask 设置页面进行设置</span></span><br><span class="line"><span class="comment">   * 目前 Chrome 支持 webHid, Ledger Live 桥接</span></span><br><span class="line"><span class="comment">   * Firefox 仅支持 webU2F 方案</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  updateTransportMethod (transportType) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// If the iframe isn&#x27;t loaded yet, let&#x27;s store the desired transportType value and</span></span><br><span class="line">      <span class="comment">// optimistically return a successful promise</span></span><br><span class="line">      <span class="keyword">if</span> (!<span class="variable language_">this</span>.<span class="property">iframeLoaded</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">delayedPromise</span> = &#123;</span><br><span class="line">          resolve,</span><br><span class="line">          reject,</span><br><span class="line">          transportType,</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">_sendMessage</span>(&#123;</span><br><span class="line">        <span class="attr">action</span>: <span class="string">&#x27;ledger-update-transport&#x27;</span>,</span><br><span class="line">        <span class="attr">params</span>: &#123; transportType &#125;,</span><br><span class="line">      &#125;, <span class="function">(<span class="params">&#123; success &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (success) &#123;</span><br><span class="line">          <span class="title function_">resolve</span>(<span class="literal">true</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Ledger transport could not be updated&#x27;</span>))</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// tx is an instance of the ethereumjs-transaction class.</span></span><br><span class="line">  <span class="comment">// 签署合约的方法</span></span><br><span class="line">  signTransaction (address, tx) &#123;</span><br><span class="line">    <span class="keyword">let</span> rawTxHex</span><br><span class="line">    <span class="comment">// transactions built with older versions of ethereumjs-tx have a</span></span><br><span class="line">    <span class="comment">// getChainId method that newer versions do not. Older versions are mutable</span></span><br><span class="line">    <span class="comment">// while newer versions default to being immutable. Expected shape and type</span></span><br><span class="line">    <span class="comment">// of data for v, r and s differ (Buffer (old) vs BN (new))</span></span><br><span class="line">    <span class="comment">// 对于老的 tx 实例, 具备 tx.getChainId 方法</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> tx.<span class="property">getChainId</span> === <span class="string">&#x27;function&#x27;</span>) &#123;</span><br><span class="line">      <span class="comment">// In this version of ethereumjs-tx we must add the chainId in hex format</span></span><br><span class="line">      <span class="comment">// to the initial v value. The chainId must be included in the serialized</span></span><br><span class="line">      <span class="comment">// transaction which is only communicated to ethereumjs-tx in this</span></span><br><span class="line">      <span class="comment">// value. In newer versions the chainId is communicated via the &#x27;Common&#x27;</span></span><br><span class="line">      <span class="comment">// object.</span></span><br><span class="line">      tx.<span class="property">v</span> = ethUtil.<span class="title function_">bufferToHex</span>(tx.<span class="title function_">getChainId</span>())</span><br><span class="line">      tx.<span class="property">r</span> = <span class="string">&#x27;0x00&#x27;</span></span><br><span class="line">      tx.<span class="property">s</span> = <span class="string">&#x27;0x00&#x27;</span></span><br><span class="line"></span><br><span class="line">      rawTxHex = tx.<span class="title function_">serialize</span>().<span class="title function_">toString</span>(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">_signTransaction</span>(address, rawTxHex, <span class="function">(<span class="params">payload</span>) =&gt;</span> &#123;</span><br><span class="line">        tx.<span class="property">v</span> = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(payload.<span class="property">v</span>, <span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line">        tx.<span class="property">r</span> = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(payload.<span class="property">r</span>, <span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line">        tx.<span class="property">s</span> = <span class="title class_">Buffer</span>.<span class="title function_">from</span>(payload.<span class="property">s</span>, <span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> tx</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// The below `encode` call is only necessary for legacy transactions, as `getMessageToSign`</span></span><br><span class="line">    <span class="comment">// calls `rlp.encode` internally for non-legacy transactions. As per the &quot;Transaction Execution&quot;</span></span><br><span class="line">    <span class="comment">// section of the ethereum yellow paper, transactions need to be &quot;well-formed RLP, with no additional</span></span><br><span class="line">    <span class="comment">// trailing bytes&quot;.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Note also that `getMessageToSign` will return valid RLP for all transaction types, whereas the</span></span><br><span class="line">    <span class="comment">// `serialize` method will not for any transaction type except legacy. This is because `serialize` includes</span></span><br><span class="line">    <span class="comment">// empty r, s and v values in the encoded rlp. This is why we use `getMessageToSign` here instead of `serialize`.</span></span><br><span class="line">    <span class="comment">// 对于新的 tx 实例, 则需要采用新的签署方法, MetaMask 在兼容 eip 1559 之后生成的 tx 均为新的 tx</span></span><br><span class="line">    <span class="keyword">const</span> messageToSign = tx.<span class="title function_">getMessageToSign</span>(<span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line">    rawTxHex = <span class="title class_">Buffer</span>.<span class="title function_">isBuffer</span>(messageToSign)</span><br><span class="line">      ? messageToSign.<span class="title function_">toString</span>(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line">      : ethUtil.<span class="property">rlp</span>.<span class="title function_">encode</span>(messageToSign).<span class="title function_">toString</span>(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">_signTransaction</span>(address, rawTxHex, <span class="function">(<span class="params">payload</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// Because tx will be immutable, first get a plain javascript object that</span></span><br><span class="line">      <span class="comment">// represents the transaction. Using txData here as it aligns with the</span></span><br><span class="line">      <span class="comment">// nomenclature of ethereumjs/tx.</span></span><br><span class="line">      <span class="keyword">const</span> txData = tx.<span class="title function_">toJSON</span>()</span><br><span class="line">      <span class="comment">// The fromTxData utility expects a type to support transactions with a type other than 0</span></span><br><span class="line">      txData.<span class="property">type</span> = tx.<span class="property">type</span></span><br><span class="line">      <span class="comment">// The fromTxData utility expects v,r and s to be hex prefixed</span></span><br><span class="line">      txData.<span class="property">v</span> = ethUtil.<span class="title function_">addHexPrefix</span>(payload.<span class="property">v</span>)</span><br><span class="line">      txData.<span class="property">r</span> = ethUtil.<span class="title function_">addHexPrefix</span>(payload.<span class="property">r</span>)</span><br><span class="line">      txData.<span class="property">s</span> = ethUtil.<span class="title function_">addHexPrefix</span>(payload.<span class="property">s</span>)</span><br><span class="line">      <span class="comment">// Adopt the &#x27;common&#x27; option from the original transaction and set the</span></span><br><span class="line">      <span class="comment">// returned object to be frozen if the original is frozen.</span></span><br><span class="line">      <span class="keyword">return</span> <span class="title class_">TransactionFactory</span>.<span class="title function_">fromTxData</span>(txData, &#123; <span class="attr">common</span>: tx.<span class="property">common</span>, <span class="attr">freeze</span>: <span class="title class_">Object</span>.<span class="title function_">isFrozen</span>(tx) &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 实际签署合约与硬件钱包驱动程序进行交互的方法, 将前置的签名方法中获取到的 rawTxHex 传递给硬件</span></span><br><span class="line">  <span class="comment">// 钱包驱动程序, 并且接收签名后返回的 signedHash</span></span><br><span class="line">  _signTransaction (address, rawTxHex, handleSigning) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">unlockAccountByAddress</span>(address)</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function">(<span class="params">hdPath</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">_sendMessage</span>(&#123;</span><br><span class="line">            <span class="attr">action</span>: <span class="string">&#x27;ledger-sign-transaction&#x27;</span>,</span><br><span class="line">            <span class="attr">params</span>: &#123;</span><br><span class="line">              <span class="attr">tx</span>: rawTxHex,</span><br><span class="line">              hdPath,</span><br><span class="line">            &#125;,</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="function">(<span class="params">&#123; success, payload &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (success) &#123;</span><br><span class="line"></span><br><span class="line">              <span class="keyword">const</span> newOrMutatedTx = <span class="title function_">handleSigning</span>(payload)</span><br><span class="line">              <span class="keyword">const</span> valid = newOrMutatedTx.<span class="title function_">verifySignature</span>()</span><br><span class="line">              <span class="keyword">if</span> (valid) &#123;</span><br><span class="line">                <span class="title function_">resolve</span>(newOrMutatedTx)</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Ledger: The transaction signature is not valid&#x27;</span>))</span><br><span class="line">              &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="title function_">reject</span>(payload.<span class="property">error</span> || <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Ledger: Unknown error while signing transaction&#x27;</span>))</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_">catch</span>(reject)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// signPersonalMessage 的封装</span></span><br><span class="line">  signMessage (withAccount, data) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">signPersonalMessage</span>(withAccount, data)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// For personal_sign, we need to prefix the message:</span></span><br><span class="line">  signPersonalMessage (withAccount, message) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">unlockAccountByAddress</span>(withAccount)</span><br><span class="line">        .<span class="title function_">then</span>(<span class="function">(<span class="params">hdPath</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="title function_">_sendMessage</span>(&#123;</span><br><span class="line">            <span class="attr">action</span>: <span class="string">&#x27;ledger-sign-personal-message&#x27;</span>,</span><br><span class="line">            <span class="attr">params</span>: &#123;</span><br><span class="line">              hdPath,</span><br><span class="line">              <span class="attr">message</span>: ethUtil.<span class="title function_">stripHexPrefix</span>(message),</span><br><span class="line">            &#125;,</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="function">(<span class="params">&#123; success, payload &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (success) &#123;</span><br><span class="line">              <span class="keyword">let</span> v = payload.<span class="property">v</span> - <span class="number">27</span></span><br><span class="line">              v = v.<span class="title function_">toString</span>(<span class="number">16</span>)</span><br><span class="line">              <span class="keyword">if</span> (v.<span class="property">length</span> &lt; <span class="number">2</span>) &#123;</span><br><span class="line">                v = <span class="string">`0<span class="subst">$&#123;v&#125;</span>`</span></span><br><span class="line">              &#125;</span><br><span class="line">              <span class="keyword">const</span> signature = <span class="string">`0x<span class="subst">$&#123;payload.r&#125;</span><span class="subst">$&#123;payload.s&#125;</span><span class="subst">$&#123;v&#125;</span>`</span></span><br><span class="line">              <span class="keyword">const</span> addressSignedWith = sigUtil.<span class="title function_">recoverPersonalSignature</span>(&#123; <span class="attr">data</span>: message, <span class="attr">sig</span>: signature &#125;)</span><br><span class="line">              <span class="keyword">if</span> (ethUtil.<span class="title function_">toChecksumAddress</span>(addressSignedWith) !== ethUtil.<span class="title function_">toChecksumAddress</span>(withAccount)) &#123;</span><br><span class="line">                <span class="title function_">reject</span>(<span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Ledger: The signature doesnt match the right address&#x27;</span>))</span><br><span class="line">              &#125;</span><br><span class="line">              <span class="title function_">resolve</span>(signature)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="title function_">reject</span>(payload.<span class="property">error</span> || <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Ledger: Unknown error while signing message&#x27;</span>))</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;)</span><br><span class="line">        .<span class="title function_">catch</span>(reject)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> unlockAccountByAddress (address) &#123;</span><br><span class="line">    <span class="keyword">const</span> checksummedAddress = ethUtil.<span class="title function_">toChecksumAddress</span>(address)</span><br><span class="line">    <span class="keyword">if</span> (!<span class="title class_">Object</span>.<span class="title function_">keys</span>(<span class="variable language_">this</span>.<span class="property">accountDetails</span>).<span class="title function_">includes</span>(checksummedAddress)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`Ledger: Account for address &#x27;<span class="subst">$&#123;checksummedAddress&#125;</span>&#x27; not found`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> &#123; hdPath &#125; = <span class="variable language_">this</span>.<span class="property">accountDetails</span>[checksummedAddress]</span><br><span class="line">    <span class="keyword">const</span> unlockedAddress = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">unlock</span>(hdPath, <span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// unlock resolves to the address for the given hdPath as reported by the ledger device</span></span><br><span class="line">    <span class="comment">// if that address is not the requested address, then this account belongs to a different device or seed</span></span><br><span class="line">    <span class="keyword">if</span> (unlockedAddress.<span class="title function_">toLowerCase</span>() !== address.<span class="title function_">toLowerCase</span>()) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">`Ledger: Account <span class="subst">$&#123;address&#125;</span> does not belong to the connected device`</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> hdPath</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 目前 Ledger 仅支持 V4 Data 的签署</span></span><br><span class="line">  <span class="keyword">async</span> signTypedData (withAccount, data, options = &#123;&#125;) &#123;</span><br><span class="line">    <span class="keyword">const</span> isV4 = options.<span class="property">version</span> === <span class="string">&#x27;V4&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> (!isV4) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Ledger: Only version 4 of typed data signing is supported&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">      domain,</span><br><span class="line">      types,</span><br><span class="line">      primaryType,</span><br><span class="line">      message,</span><br><span class="line">    &#125; = sigUtil.<span class="property">TypedDataUtils</span>.<span class="title function_">sanitizeData</span>(data)</span><br><span class="line">    <span class="keyword">const</span> domainSeparatorHex = sigUtil.<span class="property">TypedDataUtils</span>.<span class="title function_">hashStruct</span>(<span class="string">&#x27;EIP712Domain&#x27;</span>, domain, types, isV4).<span class="title function_">toString</span>(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line">    <span class="keyword">const</span> hashStructMessageHex = sigUtil.<span class="property">TypedDataUtils</span>.<span class="title function_">hashStruct</span>(primaryType, message, types, isV4).<span class="title function_">toString</span>(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> hdPath = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">unlockAccountByAddress</span>(withAccount)</span><br><span class="line">    <span class="keyword">const</span> &#123; success, payload &#125; = <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">_sendMessage</span>(&#123;</span><br><span class="line">        <span class="attr">action</span>: <span class="string">&#x27;ledger-sign-typed-data&#x27;</span>,</span><br><span class="line">        <span class="attr">params</span>: &#123;</span><br><span class="line">          hdPath,</span><br><span class="line">          domainSeparatorHex,</span><br><span class="line">          hashStructMessageHex,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="function">(<span class="params">result</span>) =&gt;</span> <span class="title function_">resolve</span>(result))</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (success) &#123;</span><br><span class="line">      <span class="keyword">let</span> v = payload.<span class="property">v</span> - <span class="number">27</span></span><br><span class="line">      v = v.<span class="title function_">toString</span>(<span class="number">16</span>)</span><br><span class="line">      <span class="keyword">if</span> (v.<span class="property">length</span> &lt; <span class="number">2</span>) &#123;</span><br><span class="line">        v = <span class="string">`0<span class="subst">$&#123;v&#125;</span>`</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> signature = <span class="string">`0x<span class="subst">$&#123;payload.r&#125;</span><span class="subst">$&#123;payload.s&#125;</span><span class="subst">$&#123;v&#125;</span>`</span></span><br><span class="line">      <span class="keyword">const</span> addressSignedWith = sigUtil.<span class="title function_">recoverTypedSignature_v4</span>(&#123;</span><br><span class="line">        data,</span><br><span class="line">        <span class="attr">sig</span>: signature,</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="keyword">if</span> (ethUtil.<span class="title function_">toChecksumAddress</span>(addressSignedWith) !== ethUtil.<span class="title function_">toChecksumAddress</span>(withAccount)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Ledger: The signature doesnt match the right address&#x27;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> signature</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> payload.<span class="property">error</span> || <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Ledger: Unknown error while signing message&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  exportAccount () &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Not supported on this device&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  forgetDevice () &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">accounts</span> = []</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">page</span> = <span class="number">0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">unlockedAccount</span> = <span class="number">0</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">paths</span> = &#123;&#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">accountDetails</span> = &#123;&#125;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">hdk</span> = <span class="keyword">new</span> <span class="title class_">HDKey</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* PRIVATE METHODS */</span></span><br><span class="line"></span><br><span class="line">  _setupIframe () &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">iframe</span> = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&#x27;iframe&#x27;</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">iframe</span>.<span class="property">src</span> = <span class="variable language_">this</span>.<span class="property">bridgeUrl</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">iframe</span>.<span class="property">allow</span> = <span class="string">`hid &#x27;src&#x27;`</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">iframe</span>.<span class="property">onload</span> = <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">      <span class="comment">// If the ledger live preference was set before the iframe is loaded,</span></span><br><span class="line">      <span class="comment">// set it after the iframe has loaded</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">iframeLoaded</span> = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">delayedPromise</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> result = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">updateTransportMethod</span>(</span><br><span class="line">            <span class="variable language_">this</span>.<span class="property">delayedPromise</span>.<span class="property">transportType</span>,</span><br><span class="line">          )</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">delayedPromise</span>.<span class="title function_">resolve</span>(result)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">delayedPromise</span>.<span class="title function_">reject</span>(e)</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          <span class="keyword">delete</span> <span class="variable language_">this</span>.<span class="property">delayedPromise</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">document</span>.<span class="property">head</span>.<span class="title function_">appendChild</span>(<span class="variable language_">this</span>.<span class="property">iframe</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  _getOrigin () &#123;</span><br><span class="line">    <span class="keyword">const</span> tmp = <span class="variable language_">this</span>.<span class="property">bridgeUrl</span>.<span class="title function_">split</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">    tmp.<span class="title function_">splice</span>(-<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> tmp.<span class="title function_">join</span>(<span class="string">&#x27;/&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  _sendMessage (msg, cb) &#123;</span><br><span class="line">    msg.<span class="property">target</span> = <span class="string">&#x27;LEDGER-IFRAME&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">currentMessageId</span> += <span class="number">1</span></span><br><span class="line">    msg.<span class="property">messageId</span> = <span class="variable language_">this</span>.<span class="property">currentMessageId</span></span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">messageCallbacks</span>[<span class="variable language_">this</span>.<span class="property">currentMessageId</span>] = cb</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">iframe</span>.<span class="property">contentWindow</span>.<span class="title function_">postMessage</span>(msg, <span class="string">&#x27;*&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  _setupListener () &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_eventListener</span> = <span class="function">(<span class="params">&#123; origin, data &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (origin !== <span class="variable language_">this</span>.<span class="title function_">_getOrigin</span>()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (data) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">messageCallbacks</span>[data.<span class="property">messageId</span>]) &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">messageCallbacks</span>[data.<span class="property">messageId</span>](data)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (data.<span class="property">action</span> === <span class="variable constant_">CONNECTION_EVENT</span>) &#123;</span><br><span class="line">          <span class="variable language_">this</span>.<span class="property">isDeviceConnected</span> = data.<span class="property">payload</span>.<span class="property">connected</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">undefined</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&#x27;message&#x27;</span>, <span class="variable language_">this</span>.<span class="property">_eventListener</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  destroy () &#123;</span><br><span class="line">    <span class="variable language_">window</span>.<span class="title function_">removeEventListener</span>(<span class="string">&#x27;message&#x27;</span>, <span class="variable language_">this</span>.<span class="property">_eventListener</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 派生账户的方法</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">async</span> __getPage (increment) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">page</span> += increment</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">page</span> &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">page</span> = <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">from</span> = (<span class="variable language_">this</span>.<span class="property">page</span> - <span class="number">1</span>) * <span class="variable language_">this</span>.<span class="property">perPage</span></span><br><span class="line">    <span class="keyword">const</span> to = <span class="keyword">from</span> + <span class="variable language_">this</span>.<span class="property">perPage</span></span><br><span class="line">    <span class="comment">// 用户解锁后就能拿到初始 path 的 publicKey</span></span><br><span class="line">    <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">unlock</span>()</span><br><span class="line">    <span class="keyword">let</span> accounts</span><br><span class="line">    <span class="comment">// 利用上述过程中的 publicKey 通过算法派生出当前页面待选择的 address 可供用户选择</span></span><br><span class="line">    <span class="comment">// 由于每次获取到的 publicKey 是相同的, 所以即使多次导入相同的钱包派生出来的 address 也会</span></span><br><span class="line">    <span class="comment">// 相同不用担心这次导入的硬件钱包转入代币, 下次从别的钱包导入之后找不到了</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="title function_">_isLedgerLiveHdPath</span>()) &#123;</span><br><span class="line">      accounts = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">_getAccountsBIP44</span>(<span class="keyword">from</span>, to)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      accounts = <span class="variable language_">this</span>.<span class="title function_">_getAccountsLegacy</span>(<span class="keyword">from</span>, to)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> accounts</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 使用 LedgerLiveHdPath 作为基础 path 时派生 address 的方法, 这种使用这种方法每次都需要</span></span><br><span class="line">  <span class="comment">// 调用硬件钱包去解锁每个 path 对应的 address</span></span><br><span class="line">  <span class="keyword">async</span> _getAccountsBIP44 (<span class="keyword">from</span>, to) &#123;</span><br><span class="line">    <span class="keyword">const</span> accounts = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="keyword">from</span>; i &lt; to; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> path = <span class="variable language_">this</span>.<span class="title function_">_getPathForIndex</span>(i)</span><br><span class="line">      <span class="keyword">const</span> address = <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">unlock</span>(path)</span><br><span class="line">      <span class="keyword">const</span> valid = <span class="variable language_">this</span>.<span class="property">implementFullBIP44</span> ? <span class="keyword">await</span> <span class="variable language_">this</span>.<span class="title function_">_hasPreviousTransactions</span>(address) : <span class="literal">true</span></span><br><span class="line">      accounts.<span class="title function_">push</span>(&#123;</span><br><span class="line">        address,</span><br><span class="line">        <span class="attr">balance</span>: <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">index</span>: i,</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="comment">// PER BIP44</span></span><br><span class="line">      <span class="comment">// &quot;Software should prevent a creation of an account if</span></span><br><span class="line">      <span class="comment">// a previous account does not have a transaction history</span></span><br><span class="line">      <span class="comment">// (meaning none of its addresses have been used before).&quot;</span></span><br><span class="line">      <span class="keyword">if</span> (!valid) &#123;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> accounts</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 使用 Legacy (MEW / MyCrypto) 或者</span></span><br><span class="line">  <span class="comment">// BIP44 Standard (Trezor)  作为基础 path 时派生 address 的方法</span></span><br><span class="line">  <span class="comment">// 实际的派生方法为 _addressFromIndex</span></span><br><span class="line">  _getAccountsLegacy (<span class="keyword">from</span>, to) &#123;</span><br><span class="line">    <span class="keyword">const</span> accounts = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="keyword">from</span>; i &lt; to; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> address = <span class="variable language_">this</span>.<span class="title function_">_addressFromIndex</span>(pathBase, i)</span><br><span class="line">      accounts.<span class="title function_">push</span>(&#123;</span><br><span class="line">        address,</span><br><span class="line">        <span class="attr">balance</span>: <span class="literal">null</span>,</span><br><span class="line">        <span class="attr">index</span>: i,</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">paths</span>[ethUtil.<span class="title function_">toChecksumAddress</span>(address)] = i</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> accounts</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// eslint-disable-next-line no-shadow</span></span><br><span class="line">  _addressFromIndex (pathBase, i) &#123;</span><br><span class="line">    <span class="keyword">const</span> dkey = <span class="variable language_">this</span>.<span class="property">hdk</span>.<span class="title function_">derive</span>(<span class="string">`<span class="subst">$&#123;pathBase&#125;</span>/<span class="subst">$&#123;i&#125;</span>`</span>)</span><br><span class="line">    <span class="keyword">const</span> address = ethUtil</span><br><span class="line">      .<span class="title function_">publicToAddress</span>(dkey.<span class="property">publicKey</span>, <span class="literal">true</span>)</span><br><span class="line">      .<span class="title function_">toString</span>(<span class="string">&#x27;hex&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> ethUtil.<span class="title function_">toChecksumAddress</span>(<span class="string">`0x<span class="subst">$&#123;address&#125;</span>`</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  _pathFromAddress (address) &#123;</span><br><span class="line">    <span class="keyword">const</span> checksummedAddress = ethUtil.<span class="title function_">toChecksumAddress</span>(address)</span><br><span class="line">    <span class="keyword">let</span> index = <span class="variable language_">this</span>.<span class="property">paths</span>[checksummedAddress]</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> index === <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="variable constant_">MAX_INDEX</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (checksummedAddress === <span class="variable language_">this</span>.<span class="title function_">_addressFromIndex</span>(pathBase, i)) &#123;</span><br><span class="line">          index = i</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> index === <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;Unknown address&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">_getPathForIndex</span>(index)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  _getPathForIndex (index) &#123;</span><br><span class="line">    <span class="comment">// Check if the path is BIP 44 (Ledger Live)</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">_isLedgerLiveHdPath</span>() ? <span class="string">`m/44&#x27;/60&#x27;/<span class="subst">$&#123;index&#125;</span>&#x27;/0/0`</span> : <span class="string">`<span class="subst">$&#123;<span class="variable language_">this</span>.hdPath&#125;</span>/<span class="subst">$&#123;index&#125;</span>`</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  _isLedgerLiveHdPath () &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">hdPath</span> === <span class="string">`m/44&#x27;/60&#x27;/0&#x27;/0/0`</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  _toLedgerPath (path) &#123;</span><br><span class="line">    <span class="keyword">return</span> path.<span class="title function_">toString</span>().<span class="title function_">replace</span>(<span class="string">&#x27;m/&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 派生 implementFullBIP44 格式的地址时候会先判断当前生成数来的 address 是否被使用过</span></span><br><span class="line">  <span class="comment">// 只有被使用过的才被认为是合法的</span></span><br><span class="line">  <span class="keyword">async</span> _hasPreviousTransactions (address) &#123;</span><br><span class="line">    <span class="keyword">const</span> apiUrl = <span class="variable language_">this</span>.<span class="title function_">_getApiUrl</span>()</span><br><span class="line">    <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="variable language_">window</span>.<span class="title function_">fetch</span>(<span class="string">`<span class="subst">$&#123;apiUrl&#125;</span>/api?module=account&amp;action=txlist&amp;address=<span class="subst">$&#123;address&#125;</span>&amp;tag=latest&amp;page=1&amp;offset=1`</span>)</span><br><span class="line">    <span class="keyword">const</span> parsedResponse = <span class="keyword">await</span> response.<span class="title function_">json</span>()</span><br><span class="line">    <span class="keyword">if</span> (parsedResponse.<span class="property">status</span> !== <span class="string">&#x27;0&#x27;</span> &amp;&amp; parsedResponse.<span class="property">result</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  _getApiUrl () &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable constant_">NETWORK_API_URLS</span>[<span class="variable language_">this</span>.<span class="property">network</span>] || <span class="variable constant_">NETWORK_API_URLS</span>.<span class="property">mainnet</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="title class_">LedgerBridgeKeyring</span>.<span class="property">type</span> = type</span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = <span class="title class_">LedgerBridgeKeyring</span></span><br></pre></td></tr></table></figure><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a target="_blank" rel="noopener" href="https://github.com/MetaMask/eth-simple-keyring#the-keyring-class-protocol">Simple Keyring</a></li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/" rel="tag"># 开发笔记</a></div><div class="post-nav"><div class="post-nav-item"><a href="/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E5%8C%BA%E5%9D%97%E9%93%BE%E6%8A%80%E6%9C%AF%E4%B8%8E%E5%BA%94%E7%94%A8/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E5%8C%BA%E5%9D%97%E9%93%BE%E6%8A%80%E6%9C%AF%E4%B8%8E%E5%BA%94%E7%94%A8/4.%20%E6%AF%94%E7%89%B9%E5%B8%81%E7%9A%84%E5%85%B1%E8%AF%86%E5%8D%8F%E8%AE%AE/" rel="prev" title="4. 比特币的共识协议"><i class="fa fa-chevron-left"></i> 4. 比特币的共识协议</a></div><div class="post-nav-item"> <a href="/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/MetaMask-%E6%BA%90%E7%A0%81/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/MetaMask%20%E6%BA%90%E7%A0%81/%E5%B0%8F%E7%8B%90%E7%8B%B8%E4%BE%9D%E8%B5%96-eth-trezor-keyring/" rel="next" title="小狐狸依赖-eth-trezor-keyring">小狐狸依赖-eth-trezor-keyring<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div><script>
  window.addEventListener('tabs:register', function() {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%9F%BA%E7%A1%80%E9%80%BB%E8%BE%91"><span class="nav-text">基础逻辑</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%8D%E8%AF%8D%E8%A7%A3%E9%87%8A"><span class="nav-text">名词解释</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%A1%AC%E4%BB%B6%E9%92%B1%E5%8C%85%E8%B4%A6%E5%8F%B7%E5%AF%BC%E5%85%A5"><span class="nav-text">硬件钱包账号导入</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AD%BE%E7%BD%B2%E5%90%88%E7%BA%A6"><span class="nav-text">签署合约</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-text">源码分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-text">参考资料</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="圈圈的圈" src="/images/avatar.png"><p class="site-author-name" itemprop="name">圈圈的圈</p><div class="site-description" itemprop="description">技术学习, 读书笔记, 生活感悟 ~</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">142</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">35</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">8</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://juejin.im/user/5837c2bd61ff4b006ca8d1b2" title="掘金 → https:&#x2F;&#x2F;juejin.im&#x2F;user&#x2F;5837c2bd61ff4b006ca8d1b2" rel="noopener" target="_blank"><i class="fa fa-fw fa-stack-overflow"></i> 掘金</a></span><span class="links-of-author-item"><a href="https://github.com/luoquanquan" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;luoquanquan" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:luo_quanquan@163.com" title="E-Mail → mailto:luo_quanquan@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="beian"><a href="http://www.beian.miit.gov.cn/" rel="noopener" target="_blank">京ICP备17034706号-1</a></div><div class="copyright"> &copy; <span itemprop="copyrightYear">2024</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">圈圈的圈</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer></div><script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/js/theme-next-canvas-nest/canvas-nest.min.js"></script><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script></body></html>
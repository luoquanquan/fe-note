<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png"><link rel="icon" type="image/png" sizes="16x16" href="/images/favicon.png"><link rel="mask-icon" href="/images/logo.svg" color="#222"><link rel="stylesheet" href="/css/main.css"><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css"><script id="hexo-configurations">var NexT=window.NexT||{},CONFIG={hostname:new URL("http://note.niubishanshan.top").hostname,root:"/",scheme:"Gemini",version:"7.7.0",exturl:!1,sidebar:{position:"left",display:"post",padding:18,offset:12,onmobile:!1},copycode:{enable:!1,show_result:!1,style:null},back2top:{enable:!0,sidebar:!1,scrollpercent:!0},bookmark:{enable:!1,color:"#222",save:"auto"},fancybox:!1,mediumzoom:!1,lazyload:!1,pangu:!1,comments:{style:"tabs",active:null,storage:!0,lazyload:!1,nav:null},algolia:{appID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}},localsearch:{enable:!0,trigger:"auto",top_n_per_article:1,unescape:!1,preload:!1},path:"search.json",motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}}}</script><meta name="description" content="pump is a small node module that pipes streams together and destroys all of them if one of them closes.  在 metamask 中各运行时的通信使用到了流(stream), 相对于 postMessage 的好处是处理大数据不会卡内存. 但是在 stream 中处理过程中, 如果目标流关闭了其"><meta property="og:type" content="article"><meta property="og:title" content="小狐狸依赖-pump"><meta property="og:url" content="http://note.niubishanshan.top/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/MetaMask-%E6%BA%90%E7%A0%81/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/MetaMask%20%E6%BA%90%E7%A0%81/%E5%B0%8F%E7%8B%90%E7%8B%B8%E4%BE%9D%E8%B5%96-pump/index.html"><meta property="og:site_name" content="圈圈的笔记"><meta property="og:description" content="pump is a small node module that pipes streams together and destroys all of them if one of them closes.  在 metamask 中各运行时的通信使用到了流(stream), 相对于 postMessage 的好处是处理大数据不会卡内存. 但是在 stream 中处理过程中, 如果目标流关闭了其"><meta property="og:locale" content="zh_CN"><meta property="article:published_time" content="2022-10-03T08:58:28.000Z"><meta property="article:modified_time" content="2024-06-27T15:04:43.291Z"><meta property="article:author" content="圈圈的圈"><meta property="article:tag" content="开发笔记"><meta name="twitter:card" content="summary"><link rel="canonical" href="http://note.niubishanshan.top/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/MetaMask-%E6%BA%90%E7%A0%81/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/MetaMask%20%E6%BA%90%E7%A0%81/%E5%B0%8F%E7%8B%90%E7%8B%B8%E4%BE%9D%E8%B5%96-pump/"><script id="page-configurations">CONFIG.page={sidebar:"",isHome:!1,isPost:!0}</script><title>小狐狸依赖-pump | 圈圈的笔记</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-header,.use-motion .comments,.use-motion .menu-item,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope itemtype="http://schema.org/WebPage"><div class="container use-motion"><div class="headband"></div> <a target="_blank" rel="noopener" href="https://github.com/luoquanquan" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"></path><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"></path><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style><header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-container"><div class="site-meta"><div><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">圈圈的笔记</span><span class="logo-line-after"><i></i></span></a></div><p class="site-subtitle">路漫漫其修远兮, 吾将上下而求索</p></div><div class="site-nav-toggle"><div class="toggle" aria-label="切换导航栏"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-fw fa-home"></i> 首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i> 标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i> 分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i> 归档</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i> 关于</a></li><li class="menu-item menu-item-search"><a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i> 搜索</a></li></ul></nav><div class="site-search"><div class="popup search-popup"><div class="search-header"><span class="search-icon"><i class="fa fa-search"></i></span><div class="search-input-container"> <input autocomplete="off" autocorrect="off" autocapitalize="none" placeholder="搜索..." spellcheck="false" type="text" id="search-input"></div><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span></div><div id="search-result"></div></div><div class="search-pop-overlay"></div></div></div></header><div class="back-to-top"><i class="fa fa-arrow-up"></i> <span>0%</span></div><main class="main"><div class="main-inner"><div class="content-wrap"><div class="content"><div class="posts-expand"><article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN"><link itemprop="mainEntityOfPage" href="http://note.niubishanshan.top/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/MetaMask-%E6%BA%90%E7%A0%81/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/MetaMask%20%E6%BA%90%E7%A0%81/%E5%B0%8F%E7%8B%90%E7%8B%B8%E4%BE%9D%E8%B5%96-pump/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.png"><meta itemprop="name" content="圈圈的圈"><meta itemprop="description" content="技术学习, 读书笔记, 生活感悟 ~"></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="圈圈的笔记"></span><header class="post-header"><h1 class="post-title" itemprop="name headline"> 小狐狸依赖-pump</h1><div class="post-meta"><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2022-10-03 16:58:28" itemprop="dateCreated datePublished" datetime="2022-10-03T16:58:28+08:00">2022-10-03</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2024-06-27 23:04:43" itemprop="dateModified" datetime="2024-06-27T23:04:43+08:00">2024-06-27</time></span><span class="post-meta-item"><span class="post-meta-item-icon"><i class="fa fa-folder-o"></i></span> <span class="post-meta-item-text">分类于</span> <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">开发笔记</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/" itemprop="url" rel="index"><span itemprop="name">web3</span></a></span> ， <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/web3/MetaMask-%E6%BA%90%E7%A0%81/" itemprop="url" rel="index"><span itemprop="name">MetaMask 源码</span></a></span></span><span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display:none"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span> <span class="post-meta-item-text">阅读次数：</span><span id="busuanzi_value_page_pv"></span></span></div></header><div class="post-body" itemprop="articleBody"><blockquote><p>pump is a small node module that pipes streams together and destroys all of them if one of them closes.</p></blockquote><p>在 metamask 中各运行时的通信使用到了流(stream), 相对于 <code>postMessage</code> 的好处是处理大数据不会卡内存. 但是在 stream 中处理过程中, 如果目标流关闭了其状态是不会通知给数据源流. 数据源还会源源不断的写入数据, 但是没有目标流会获取这些数据了…</p><span id="more"></span><h2 id="stream-的使用"><a href="#stream-的使用" class="headerlink" title="stream 的使用"></a>stream 的使用</h2><p>首先, 我们回顾一下 stream 的使用, 在任意一个目录创建 index.js 写下如下代码.</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js</span></span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> readStream = fs.<span class="title function_">createReadStream</span>(<span class="string">&#x27;./index.js&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> writeStream = fs.<span class="title function_">createWriteStream</span>(<span class="string">&#x27;./dest&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    readStream.<span class="title function_">pipe</span>(writeStream)</span><br><span class="line">&#125;, <span class="number">1e3</span>)</span><br></pre></td></tr></table></figure><p>上述代码中, 我们创建了一个可读流 <code>readStream</code> 用于读取当前的 index.js 文件. 然后创建了一个可写流用于往 dest 文件中写入内容.</p><p>定时器 1s 后执行 <code>readStream.pipe(writeStream)</code> 将可读流的内容传递给可写流.</p><p>执行 <code>node index.js</code> 之后会发现目录中多了个 dest 文件, 文件内容和 <code>index.js</code> 一样.</p><p>示例代码在<a target="_blank" rel="noopener" href="https://github.com/luoquanquan/learn-fe/tree/pump-v1/metamask-learn/pump-learn">这里</a></p><h2 id="原生的流处理存在的问题"><a href="#原生的流处理存在的问题" class="headerlink" title="原生的流处理存在的问题"></a>原生的流处理存在的问题</h2><p>在刚刚的示例中, 我们定时 1s 后写入内容. 当 writeStream 流关闭或者完成的事件是不会通知给 readStream 的. 也就是说, 如果在调用 pipe 之前调用了 writeStream.destroy() 关闭可写流. 程序依然可以执行只是没有预期的效果. 气人的是, 连报错都没有…</p><p>当前步骤的示例代码在<a target="_blank" rel="noopener" href="https://github.com/luoquanquan/learn-fe/tree/pump-v1.1/metamask-learn/pump-learn">这里</a></p><h2 id="使用-pump-规范化流的处理流程"><a href="#使用-pump-规范化流的处理流程" class="headerlink" title="使用 pump 规范化流的处理流程"></a>使用 pump 规范化流的处理流程</h2><p>在项目中引入 pump 并包装可读流和可写流. 修改 index.js 的代码如下:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> pump = <span class="built_in">require</span>(<span class="string">&#x27;pump&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> readStream = fs.<span class="title function_">createReadStream</span>(<span class="string">&#x27;./index.js&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> writeStream = fs.<span class="title function_">createWriteStream</span>(<span class="string">&#x27;./dest&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// writeStream.destroy()</span></span><br><span class="line"></span><br><span class="line">    <span class="title function_">pump</span>(readStream, writeStream, <span class="function"><span class="params">err</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (err) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(err)</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;发生错误, 写入失败 ~&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;写入完成&#x27;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;, <span class="number">1e3</span>)</span><br></pre></td></tr></table></figure><p>执行 node index.js 之后可以成功读取并写入文件. 但是如果在写入之前关闭可写流的话(放开 <code>// writeStream.destroy()</code> 的注释), 控制台会报出错误. 业务代码可以通过规范化的错误信息做出相应的处理.</p><p>当前步骤的代码在<a target="_blank" rel="noopener" href="https://github.com/luoquanquan/learn-fe/tree/pump-v2/metamask-learn/pump-learn">这里</a></p><h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// https://www.npmjs.com/package/once</span></span><br><span class="line"><span class="comment">// Only call a function once.</span></span><br><span class="line"><span class="keyword">var</span> once = <span class="built_in">require</span>(<span class="string">&#x27;once&#x27;</span>)</span><br><span class="line"><span class="comment">// https://www.npmjs.com/package/end-of-stream</span></span><br><span class="line"><span class="comment">// A node module that calls a callback when a readable/writable/duplex stream has completed or failed.</span></span><br><span class="line"><span class="keyword">var</span> eos = <span class="built_in">require</span>(<span class="string">&#x27;end-of-stream&#x27;</span>)</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>) <span class="comment">// we only need fs to get the ReadStream and WriteStream prototypes</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> noop = <span class="keyword">function</span> (<span class="params"></span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// https://nodejs.org/api/process.html#processversion</span></span><br><span class="line"><span class="comment">// ancient 古老的</span></span><br><span class="line"><span class="keyword">var</span> ancient = <span class="regexp">/^v?\.0/</span>.<span class="title function_">test</span>(process.<span class="property">version</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> isFn = <span class="keyword">function</span> (<span class="params">fn</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">typeof</span> fn === <span class="string">&#x27;function&#x27;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 是否为文件流</span></span><br><span class="line"><span class="keyword">var</span> isFS = <span class="keyword">function</span> (<span class="params">stream</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!ancient) <span class="keyword">return</span> <span class="literal">false</span> <span class="comment">// newer node version do not need to care about fs is a special way</span></span><br><span class="line">  <span class="keyword">if</span> (!fs) <span class="keyword">return</span> <span class="literal">false</span> <span class="comment">// browser</span></span><br><span class="line">  <span class="keyword">return</span> (stream <span class="keyword">instanceof</span> (fs.<span class="property">ReadStream</span> || noop) || stream <span class="keyword">instanceof</span> (fs.<span class="property">WriteStream</span> || noop)) &amp;&amp; <span class="title function_">isFn</span>(stream.<span class="property">close</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 是否是请求</span></span><br><span class="line"><span class="keyword">var</span> isRequest = <span class="keyword">function</span> (<span class="params">stream</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> stream.<span class="property">setHeader</span> &amp;&amp; <span class="title function_">isFn</span>(stream.<span class="property">abort</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 销毁流</span></span><br><span class="line"><span class="keyword">var</span> destroyer = <span class="keyword">function</span> (<span class="params">stream, reading, writing, callback</span>) &#123;</span><br><span class="line">  <span class="comment">// 确保 callback 只会执行一次</span></span><br><span class="line">  callback = <span class="title function_">once</span>(callback)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 监听流的关闭事件</span></span><br><span class="line">  <span class="keyword">var</span> closed = <span class="literal">false</span></span><br><span class="line">  stream.<span class="title function_">on</span>(<span class="string">&#x27;close&#x27;</span>, <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">    closed = <span class="literal">true</span></span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 监听流的结束事件</span></span><br><span class="line">  <span class="title function_">eos</span>(stream, &#123;<span class="attr">readable</span>: reading, <span class="attr">writable</span>: writing&#125;, <span class="keyword">function</span> (<span class="params">err</span>) &#123;</span><br><span class="line">    <span class="comment">// 如果当前流完成或者出错了直接调用回调函数</span></span><br><span class="line">    <span class="keyword">if</span> (err) <span class="keyword">return</span> <span class="title function_">callback</span>(err)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果当前流非错误关闭修改关闭标识</span></span><br><span class="line">    closed = <span class="literal">true</span></span><br><span class="line">    <span class="title function_">callback</span>()</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> destroyed = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">function</span> (<span class="params">err</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (closed) <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">if</span> (destroyed) <span class="keyword">return</span></span><br><span class="line">    destroyed = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isFS</span>(stream)) <span class="keyword">return</span> stream.<span class="title function_">close</span>(noop) <span class="comment">// use close for fs streams to avoid fd leaks</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isRequest</span>(stream)) <span class="keyword">return</span> stream.<span class="title function_">abort</span>() <span class="comment">// request.destroy just do .end - .abort is what we want</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">isFn</span>(stream.<span class="property">destroy</span>)) <span class="keyword">return</span> stream.<span class="title function_">destroy</span>()</span><br><span class="line"></span><br><span class="line">    <span class="title function_">callback</span>(err || <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;stream was destroyed&#x27;</span>))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> call = <span class="keyword">function</span> (<span class="params">fn</span>) &#123;</span><br><span class="line">  <span class="title function_">fn</span>()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 管道</span></span><br><span class="line"><span class="keyword">var</span> pipe = <span class="keyword">function</span> (<span class="params"><span class="keyword">from</span>, to</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">from</span>.<span class="title function_">pipe</span>(to)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> pump = <span class="keyword">function</span> (<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// 参数处理</span></span><br><span class="line">  <span class="keyword">var</span> streams = <span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">slice</span>.<span class="title function_">call</span>(<span class="variable language_">arguments</span>)</span><br><span class="line">  <span class="comment">// 默认认为最后一个参数为回调函数</span></span><br><span class="line">  <span class="keyword">var</span> callback = <span class="title function_">isFn</span>(streams[streams.<span class="property">length</span> - <span class="number">1</span>] || noop) &amp;&amp; streams.<span class="title function_">pop</span>() || noop</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 兼容以数组的形式传入参数</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="title class_">Array</span>.<span class="title function_">isArray</span>(streams[<span class="number">0</span>])) streams = streams[<span class="number">0</span>]</span><br><span class="line">  <span class="keyword">if</span> (streams.<span class="property">length</span> &lt; <span class="number">2</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&#x27;pump requires two streams per minimum&#x27;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> error</span><br><span class="line">  <span class="keyword">var</span> destroys = streams.<span class="title function_">map</span>(<span class="keyword">function</span> (<span class="params">stream, i</span>) &#123;</span><br><span class="line">    <span class="comment">// 除了最后一个都是可读的流</span></span><br><span class="line">    <span class="keyword">var</span> reading = i &lt; streams.<span class="property">length</span> - <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 除了第一个都是可写的流</span></span><br><span class="line">    <span class="keyword">var</span> writing = i &gt; <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">destroyer</span>(stream, reading, writing, <span class="keyword">function</span> (<span class="params">err</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!error) error = err</span><br><span class="line">      <span class="comment">// 如果有一个流出错, 直接销毁所有的流</span></span><br><span class="line">      <span class="keyword">if</span> (err) destroys.<span class="title function_">forEach</span>(call)</span><br><span class="line">      <span class="comment">// 除了最后一个流关闭都不处理</span></span><br><span class="line">      <span class="keyword">if</span> (reading) <span class="keyword">return</span></span><br><span class="line">      <span class="comment">// 如果最后一个流关闭 / 完成了那就关闭所有流</span></span><br><span class="line">      destroys.<span class="title function_">forEach</span>(call)</span><br><span class="line">      <span class="comment">// 并且执行回调函数通知业务层</span></span><br><span class="line">      <span class="title function_">callback</span>(error)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 这里和我们自己写 pipe 的方式一样</span></span><br><span class="line">  <span class="keyword">return</span> streams.<span class="title function_">reduce</span>(pipe)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable language_">module</span>.<span class="property">exports</span> = pump</span><br></pre></td></tr></table></figure><h2 id="node-原生已经支持了-😂"><a href="#node-原生已经支持了-😂" class="headerlink" title="node 原生已经支持了 😂"></a>node 原生已经支持了 😂</h2><p>经过我叮咣一顿乱整, 对于 pump 这个模块算是搞明白了. 然后就看到了<a target="_blank" rel="noopener" href="https://nodejs.org/api/stream.html#stream_stream_pipeline_streams_callback">这个文档</a>, <code>node v10.0.0</code> 新增的 api 已经原生实现了…</p><p>原生 api 使用方法:</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; pipeline &#125; = <span class="built_in">require</span>(<span class="string">&#x27;node:stream&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;node:fs&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> zlib = <span class="built_in">require</span>(<span class="string">&#x27;node:zlib&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Use the pipeline API to easily pipe a series of streams</span></span><br><span class="line"><span class="comment">// together and get notified when the pipeline is fully done.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// A pipeline to gzip a potentially huge tar file efficiently:</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">pipeline</span>(</span><br><span class="line">  fs.<span class="title function_">createReadStream</span>(<span class="string">&#x27;archive.tar&#x27;</span>),</span><br><span class="line">  zlib.<span class="title function_">createGzip</span>(),</span><br><span class="line">  fs.<span class="title function_">createWriteStream</span>(<span class="string">&#x27;archive.tar.gz&#x27;</span>),</span><br><span class="line">  <span class="function">(<span class="params">err</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (err) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;Pipeline failed.&#x27;</span>, err);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Pipeline succeeded.&#x27;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ul><li><a target="_blank" rel="noopener" href="https://github.com/mafintosh/pump">https://github.com/mafintosh/pump</a></li><li><a target="_blank" rel="noopener" href="http://www.npmdoc.org/pumpzhongwenwendangpump-jszhongwenjiaochengjiexi.html">pump中文文档</a></li><li><a target="_blank" rel="noopener" href="https://nodejs.org/api/stream.html#stream_stream_pipeline_streams_callback">stream.pipeline(streams, callback)</a></li><li><a target="_blank" rel="noopener" href="https://nodejs.org/zh-cn/docs/guides/backpressuring-in-streams/">数据流中的积压问题</a></li></ul></div><footer class="post-footer"><div class="post-tags"> <a href="/tags/%E5%BC%80%E5%8F%91%E7%AC%94%E8%AE%B0/" rel="tag"># 开发笔记</a></div><div class="post-nav"><div class="post-nav-item"><a href="/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E5%89%91%E6%8C%87-Offer/%E6%95%B0%E7%BB%84%E5%92%8C%E5%AD%97%E7%AC%A6%E4%B8%B2/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E5%89%91%E6%8C%87%20Offer/%E6%95%B0%E7%BB%84%E5%92%8C%E5%AD%97%E7%AC%A6%E4%B8%B2/53%20-%20I.%20%E5%9C%A8%E6%8E%92%E5%BA%8F%E6%95%B0%E7%BB%84%E4%B8%AD%E6%9F%A5%E6%89%BE%E6%95%B0%E5%AD%97%20I/" rel="prev" title="53 - I. 在排序数组中查找数字 I"><i class="fa fa-chevron-left"></i> 53 - I. 在排序数组中查找数字 I</a></div><div class="post-nav-item"> <a href="/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E5%89%91%E6%8C%87-Offer/%E6%95%B0%E7%BB%84%E5%92%8C%E5%AD%97%E7%AC%A6%E4%B8%B2/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/%E5%89%91%E6%8C%87%20Offer/%E6%95%B0%E7%BB%84%E5%92%8C%E5%AD%97%E7%AC%A6%E4%B8%B2/53%20-%20II.%200%EF%BD%9En-1%E4%B8%AD%E7%BC%BA%E5%A4%B1%E7%9A%84%E6%95%B0%E5%AD%97/" rel="next" title="53 - II. 0～n-1中缺失的数字">53 - II. 0～n-1中缺失的数字<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div><script>
  window.addEventListener('tabs:register', function() {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script></div><div class="toggle sidebar-toggle"><span class="toggle-line toggle-line-first"></span><span class="toggle-line toggle-line-middle"></span><span class="toggle-line toggle-line-last"></span></div><aside class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc"> 文章目录</li><li class="sidebar-nav-overview"> 站点概览</li></ul><div class="post-toc-wrap sidebar-panel"><div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#stream-%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="nav-text">stream 的使用</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8E%9F%E7%94%9F%E7%9A%84%E6%B5%81%E5%A4%84%E7%90%86%E5%AD%98%E5%9C%A8%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-text">原生的流处理存在的问题</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-pump-%E8%A7%84%E8%8C%83%E5%8C%96%E6%B5%81%E7%9A%84%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B"><span class="nav-text">使用 pump 规范化流的处理流程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-text">源码分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#node-%E5%8E%9F%E7%94%9F%E5%B7%B2%E7%BB%8F%E6%94%AF%E6%8C%81%E4%BA%86-%F0%9F%98%82"><span class="nav-text">node 原生已经支持了 😂</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8F%82%E8%80%83%E8%B5%84%E6%96%99"><span class="nav-text">参考资料</span></a></li></ol></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" alt="圈圈的圈" src="/images/avatar.png"><p class="site-author-name" itemprop="name">圈圈的圈</p><div class="site-description" itemprop="description">技术学习, 读书笔记, 生活感悟 ~</div></div><div class="site-state-wrap motion-element"><nav class="site-state"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">142</span> <span class="site-state-item-name">日志</span></a></div><div class="site-state-item site-state-categories"> <a href="/categories/"><span class="site-state-item-count">35</span> <span class="site-state-item-name">分类</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/"><span class="site-state-item-count">8</span> <span class="site-state-item-name">标签</span></a></div></nav></div><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://juejin.im/user/5837c2bd61ff4b006ca8d1b2" title="掘金 → https:&#x2F;&#x2F;juejin.im&#x2F;user&#x2F;5837c2bd61ff4b006ca8d1b2" rel="noopener" target="_blank"><i class="fa fa-fw fa-stack-overflow"></i> 掘金</a></span><span class="links-of-author-item"><a href="https://github.com/luoquanquan" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;luoquanquan" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i> GitHub</a></span><span class="links-of-author-item"><a href="mailto:luo_quanquan@163.com" title="E-Mail → mailto:luo_quanquan@163.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i> E-Mail</a></span></div></div></div></aside><div id="sidebar-dimmer"></div></div></main><footer class="footer"><div class="footer-inner"><div class="beian"><a href="http://www.beian.miit.gov.cn/" rel="noopener" target="_blank">京ICP备17034706号-1</a></div><div class="copyright"> &copy; <span itemprop="copyrightYear">2024</span><span class="with-love"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">圈圈的圈</span></div><div class="busuanzi-count"><script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span class="post-meta-item" id="busuanzi_container_site_uv"><span class="post-meta-item-icon"><i class="fa fa-user"></i></span><span class="site-uv" title="总访客量"><span id="busuanzi_value_site_uv"></span></span></span> <span class="post-meta-divider">|</span><span class="post-meta-item" id="busuanzi_container_site_pv"><span class="post-meta-item-icon"><i class="fa fa-eye"></i></span><span class="site-pv" title="总访问量"><span id="busuanzi_value_site_pv"></span></span></span></div></div></footer></div><script color="0,0,255" opacity="0.5" zindex="-1" count="99" src="/js/theme-next-canvas-nest/canvas-nest.min.js"></script><script src="/lib/anime.min.js"></script><script src="/lib/velocity/velocity.min.js"></script><script src="/lib/velocity/velocity.ui.min.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/pisces.js"></script><script src="/js/next-boot.js"></script><script src="/js/local-search.js"></script></body></html>